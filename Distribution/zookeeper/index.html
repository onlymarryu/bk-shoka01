<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="记录“美食”每刻" href="https://eth168.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="记录“美食”每刻" href="https://eth168.top/atom.xml"><link rel="alternate" type="application/json" title="记录“美食”每刻" href="https://eth168.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="分布式,中间件"><link rel="canonical" href="https://eth168.top/Distribution/zookeeper/"><title>Zookeeper - 分布式 | 雾都博客 = 记录 “美食” 每刻</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Zookeeper</h1><div class="meta"><span class="item" title="创建时间：2022-10-28 20:37:30"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-10-28T20:37:30+08:00">2022-10-28</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>16k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>15 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">雾都博客</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipey0a334j20zk0m8qpt.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipesx5fdwj20zk0m81kx.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclhnx9glj20zk0m8npd.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gicm07ih54j20zk0m84qp.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1giclj61ylzj20zk0m8b29.jpg"></li><li class="item" data-background-image="https://tva2.sinaimg.cn/large/6833939bly1gipey84bjtj20zk0m8hdt.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" itemprop="item" rel="index" title="分类于 分布式"><span itemprop="name">分布式</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://eth168.top/Distribution/zookeeper/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="雾都"><meta itemprop="description" content=", 记录 “美食” 每刻"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="记录 “美食” 每刻"></span><div class="body md" itemprop="articleBody"><h1 id="课程内容的介绍"><a class="anchor" href="#课程内容的介绍">#</a> 课程内容的介绍</h1><ol><li>Zookeeper 的介绍和安装</li><li>Zookeeper 客户端使用</li><li>ZookeeperJavaAPI 使用</li></ol><h1 id="一-zookeeper的介绍和安装"><a class="anchor" href="#一-zookeeper的介绍和安装">#</a> 一、Zookeeper 的介绍和安装</h1><h2 id="1-为什么要使用zookeeper"><a class="anchor" href="#1-为什么要使用zookeeper">#</a> 1. 为什么要使用 Zookeeper</h2><p>​ 我们为了学习 Dubbo，而在 dubbo 中需要一个注册中心，而 Zookeeper 是我们在使用 Dubbo 是官方推荐的注册中心，所以我们先来介绍 Zookeeper</p><img data-src="/Distribution/zookeeper/image-20210226191457919.png" title="image-20210226191457919"> <img data-src="/Distribution/zookeeper/image-20210226191530528.png" title="image-20210226191530528"><h2 id="2-zookeeper介绍"><a class="anchor" href="#2-zookeeper介绍">#</a> 2. Zookeeper 介绍</h2><img data-src="/Distribution/zookeeper/image-20210226192111730.png" title="image-20210226192111730"><h3 id="21-zookeeper概述"><a class="anchor" href="#21-zookeeper概述">#</a> 2.1 Zookeeper 概述</h3><p>ZooKeeper 是一个分布式的，开放源码的分布式应用程序协调服务，是 Google 的 Chubby 一个开源的实现，是 Hadoop 和 Hbase 的重要组件。它是一个为分布式应用提供一致性服务的软件，提供的功能包括：配置维护、域名服务、分布式同步、组服务等。<br>Zookeeper 是一个分布式协调服务；就是为用户的分布式应用程序提供协调服务</p><table><thead><tr><th>序号</th><th>功能</th></tr></thead><tbody><tr><td>1</td><td>为别的分布式程序服务的</td></tr><tr><td>2</td><td>本身就是一个分布式程序</td></tr><tr><td>3</td><td>主从协调 服务器节点动态上下线 统一配置管理 分布式共享锁 统一名称服务</td></tr><tr><td>4</td><td>管理 (存储，读取) 用户程序提交的数据 并为用户程序提供数据节点监听服务</td></tr></tbody></table><h3 id="22-zookeeper的集群机制"><a class="anchor" href="#22-zookeeper的集群机制">#</a> 2.2 Zookeeper 的集群机制</h3><p>Zookeeper 是为其他分布式程序提供服务的，所以本身自己不能随便就挂了，所以 zookeeper 自身的集群机制就很重要。zookeeper 的集群机制采用的是<strong>半数存活机制</strong>，也就是整个集群节点中有半数以上的节点存活，那么整个集群环境可用。这也就是说们的集群节点最好是奇数个节点。</p><p><strong>Zookeeper 集群节点的角色</strong></p><p><strong>Leader</strong></p><p>Leader 服务器是 Zookeeper 集群工作的核心，其主要工作如下</p><ol><li>事务请求的唯一调度和处理者，保证集群事务处理的顺序性。</li><li>集群内部各服务器的调度者</li></ol><p><strong>Follower</strong></p><p>Follower 是 Zookeeper 集群的跟随者，其主要工作如下</p><ol><li>处理客户端非事务性请求（读取数据），转发事务请求给 Leader 服务器。</li><li>参与事务请求 Proposal 的投票。</li><li>参与 Leader 选举投票。</li></ol><p><strong>Observer</strong><br>Observer 充当观察者角色，观察 Zookeeper 集群的最新状态变化并将这些状态同步过来，其对于非事务请求可以进行独立处理，对于事务请求，则会转发给 Leader 服务器进行处理。Observer 不会参与任何形式的投票，包括事务请求 Proposal 的投票和 Leader 选举投票</p><h2 id="3-集群环境准备"><a class="anchor" href="#3-集群环境准备">#</a> 3. 集群环境准备</h2><p>​ 通过上面的介绍我们了解到 zookeeper 的集群环境应该配置奇数个节点，所以我们在本文中搭建的 zookeeper 环境准备在 3 个节点上搭建。接下来我们介绍下需要准备的环境。</p><h3 id="31-准备3个节点"><a class="anchor" href="#31-准备3个节点">#</a> 3.1 准备 3 个节点</h3><p>​ 准备 3 个 centos7.0 的虚拟机节点，并且安装配置好 JDK 版本最好是 8. 不清楚的可参考此地址<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4NTI2NTczL2FydGljbGUvZGV0YWlscy84Njc3NzE2Mw=="> Linux 之 jdk 安装</span>，并配置好相关的网络配置。</p><table><thead><tr><th>ip</th><th>主机名</th></tr></thead><tbody><tr><td>192.168.100.120</td><td>bobo01</td></tr><tr><td>192.168.100.121</td><td>bobo02</td></tr><tr><td>192.168.100.122</td><td>bobo03</td></tr></tbody></table><p>通过 VMware 的克隆或者直接复制文件夹的方式来创建另外两个新的节点</p><h3 id="32-网络配置"><a class="anchor" href="#32-网络配置">#</a> 3.2 网络配置</h3><p>修改 ifcfg-ens33 配置文件</p><img data-src="/Distribution/zookeeper/image-20210228125047032.png" title="image-20210228125047032"><p>重启网络服务</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">service</span> network restart</pre></td></tr></table></figure><p>ping 测试</p><img data-src="/Distribution/zookeeper/image-20210228125219258.png" title="image-20210228125219258"><p>三个节点的网络配置都 ok 的化我们就可以通过 XShell 来连接了</p><h3 id="33-节点的映射关系"><a class="anchor" href="#33-节点的映射关系">#</a> 3.3 节点的映射关系</h3><p>每个节点设置相应的 ip 和主机名的映射关系，方便集群环境的部署</p><p>修改 hosts 配置文件中的信息</p><img data-src="/Distribution/zookeeper/image-20210228130055348.png" title="image-20210228130055348"><h3 id="34-配置免密登录"><a class="anchor" href="#34-配置免密登录">#</a> 3.4 配置免密登录</h3><p>生成公钥和私钥</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>ssh-keygen</pre></td></tr></table></figure><p>输入命令后根据提示，四次回车即可</p><img data-src="/Distribution/zookeeper/image-20210228130543258.png" title="image-20210228130543258"><p>发送公钥给需要免密登录的节点</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>ssh-copy-id bobo01</pre></td></tr><tr><td data-num="2"></td><td><pre>ssh-copy-id bobo02</pre></td></tr><tr><td data-num="3"></td><td><pre>ssh-copy-id bobo03</pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210228130833067.png" title="image-20210228130833067"><p>节点和节点发送文件通过 scp 命令实现</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">scp</span> <span class="token parameter variable">-r</span> b.txt bobo01:/root/</pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210228131239060.png" title="image-20210228131239060"><h3 id="35-关闭防火墙"><a class="anchor" href="#35-关闭防火墙">#</a> 3.5 关闭防火墙</h3><p>查看防火墙状态</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>firewall-cmd <span class="token parameter variable">--state</span></pre></td></tr></table></figure><p>停止防火墙</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemctl stop firewall.service</pre></td></tr></table></figure><p>禁止开机启动</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemctl disable firewall.service</pre></td></tr></table></figure><h2 id="4-zookeeper集群环境搭建"><a class="anchor" href="#4-zookeeper集群环境搭建">#</a> 4. Zookeeper 集群环境搭建</h2><h3 id="41-获取安装文件"><a class="anchor" href="#41-获取安装文件">#</a> 4.1 获取安装文件</h3><p>下载地址:<span class="exturl" data-url="aHR0cHM6Ly9taXJyb3JzLmJmc3UuZWR1LmNuL2FwYWNoZS96b29rZWVwZXIv">https://mirrors.bfsu.edu.cn/apache/zookeeper/</span></p><p>通过 wget 命令将安装文件下载到 opt 目录下</p><p>注意：</p><p>apache-zookeeper-3.5.9-bin.tar.gz 和 apache-zookeeper-3.5.9.tar.gz 的区别 -bin 是编译后的文件 我们用这个</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">wget</span> https://mirrors.bfsu.edu.cn/apache/zookeeper/zookeeper-3.5.9/apache-zookeeper-3.5.9-bin.tar.gz</pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210228135143823.png" title="image-20210228135143823"><p>解压缩文件</p><img data-src="/Distribution/zookeeper/image-20210228135240561.png" title="image-20210228135240561"><p>进入 Zookeeper 目录</p><img data-src="/Distribution/zookeeper/image-20210228135417463.png" title="image-20210228135417463"><h3 id="42-修改配置"><a class="anchor" href="#42-修改配置">#</a> 4.2 修改配置</h3><p>修改 zoo.cfg 文件，系统默认的名称是 zoo_smple.cfg 我们需要重命名为 zoo.cfg</p><img data-src="/Distribution/zookeeper/image-20210228135552375.png" title="image-20210228135552375"><p>修改 cfg 的内容</p><p>修改了两块：</p><p>1 是 Zookeeper 中存储数据的文件夹，还有就是 Zookeeper 集群环境节点信息</p><img data-src="/Distribution/zookeeper/image-20210228135948719.png" title="image-20210228135948719"><p>配置 myid 文件</p><p>​ 我们需要在 Zookeeper 的数据存储的目录中创建一个 myid 文件，文件中的内容只有一行信息，即表示我们集群几点的标识，范围是 1-255，每个节点的 myid 的数字和我们在 zoo.cfg 中配置的 server. 数字是对应的</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token number">1</span></pre></td></tr></table></figure><h3 id="43-分发文件"><a class="anchor" href="#43-分发文件">#</a> 4.3 分发文件</h3><p>​ 当我们配置好了一个 Zookeeper 节点后，我们就可以将 Zookeeper 文件夹分发给其他几个节点了</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">scp</span> <span class="token parameter variable">-r</span> zookeeper bobo02:<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">scp</span> <span class="token parameter variable">-r</span> zookeeper bobo03:<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">pwd</span><span class="token variable">`</span></span></pre></td></tr></table></figure><p>分发成功后我们需要修改各个节点中的 myid 的信息为配置文件中对应的数字</p><h3 id="44-启动测试"><a class="anchor" href="#44-启动测试">#</a> 4.4 启动测试</h3><p>整个集群环境都配置好了之后我们就可以测试启动了</p><p>启动命令</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>./bin/zkServer.sh start</pre></td></tr></table></figure><p>当我们仅仅启动一个节点的时候，因为半数存活机制，3 个节点只启动一个节点是没有效果的，</p><img data-src="/Distribution/zookeeper/image-20210228151546411.png" title="image-20210228151546411"><p>当我们启动第二个节点后发现集群环境可以使用了</p><img data-src="/Distribution/zookeeper/image-20210228151658522.png" title="image-20210228151658522"><p>然后第一个节点的状态也改变了</p><img data-src="/Distribution/zookeeper/image-20210228151723421.png" title="image-20210228151723421"><p>然后再把第三个节点也启动起来</p><img data-src="/Distribution/zookeeper/image-20210228151751891.png" title="image-20210228151751891"><h2 id="5-zookeeper的选举机制"><a class="anchor" href="#5-zookeeper的选举机制">#</a> 5. Zookeeper 的选举机制</h2><p>为什么要进行 Leader 选举？<br>Leader 主要作用是保证分布式数据一致性，即每个节点的存储的数据同步。遇到以下两种情况需要进行 Leader 选举</p><ul><li>服务器初始化启动</li><li>服务器运行期间无法和 Leader 保持连接，Leader 节点崩溃，逻辑时钟崩溃。</li></ul><h3 id="51-服务器初始化时leader选举"><a class="anchor" href="#51-服务器初始化时leader选举">#</a> 5.1 服务器初始化时 Leader 选举</h3><p>Zookeeper 由于其自身的性质，一般建议选取奇数个节点进行搭建分布式服务器集群。以 3 个节点组成的服务器集群为例，说明服务器初始化时的选举过程。启动第一台安装 Zookeeper 的节点时，无法单独进行选举，启动第二台时，两节点之间进行通信，开始选举 Leader。</p><ol><li><p>每个 Server 投出一票。他们两都选自己为 Leader，投票的内容为（SID，ZXID）。<br>SID 即 Server 的 id，安装 zookeeper 时配置文件中所配置的 myid；ZXID，事务 id，<br>为节点的更新程度，ZXID 越大，代表 Server 对 Znode 的操作越新。由于服务器初始化，<br>每个 Sever 上的 Znode 为 0，所以 Server1 投的票为（1,0），Server2 为（2,0）。<br>两 Server 将各自投票发给集群中其他机器。</p></li><li><p>每个 Server 接收来自其他 Server 的投票。集群中的每个 Server 先判断投票有效性，<br>如检查是不是本轮的投票，是不是来 Looking 状态的服务器投的票。</p></li><li><p>对投票结果进行处理。先了解下处理规则</p></li></ol><ul><li><p>首先对比 ZXID。ZXID 大的服务器优先作为 Leader</p></li><li><p>若 ZXID 相同，比如初始化的时候，每个 Server 的 ZXID 都为 0，</p></li><li><p>就会比较 myid，myid 大的选出来做 Leader。</p><p>对于 Server 而言，他接受到的投票为（2,0），因为自身的票为（1,0），所以此时它会选举 Server2 为 Leader，<br>将自己的更新为（2,0）。而 Server2 收到的投票为 Server1 的（1,0）由于比他自己小，<br>Server2 的投票不变。Server1 和 Server2 再次将票投出，投出的票都为（2,0）。</p></li></ul><ol start="4"><li><p>统计投票。每次投票之后，服务器都会统计投票信息，如果判定某个 Server 有过半的票数投它，<br>那么该 Server 将会作为 Leader。对于 Server1 和 Server2 而言，统计出已经有两台机器接收了（2,0）的投票信息，<br>此时认为选出了 Leader。</p></li><li><p>改变服务器状态。当确定了 Leader 之后，每个 Server 更新自己的状态，<br>Leader 将状态更新为 Leading，Follower 将状态更新为 Following。</p></li></ol><img data-src="/Distribution/zookeeper/image-20210301104123274.png" title="image-20210301104123274"><h3 id="52-服务器运行期间的leader选举"><a class="anchor" href="#52-服务器运行期间的leader选举">#</a> 5.2 服务器运行期间的 Leader 选举</h3><p>Zookeeper 运行期间，如果有新的 Server 加入，或者非 Leader 的 Server 宕机，那么 Leader 将会同步数据到新 Server 或者寻找其他备用 Server 替代宕机的 Server。若 Leader 宕机，此时集群暂停对外服务，开始在内部选举新的 Leader。假设当前集群中有 Server1、Server2、Server3 三台服务器，Server2 为当前集群的 Leader，由于意外情况，Server2 宕机了，便开始进入选举状态。过程如下</p><ol><li><p>变更状态。其他的非 Observer 服务器将自己的状态改变为 Looking，开始进入 Leader 选举。</p></li><li><p>每个 Server 发出一个投票（myid，ZXID），由于此集群已经运行过，所以每个 Server 上的 ZXID 可能不同。<br>假设 Server1 的 ZXID 为 145，Server3 的为 122，第一轮投票中，Server1 和 Server3 都投自己，<br>票分别为（1，145）、（3,122）, 将自己的票发送给集群中所有机器。</p></li><li><p>每个 Server 接收接收来自其他 Server 的投票，接下来的步骤与初始化时相同。</p></li></ol><h1 id="二-zookeeper客户端使用"><a class="anchor" href="#二-zookeeper客户端使用">#</a> 二、Zookeeper 客户端使用</h1><h2 id="1-配置zookeeper的环境变量"><a class="anchor" href="#1-配置zookeeper的环境变量">#</a> 1. 配置 Zookeeper 的环境变量</h2><p>​ 为了简化我们每次操作 Zookeeper 而不用进入到 Zookeeper 的安装目录，我们可以将 Zookeeper 的安装信息配置到系统的环境变量中</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">vim</span> /etc/profile</pre></td></tr></table></figure><p>添加的内容</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable">ZOOKEPPER_HOME</span><span class="token operator">=</span>/opt/zookeeper</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$ZOOKEEPER_HOME</span>/bin</pre></td></tr></table></figure><p>执行 source 命令</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token builtin class-name">source</span> /etc/profile</pre></td></tr></table></figure><p>我们就可以在节点的任意位置操作 Zookeeper 了</p><p>通过 scp 命令将 profile 文件发送到其他几个节点上</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">scp</span> /etc/profile bobo02:/etc/</pre></td></tr></table></figure><h2 id="2客户端连接"><a class="anchor" href="#2客户端连接">#</a> 2. 客户端连接</h2><p><span class="exturl" data-url="aHR0cDovL3huLS1iaW56a0NsaS13MzlsdzE0bGxrM2NqYmJ0ODhxZzdhLnNo">通过 bin 目录下的 zkCli.sh</span> 命令连接即可</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>zkCli.sh</pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210301110004402.png" title="image-20210301110004402"><p>zkCli.sh 默认连接的是当前节点的 Zookeeper 节点，如果我们要连接其他节点执行如下命令即可</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre>zkCli.sh <span class="token parameter variable">-timeout</span> <span class="token number">5000</span> <span class="token parameter variable">-server</span> bobo02:2181</pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210301110253746.png" title="image-20210301110253746"><h2 id="3数据操作"><a class="anchor" href="#3数据操作">#</a> 3. 数据操作</h2><h3 id="31-zookeeper的数据结构"><a class="anchor" href="#31-zookeeper的数据结构">#</a> 3.1 Zookeeper 的数据结构</h3><ol><li>层次化的目录结构，命名符合常规文件系统规范</li><li>每个节点在 Zookeeper 中叫做 znode，并且有一个唯一的路径标识</li><li>节点 znode 可以包含数据和子节点（但是 EPHEMERAL 类型的节点不能有子节点）</li><li>客户端应用可以在节点上设置监听器</li></ol><img data-src="/Distribution/zookeeper/image-20210301113558950.png" title="image-20210301113558950"><h3 id="32-节点类型"><a class="anchor" href="#32-节点类型">#</a> 3.2 节点类型</h3><p><strong>1).znode 有两种类型：</strong></p><p>短暂性（ephemeral）（断开连接自己删除）<br>持久性（persistent）（断开连接不删除）</p><p><strong>2).znode 有四种形式的目录节点（默认是 persistent）如下</strong></p><table><thead><tr><th>序号</th><th>节点类型</th><th>描述</th></tr></thead><tbody><tr><td>1</td><td>PERSISTENT</td><td>持久节点</td></tr><tr><td>2</td><td>PERSISTENT_SEQUENTIAL</td><td>持久有序节点</td></tr><tr><td>3</td><td>EPHEMERAL</td><td>短暂节点</td></tr><tr><td>4</td><td>EPHEMERAL_SEQUENTIAL</td><td>短暂有序节点</td></tr></tbody></table><p>​ 创建 znode 时设置顺序标识，znode 名称后会附加一个值，顺序号是一个单调递增的计数器，有父节点维护<br>在分布式系统中，顺序号可以被用于为所有的事件进行全局排序，这样客户端可以通过顺序号推断事件的顺序</p><h3 id="33-常用命令"><a class="anchor" href="#33-常用命令">#</a> 3.3 常用命令</h3><p>​ Zookeeper 作为 Dubbo 的注册中心用来保存我们各个服务的节点信息，显示 Zookeeper 是可以实现输出的存储操作的，我们来看下 Zookeeper 中存储操作的基本命令</p><img data-src="/Distribution/zookeeper/image-20210301115013270.png" title="image-20210301115013270"><p><strong>ls</strong></p><p>​ ls 用来查看某个节点下的子节点信息</p><img data-src="/Distribution/zookeeper/image-20210301114751517.png" title="image-20210301114751517"><p>增强的命令，查看节点下的子节点及当前节点的属性信息 ls2 或者 ls -s 命令</p><img data-src="/Distribution/zookeeper/image-20210301114914215.png" title="image-20210301114914215"><p><strong>create</strong></p><p>​ 创建节点信息</p><img data-src="/Distribution/zookeeper/image-20210301114945149.png" title="image-20210301114945149"><p><strong>get</strong></p><p>​ get 命令用来查看节点的数据</p><img data-src="/Distribution/zookeeper/image-20210301115127622.png" title="image-20210301115127622"><p>如果要查看节点的属性信息那么我们可以通过 get -s 来实现</p><img data-src="/Distribution/zookeeper/image-20210301115623726.png" title="image-20210301115623726"><p><strong>delete</strong></p><p>​ delete 只能删除没有子节点的节点要删除非空节点可以通过 rmr 或者 deleteall 命令实现</p><img data-src="/Distribution/zookeeper/image-20210301115752831.png" title="image-20210301115752831"><p><strong>set</strong></p><p>​ set 命令可以用来修改节点的内容。</p><img data-src="/Distribution/zookeeper/image-20210301115841724.png" title="image-20210301115841724"><h3 id="34-事件监听"><a class="anchor" href="#34-事件监听">#</a> 3.4 事件监听</h3><h4 id="341-数据改变的监听"><a class="anchor" href="#341-数据改变的监听">#</a> 3.4.1 数据改变的监听</h4><p>​ 监听某个节点的数据内容变化，通过 get 命令 带 -w 参数即可，在 3.4 版本的 Zookeeper 中是通过 <code>get path watch</code> 来说实现监控的</p><img data-src="/Distribution/zookeeper/image-20210301135116352.png" title="image-20210301135116352"><p>然后我们在其他节点上修改 app1 节点的数据，会触监听事件</p><img data-src="/Distribution/zookeeper/image-20210301135159833.png" title="image-20210301135159833"> <img data-src="/Distribution/zookeeper/image-20210301135216095.png" title="image-20210301135216095"><p>注意监听一次节点只会触发一次，如果要实现多次监听，那么可以在触发事件的处理函数中再次追加对节点的监听操作</p><h4 id="342-子节点的改变"><a class="anchor" href="#342-子节点的改变">#</a> 3.4.2 子节点的改变</h4><p>​ 监听节点下面的子节点的改变。</p><figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">14</span><span class="token punctuation">]</span> <span class="token function">ls</span> <span class="token parameter variable">-w</span> /app1</pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">]</span></pre></td></tr></table></figure><p>触发</p><img data-src="/Distribution/zookeeper/image-20210301135538966.png" title="image-20210301135538966"> <img data-src="/Distribution/zookeeper/image-20210301135629103.png" title="image-20210301135629103"><h1 id="三-zookeeper-java-api使用"><a class="anchor" href="#三-zookeeper-java-api使用">#</a> 三、Zookeeper Java API 使用</h1><p>​ 介绍如何通过 Java 代码来操作 Zookeeper 中的数据</p><p>在 Zookeeper 的安装目录下是提供的有相关的 Jar 依赖的</p><img data-src="/Distribution/zookeeper/image-20210301141050300.png" title="image-20210301141050300"><p>但是我们对于 Maven 构建项目已经习惯而且是主流，那么我们可以通过 maven 坐标来管理</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>3.5.9<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.github.sgroschupf<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zkclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>0.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h2 id="1连接zk服务"><a class="anchor" href="#1连接zk服务">#</a> 1. 连接 ZK 服务</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">WatchedEvent</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">Watcher</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">ZooKeeper</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test1</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> connectString <span class="token operator">=</span> <span class="token string">"192.168.100.121:2181,192.168.122:2181,192.168.100.122:2181"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeOut <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="15"></td><td><pre>     * 连接 Zookeeper 服务端</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeOut<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>             * 触发监听事件的回调方法</pre></td></tr><tr><td data-num="22"></td><td><pre>             * @param watchedEvent</pre></td></tr><tr><td data-num="23"></td><td><pre>             */</pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"触发了....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--->"</span> <span class="token operator">+</span> zooKeeper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><img data-src="/Distribution/zookeeper/image-20210301141935591.png" title="image-20210301141935591"><h2 id="2-基本操作"><a class="anchor" href="#2-基本操作">#</a> 2 基本操作</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>bobo<span class="token punctuation">.</span>test</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">jdk<span class="token punctuation">.</span>nashorn<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>ir<span class="token punctuation">.</span></span><span class="token class-name">CallNode</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Before</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test1</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> connectString <span class="token operator">=</span> <span class="token string">"192.168.100.121:2181,192.168.122:2181,192.168.100.122:2181"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeOut <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">ZooKeeper</span> zooKeeper <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 连接 Zookeeper 服务端</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@Before</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        zooKeeper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectString<span class="token punctuation">,</span> sessionTimeOut<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="27"></td><td><pre>             * 触发监听事件的回调方法</pre></td></tr><tr><td data-num="28"></td><td><pre>             * @param watchedEvent</pre></td></tr><tr><td data-num="29"></td><td><pre>             */</pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"触发了....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">//System.out.println("--->" + zooKeeper);</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="39"></td><td><pre>     * 创建节点</pre></td></tr><tr><td data-num="40"></td><td><pre>     */</pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token class-name">String</span> path <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">"/apptest"</span> <span class="token comment">// 节点路径</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">,</span><span class="token string">"HelloZookeeper"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 节点的数据</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token punctuation">,</span> <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span> <span class="token comment">// 权限</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">,</span> <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span> <span class="token comment">// 节点类型</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="52"></td><td><pre>     * 判断节点是否存在</pre></td></tr><tr><td data-num="53"></td><td><pre>     */</pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span>  <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token comment">//true 表示的是使用 Zookeeper 中的 watch</span></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/apptest"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>stat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点存在"</span><span class="token operator">+</span> stat<span class="token punctuation">.</span><span class="token function">getNumChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"节点不存在 ...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre></pre></td></tr><tr><td data-num="65"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="66"></td><td><pre>     * 获取某个节点下面的所有的子节点</pre></td></tr><tr><td data-num="67"></td><td><pre>     */</pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="69"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getChildrens</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> childrens <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/app1"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> children <span class="token operator">:</span> childrens<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token comment">// System.out.println(children);</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token comment">// 获取子节点中的数据</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/app1/"</span> <span class="token operator">+</span> children<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>children<span class="token operator">+</span><span class="token string">":"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="80"></td><td><pre>     * 修改节点的内容</pre></td></tr><tr><td data-num="81"></td><td><pre>     */</pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token comment">//-1 不指定版本 自动维护</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/app1/a1"</span><span class="token punctuation">,</span> <span class="token string">"666666"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="91"></td><td><pre>     * 删除节点</pre></td></tr><tr><td data-num="92"></td><td><pre>     */</pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="94"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        zooKeeper<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/app1"</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>        </pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre></pre></td></tr><tr><td data-num="100"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="3-事件监听处理"><a class="anchor" href="#3-事件监听处理">#</a> 3 事件监听处理</h2><p>​ Java 程序如何监听 Zookeeper 中的数据的变化？</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     * 监听 Node 节点下的子节点的变化</pre></td></tr><tr><td data-num="3"></td><td><pre>     */</pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nodeChildrenChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/app1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">/**</span></pre></td></tr><tr><td data-num="9"></td><td><pre>             *              None(-1),</pre></td></tr><tr><td data-num="10"></td><td><pre>             *             NodeCreated(1),</pre></td></tr><tr><td data-num="11"></td><td><pre>             *             NodeDeleted(2),</pre></td></tr><tr><td data-num="12"></td><td><pre>             *             NodeDataChanged(3),</pre></td></tr><tr><td data-num="13"></td><td><pre>             *             NodeChildrenChanged(4),</pre></td></tr><tr><td data-num="14"></td><td><pre>             *             DataWatchRemoved(5),</pre></td></tr><tr><td data-num="15"></td><td><pre>             *             ChildWatchRemoved(6);</pre></td></tr><tr><td data-num="16"></td><td><pre>             * @param watchedEvent</pre></td></tr><tr><td data-num="17"></td><td><pre>             */</pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--->"</span><span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> s <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     * 监听节点内容变更</pre></td></tr><tr><td data-num="32"></td><td><pre>     */</pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nodeDataChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeper<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/app1/a1"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--->"</span> <span class="token operator">+</span> watchedEvent<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--->"</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="四-zookeeper实现分布式锁"><a class="anchor" href="#四-zookeeper实现分布式锁">#</a> 四、Zookeeper 实现分布式锁</h1><h2 id="分布式锁"><a class="anchor" href="#分布式锁">#</a> 分布式锁</h2><p>排他锁、共享锁</p><h3 id="排他锁"><a class="anchor" href="#排他锁">#</a> 排他锁</h3><p>排他锁（Exclusive Locks），又被称为写锁或独占锁，如果事务 T1 对数据对象 O1 加上排他锁，那么整个加锁期间，只允许事务 T1 对 O1 进行读取和更新操作，其他任何事务都不能进行读或写。</p><p>实现方式在下面的 <code>Zookeeper</code> 实现分布式锁中有具体讲解， <code>Zookeeper</code> 实现分布式锁就是一个排它锁</p><h3 id="共享锁"><a class="anchor" href="#共享锁">#</a> 共享锁</h3><p>共享锁（Shared Locks），又称读锁。如果事务 T1 对数据对象 O1 加上了共享锁，那么当前事务只能对 O1 进行读取操作，其他事务也只能对这个数据对象加共享锁，直到该数据对象上的所有共享锁都释放。</p><p><strong>实现方式：</strong></p><p>1、客户端调用 create 方法创建类似定义锁方式的临时顺序节点。</p><img data-src="/Distribution/zookeeper/lock-01.png" title="img"><p>2、客户端调用 getChildren 接口来获取所有已创建的子节点列表。</p><p>3、判断是否获得锁</p><ul><li>对于读请求：如果所有比自己小的子节点都是读请求或者没有比自己序号小的子节点，表明已经成功获取共享锁，同时开始执行度逻辑。</li><li>对于写请求：如果自己不是序号最小的子节点，那么就进入等待。</li></ul><p>4、如果没有获取到共享锁，读请求向比自己序号小的最后一个写请求节点注册 watcher 监听，写请求向比自己序号小的最后一个节点注册 watcher 监听。</p><h3 id="概念总结"><a class="anchor" href="#概念总结">#</a> 概念总结</h3><ul><li><p>对于排他锁而言</p><p>只监听自己前面的人，前面没人才能拿到锁资源</p></li><li><p>对于共享锁 (读写锁)</p><ol><li><p>序号越大越可能是读锁</p></li><li><p>写锁的序号最小</p></li></ol></li></ul><h3 id="操作事例"><a class="anchor" href="#操作事例">#</a> 操作事例</h3><p><strong>实际开发过程中，可以 curator 工具包封装的 API 帮助我们实现分布式锁。</strong></p><p>curator 的几种锁方案 ：</p><ul><li>1、<strong>InterProcessMutex</strong>：分布式可重入排它锁</li><li>2、<strong>InterProcessSemaphoreMutex</strong>：分布式排它锁</li><li>3、<strong>InterProcessReadWriteLock</strong>：分布式读写锁</li></ul><p>引入依赖：</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- curator-framework 自带 Zookeeper --></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">&lt;!-- curator-recipes --></span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">></span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>curator-framework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><p>测试用例：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessMutex</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessReadWriteLock</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessSemaphoreMutex</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">ExponentialBackoffRetry</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InterprocessLock</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">CuratorFramework</span> zkClient <span class="token operator">=</span> <span class="token function">getZkClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">String</span> lockPath <span class="token operator">=</span> <span class="token string">"/lock"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">InterProcessMutex</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">,</span> lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">InterProcessSemaphoreMutex</span> lock1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessSemaphoreMutex</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">,</span> lockPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">InterProcessMutex</span> read  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessReadWriteLock</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">,</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">InterProcessMutex</span> write <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InterProcessReadWriteLock</span><span class="token punctuation">(</span>zkClient<span class="token punctuation">,</span>lockPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// 模拟线程抢锁</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// 分布式可重入排它锁</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// new Thread(new TestThread(i, lock)).start();</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 分布式排它锁</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TestInterProcessSemaphoreMutex</span><span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> lock1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// 模拟线程抢锁</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 读书数量为 i , 写锁数量为 j</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">,</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">&lt;</span><span class="token number">3</span> <span class="token operator">||</span> i <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">,</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token comment">// if (j&lt;3) new Thread(new TestThreadSharedLockOnWriter(i + 1, write)).start();</span></pre></td></tr><tr><td data-num="29"></td><td><pre>           <span class="token comment">// new Thread( new TestThreadSharedLockOnRead(i + 1, read)).start();</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// new Thread(new TestThreadSharedLockOnWriter(i + 1, write)).start();</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestInterProcessMutex</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">Integer</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">InterProcessMutex</span> lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">InterProcessSemaphoreMutex</span> lock1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token function">testInterProcessMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestInterProcessMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestInterProcessMutex</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> threadFlag<span class="token punctuation">,</span> <span class="token class-name">InterProcessMutex</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>threadFlag <span class="token operator">=</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestInterProcessMutex</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> threadFlag<span class="token punctuation">,</span> <span class="token class-name">InterProcessSemaphoreMutex</span> lock1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>threadFlag <span class="token operator">=</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock1 <span class="token operator">=</span> lock1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testInterProcessMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token operator">+</span>threadFlag<span class="token operator">+</span><span class="token string">"线程获取到了锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token comment">// 等到 1 秒后释放锁</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestInterProcessSemaphoreMutex</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">Integer</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">InterProcessSemaphoreMutex</span> lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>            <span class="token function">testInterProcessSemaphoreMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestInterProcessSemaphoreMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="90"></td><td><pre></pre></td></tr><tr><td data-num="91"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestInterProcessSemaphoreMutex</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> threadFlag<span class="token punctuation">,</span> <span class="token class-name">InterProcessSemaphoreMutex</span> lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>threadFlag <span class="token operator">=</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testInterProcessSemaphoreMutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>                lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="98"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"第"</span><span class="token operator">+</span>threadFlag<span class="token operator">+</span><span class="token string">"线程获取到了锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>                <span class="token comment">// 等到 1 秒后释放锁</span></pre></td></tr><tr><td data-num="100"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="103"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>                    lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="106"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="108"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre></pre></td></tr><tr><td data-num="112"></td><td><pre></pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestThreadSharedLockOnRead</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">Integer</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">InterProcessMutex</span> lock2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="117"></td><td><pre></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestThreadSharedLockOnRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre></pre></td></tr><tr><td data-num="121"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestThreadSharedLockOnRead</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> threadFlag<span class="token punctuation">,</span> <span class="token class-name">InterProcessMutex</span> lock2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="122"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>threadFlag <span class="token operator">=</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock2 <span class="token operator">=</span> lock2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="125"></td><td><pre></pre></td></tr><tr><td data-num="126"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testInterProcessReadWriteLockOnRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>                lock2<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"读锁----第"</span><span class="token operator">+</span>threadFlag<span class="token operator">+</span><span class="token string">"线程获取到了锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>                <span class="token comment">// 等到 1 秒后释放锁</span></pre></td></tr><tr><td data-num="131"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="135"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="136"></td><td><pre>                    lock2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="137"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="138"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="142"></td><td><pre></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="144"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="145"></td><td><pre>            <span class="token function">testInterProcessReadWriteLockOnRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">TestThreadSharedLockOnWriter</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">Integer</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">private</span> <span class="token class-name">InterProcessMutex</span> lock2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre></pre></td></tr><tr><td data-num="152"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestThreadSharedLockOnWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="153"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="154"></td><td><pre></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">TestThreadSharedLockOnWriter</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> threadFlag<span class="token punctuation">,</span> <span class="token class-name">InterProcessMutex</span> lock2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="156"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>threadFlag <span class="token operator">=</span> threadFlag<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="157"></td><td><pre>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock2 <span class="token operator">=</span> lock2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="159"></td><td><pre></pre></td></tr><tr><td data-num="160"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">testInterProcessReadWriteLockOnWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="162"></td><td><pre>                lock2<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="163"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"写锁----第"</span><span class="token operator">+</span>threadFlag<span class="token operator">+</span><span class="token string">"线程获取到了锁"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>                <span class="token comment">// 等到 1 秒后释放锁</span></pre></td></tr><tr><td data-num="165"></td><td><pre>                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="166"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="169"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>                    lock2<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="172"></td><td><pre>                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="173"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="174"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="175"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="176"></td><td><pre></pre></td></tr><tr><td data-num="177"></td><td><pre>        <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="178"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="179"></td><td><pre>            <span class="token function">testInterProcessReadWriteLockOnWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="180"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="181"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="182"></td><td><pre></pre></td></tr><tr><td data-num="183"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="184"></td><td><pre>     * 建立连接</pre></td></tr><tr><td data-num="185"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="186"></td><td><pre>     */</pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">CuratorFramework</span> <span class="token function">getZkClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        <span class="token class-name">String</span> zkServerAddress <span class="token operator">=</span> <span class="token string">"39.103.208.148:2181"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="189"></td><td><pre>        <span class="token class-name">ExponentialBackoffRetry</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="190"></td><td><pre>        <span class="token class-name">CuratorFramework</span> zkClient <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="191"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">connectString</span><span class="token punctuation">(</span>zkServerAddress<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="192"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">sessionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="193"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">connectionTimeoutMs</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="194"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">retryPolicy</span><span class="token punctuation">(</span>retryPolicy<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="195"></td><td><pre>                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        zkClient<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="197"></td><td><pre>        <span class="token keyword">return</span> zkClient<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="199"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="介绍"><a class="anchor" href="#介绍">#</a> 介绍</h2><p>​ <code>[Zookeeper</code> 能实现分布式锁，是因为它有一个特性，就是<mark>多个线程去 Zookeeper 里面去创建同一个节点的时候，只会有一个线程执行成功</mark>。（<strong>默认公平锁，也叫排它锁</strong>）</p><p><strong>锁可理解为 ZooKeeper 上的一个节点</strong></p><ul><li>当需要获取锁时，就在这个锁节点下创建一个临时顺序节点。当存在多个客户端同时来获取锁，就按顺序依次创建多个临时顺序节点，但只有排列序号是第一的那个节点能获取锁成功，其他节点则按顺序分别监听前一个节点的变化，当被监听者释放锁时，监听者就可以马上获得锁。</li><li>当释放锁时，只需要将会话关闭，临时节点就删除了，即释放了锁。如果万一客户端获取到锁之后突然挂掉（Session 连接断开），那么这个临时节点也会自动删除掉。</li></ul><h2 id="具体实现"><a class="anchor" href="#具体实现">#</a> 具体实现</h2><p>实现有两种方案：</p><ul><li>基于临时节点实现，会产生羊群效应，<strong>不推荐</strong>。</li><li>基于临时顺序节点实现。<strong>推荐</strong></li></ul><p>一般我们认为，<font color="red">ZooKeeper 的分布式锁是基于临时顺序节点，然后通过监听机制来实现的</font>。即方案 2。</p><p>基于临时节点实现:</p><p>1、实现思路</p><div style="align-items:Center;justify-content:center"><img data-src="zookeeper/4dafb20334a545b39c52b1fc64eb46e1.png"></div><p><strong>锁节点</strong>：即锁对象</p><p><strong>获取锁</strong>：锁请求者加锁，则创建锁节点。</p><ul><li>如果创建成功，那么加锁成功，</li><li>如果创建失败，那么加锁失败，则等待获取锁（等待获取锁成功的客户端释放锁）。注意：这里锁请求者监听的都是 锁节点的删除操作。</li></ul><p><strong>释放锁</strong>：只需要将会话关闭，临时节点就删除了，即释放了锁。</p><p><strong>羊群效应</strong>：如果所有的锁请求者都来监听锁持有者，当锁持有者的节点被删除以后，所有的锁请求者都会通知到，即都会同时去竞争锁，但是只有一个锁请求者能拿到锁。这就是羊群效应 (<strong>非公平锁</strong>)。</p><h2 id="代码实现"><a class="anchor" href="#代码实现">#</a> 代码实现</h2><p>参考分布式锁中的代码实现</p><ul><li>Zookeeper 中多用 <strong>InterProcessMutex</strong>（分布式可重入排它锁）</li></ul><h2 id="参考"><a class="anchor" href="#参考">#</a> 参考</h2><p>菜鸟教程：<span class="exturl" data-url="aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL3pvb2tlZXBlci1sb2Nrcy5odG1s">https://www.runoob.com/w3cnote/zookeeper-locks.html</span></p><p>Charge8：<span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQyNDAyODU0L2FydGljbGUvZGV0YWlscy8xMjQ5MzY4OTU=">https://blog.csdn.net/qq_42402854/article/details/124936895</span></p><div id="gitalk-container"></div><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalkConfig={clientID:"6db178ba46c8af8f6a6f",clientSecret:"90f730e5956024596558df00975cd8eae28cae3d",repo:"bk-comment01",owner:"onlymarryu",admin:["onlymarryu"],distractionFreeMode:!1,language:"zh-CN",proxy:"https://gitalk-comments.netlify.app/github_access_token",perPage:15};gitalkConfig.id=md5(location.pathname);var gitalk=new Gitalk(gitalkConfig);gitalk.render("gitalk-container")</script><div class="tags"><a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag"><i class="ic i-tag"></i> 分布式</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag"><i class="ic i-tag"></i> 中间件</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-10-28 22:02:19" itemprop="dateModified" datetime="2022-10-28T22:02:19+08:00">2022-10-28</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="雾都 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="雾都 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="雾都 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>雾都 <i class="ic i-at"><em>@</em></i>记录 “美食” 每刻</li><li class="link"><strong>本文链接：</strong> <a href="https://eth168.top/Distribution/zookeeper/" title="Zookeeper">https://eth168.top/Distribution/zookeeper/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/tools/tools-All/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicm07ih54j20zk0m84qp.jpg" title="所有工具安装合集"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 工具软件安装</span><h3>所有工具安装合集</h3></a></div><div class="item right"><a href="/toolsPage/%E5%B8%B8%E7%94%A8Typeroa%E6%A0%BC%E5%BC%8F/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva2.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipey84bjtj20zk0m8hdt.jpg" title="常用Typeroa格式"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i></span><h3>常用Typeroa格式</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%BE%E7%A8%8B%E5%86%85%E5%AE%B9%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">课程内容的介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80-zookeeper%E7%9A%84%E4%BB%8B%E7%BB%8D%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">2.</span> <span class="toc-text">一、Zookeeper 的介绍和安装</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E4%BD%BF%E7%94%A8zookeeper"><span class="toc-number">2.1.</span> <span class="toc-text">1. 为什么要使用 Zookeeper</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-zookeeper%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.2.</span> <span class="toc-text">2. Zookeeper 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-zookeeper%E6%A6%82%E8%BF%B0"><span class="toc-number">2.2.1.</span> <span class="toc-text">2.1 Zookeeper 概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#22-zookeeper%E7%9A%84%E9%9B%86%E7%BE%A4%E6%9C%BA%E5%88%B6"><span class="toc-number">2.2.2.</span> <span class="toc-text">2.2 Zookeeper 的集群机制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.3.</span> <span class="toc-text">3. 集群环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-%E5%87%86%E5%A4%873%E4%B8%AA%E8%8A%82%E7%82%B9"><span class="toc-number">2.3.1.</span> <span class="toc-text">3.1 准备 3 个节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.3.2.</span> <span class="toc-text">3.2 网络配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E8%8A%82%E7%82%B9%E7%9A%84%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.3.3.</span> <span class="toc-text">3.3 节点的映射关系</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95"><span class="toc-number">2.3.4.</span> <span class="toc-text">3.4 配置免密登录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#35-%E5%85%B3%E9%97%AD%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">2.3.5.</span> <span class="toc-text">3.5 关闭防火墙</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-zookeeper%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.4.</span> <span class="toc-text">4. Zookeeper 集群环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#41-%E8%8E%B7%E5%8F%96%E5%AE%89%E8%A3%85%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.1.</span> <span class="toc-text">4.1 获取安装文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#42-%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"><span class="toc-number">2.4.2.</span> <span class="toc-text">4.2 修改配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#43-%E5%88%86%E5%8F%91%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.</span> <span class="toc-text">4.3 分发文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#44-%E5%90%AF%E5%8A%A8%E6%B5%8B%E8%AF%95"><span class="toc-number">2.4.4.</span> <span class="toc-text">4.4 启动测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-zookeeper%E7%9A%84%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6"><span class="toc-number">2.5.</span> <span class="toc-text">5. Zookeeper 的选举机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#51-%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%9D%E5%A7%8B%E5%8C%96%E6%97%B6leader%E9%80%89%E4%B8%BE"><span class="toc-number">2.5.1.</span> <span class="toc-text">5.1 服务器初始化时 Leader 选举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#52-%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E8%A1%8C%E6%9C%9F%E9%97%B4%E7%9A%84leader%E9%80%89%E4%B8%BE"><span class="toc-number">2.5.2.</span> <span class="toc-text">5.2 服务器运行期间的 Leader 选举</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C-zookeeper%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">二、Zookeeper 客户端使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E9%85%8D%E7%BD%AEzookeeper%E7%9A%84%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">3.1.</span> <span class="toc-text">1. 配置 Zookeeper 的环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.2.</span> <span class="toc-text">2. 客户端连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">3. 数据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#31-zookeeper%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">3.3.1.</span> <span class="toc-text">3.1 Zookeeper 的数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#32-%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B"><span class="toc-number">3.3.2.</span> <span class="toc-text">3.2 节点类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#33-%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.3.</span> <span class="toc-text">3.3 常用命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#34-%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC"><span class="toc-number">3.3.4.</span> <span class="toc-text">3.4 事件监听</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#341-%E6%95%B0%E6%8D%AE%E6%94%B9%E5%8F%98%E7%9A%84%E7%9B%91%E5%90%AC"><span class="toc-number">3.3.4.1.</span> <span class="toc-text">3.4.1 数据改变的监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#342-%E5%AD%90%E8%8A%82%E7%82%B9%E7%9A%84%E6%94%B9%E5%8F%98"><span class="toc-number">3.3.4.2.</span> <span class="toc-text">3.4.2 子节点的改变</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89-zookeeper-java-api%E4%BD%BF%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">三、Zookeeper Java API 使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E8%BF%9E%E6%8E%A5zk%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.1.</span> <span class="toc-text">1. 连接 ZK 服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">4.2.</span> <span class="toc-text">2 基本操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E4%BA%8B%E4%BB%B6%E7%9B%91%E5%90%AC%E5%A4%84%E7%90%86"><span class="toc-number">4.3.</span> <span class="toc-text">3 事件监听处理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B-zookeeper%E5%AE%9E%E7%8E%B0%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">5.</span> <span class="toc-text">四、Zookeeper 实现分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="toc-number">5.1.</span> <span class="toc-text">分布式锁</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E4%BB%96%E9%94%81"><span class="toc-number">5.1.1.</span> <span class="toc-text">排他锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B1%E4%BA%AB%E9%94%81"><span class="toc-number">5.1.2.</span> <span class="toc-text">共享锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%E6%80%BB%E7%BB%93"><span class="toc-number">5.1.3.</span> <span class="toc-text">概念总结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C%E4%BA%8B%E4%BE%8B"><span class="toc-number">5.1.4.</span> <span class="toc-text">操作事例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">5.2.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.</span> <span class="toc-text">具体实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.4.</span> <span class="toc-text">代码实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.5.</span> <span class="toc-text">参考</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Distribution/FastDFS/" rel="bookmark" title="FastDFS">FastDFS</a></li><li><a href="/Distribution/Dubbo/" rel="bookmark" title="Dubbo">Dubbo</a></li><li><a href="/Distribution/RPC/" rel="bookmark" title="RPC">RPC</a></li><li><a href="/Distribution/RabbitMQ/" rel="bookmark" title="RabbitMQ">RabbitMQ</a></li><li><a href="/Distribution/Solr/" rel="bookmark" title="Solr">Solr</a></li><li class="active"><a href="/Distribution/zookeeper/" rel="bookmark" title="Zookeeper">Zookeeper</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="雾都" data-src="/images/avatar.jpg"><p class="name" itemprop="name">雾都</p><div class="description" itemprop="description">记录 “美食” 每刻</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">62</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">11</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">21</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29ubHltYXJyeXU=" title="https:&#x2F;&#x2F;github.com&#x2F;onlymarryu"><i class="ic i-github"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvbXkvbS9tdXNpYy9wbGF5bGlzdD9pZD0zMTY2MDYwNzkw" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;my&#x2F;m&#x2F;music&#x2F;playlist?id&#x3D;3166060790"><i class="ic i-cloud-music"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>时间轴</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/toolPage/" rel="section"><i class="ic i-feather"></i>MarkDown常用操作</a></li></ul></li><li class="item"><a href="/mianshi/" rel="section"><i class="ic i-calendar"></i>面试</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-calendar"></i>留言</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/tools/tools-All/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/toolsPage/%E5%B8%B8%E7%94%A8Typeroa%E6%A0%BC%E5%BC%8F/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a></div><span><a href="/Distribution/Dubbo/" title="Dubbo">Dubbo</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/SpringMVC/" title="SpringMVC">SpringMVC</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/Spring/" title="Spring">Spring</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/docker-tool/" title="docker安装">docker安装</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/ORM/" title="分类于 ORM">ORM</a></div><span><a href="/ORM/Mybatis/" title="Mybatis">Mybatis</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/SpringSecurity/" title="SpringSecurity">SpringSecurity</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaSE/" title="分类于 JavaSE">JavaSE</a></div><span><a href="/Java/%E7%AC%AC1%E7%AB%A0%E5%88%9D%E8%AF%86JAVA/" title="第1章初识JAVA">第1章初识JAVA</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" title="分类于 数据库">数据库</a> <i class="ic i-angle-right"></i> <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/" title="分类于 MySQL">MySQL</a></div><span><a href="/DataBase/MySQL/MySQL_Basic/" title="MySQL基础">MySQL基础</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/XShell-tool/" title="XShell">XShell</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/SpringBoot/" title="SpringBoot">SpringBoot</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">雾都 @ 雾都博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">805k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">12:12</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Distribution/zookeeper/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>