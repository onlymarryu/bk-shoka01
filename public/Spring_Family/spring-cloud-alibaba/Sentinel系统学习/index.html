<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="每天进步一点点，就是成功的开始" href="https://eth168.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="每天进步一点点，就是成功的开始" href="https://eth168.top/atom.xml"><link rel="alternate" type="application/json" title="每天进步一点点，就是成功的开始" href="https://eth168.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="spring-cloud-alibaba,sentinel"><link rel="canonical" href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"><title>Sentinel 系统学习 - 微服务 | 雾都博客 = 每天进步一点点，就是成功的开始</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Sentinel 系统学习</h1><div class="meta"><span class="item" title="创建时间：2023-07-10 21:52:02"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-07-10T21:52:02+08:00">2023-07-10</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>43k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>39 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">雾都博客</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://api.yimian.xyz/img?807594"></li><li class="item" data-background-image="https://api.yimian.xyz/img?912089"></li><li class="item" data-background-image="https://api.yimian.xyz/img?743683"></li><li class="item" data-background-image="https://api.yimian.xyz/img?629455"></li><li class="item" data-background-image="https://api.yimian.xyz/img?252863"></li><li class="item" data-background-image="https://api.yimian.xyz/img?594222"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="item" rel="index" title="分类于 微服务"><span itemprop="name">微服务</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="雾都"><meta itemprop="description" content=", 花非花，雾非雾"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="每天进步一点点，就是成功的开始"></span><div class="body md" itemprop="articleBody"><h1 id="sentinel介绍"><a class="anchor" href="#sentinel介绍">#</a> Sentinel 介绍</h1><h2 id="什么是sentinel"><a class="anchor" href="#什么是sentinel">#</a> 什么是 Sentinel</h2><ol><li><p><strong>分布式系统的流量防卫兵</strong>：随着微服务的普及，服务调用的稳定性变得越来越重要。<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvU2VudGluZWw=">Sentinel</span> 以 “流量” 为切入点，在流量控制、断路、负载保护等多个领域开展工作，保障服务可靠性。</p></li><li><p>特点：<br>1.<br>2. <strong>+ 丰富的应用场景</strong>：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。<br>3. <strong>完备的实时监控</strong>：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。<br>4. <strong>广泛的开源生态</strong>：Sentinel 提供开箱即用的与其它开源框架 / 库的整合模块，例如与 Spring Cloud、Apache Dubbo、gRPC、Quarkus 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。同时 Sentinel 提供 Java/Go/C++ 等多语言的原生实现。<br>5. <strong>完善的 SPI 扩展机制</strong>：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</p></li><li><p>官网文档：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvU2VudGluZWwvd2lraS8lRTQlQkIlOEIlRTclQkIlOEQ=">https://github.com/alibaba/Sentinel/wiki/ 介绍</span></p></li></ol><h2 id="sentinel好处"><a class="anchor" href="#sentinel好处">#</a> Sentinel 好处</h2><p>​	分布式系统面临的问题：复杂的体系结构中的应用程序有数十个依赖关系，每个依赖关系在某些时候将不可避免的失败，比如如下的例子中，当我们调用 A、E、F、J、K 这几个服务的时候如果其中一个服务出现问题会造成什么问题？其实就会出现整体系统效率全部下降，而且严重就会出现<strong>服务雪崩</strong>的问题！</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005013321645.png" title="image-20211005013321645"><p>​	<strong>服务雪崩：</strong></p><p>​ 多个微服务之间调用的时候，假设 A 调用 B 和 C，B 和 C 又调用其他的微服务，这就是所谓的<strong>扇出</strong>。如果扇出的某个链路上某个微服务调用的响应时间过程或者不可用，微服务 A 的调用就用占用越来越多的系统资源，从而引起系统崩溃，这也就是<strong>服务雪崩</strong>。其实就是服务的<strong>高可用</strong>遭到了破坏。</p><p>​ 对于高流量的应用来说，单一的后端依赖可能会导致服务器上的所有资源都在几秒钟内饱和。同时还有可能造成这些应用程序导致服务之间的延迟增加，备份列队，线程和其他的系统资源紧张，导致整个系统发生更多的级联故障。这些都表示需要对故障和延迟进行隔离和管理，以便单个依赖关系失败，不能取消整个应用程序或系统，所以通常发生了一个模块的某个实例失败后，这时候这个模块依然还会接受流量，然后这个有问题的模块还调用其他的模块，这样就会发生级联故障，或者叫做<strong>雪崩</strong>。</p><p>​ 要解决这种问题的出现我们就需要用到服务降级，而 Sentinel 就可以保证在一个依赖出现问题的情况下，不会导致整体服务失败，避免级联故障，提高分布式系统的弹性。</p><p>​	<strong>Sentinel 的熔断降级通过断路器实现：</strong></p><p>​ 断路器：它本身是一种开关装置，当某个服务单元发生故障之后，通过断路器的故障监控（类似于熔断保险丝），向调用方返回一个符合预期的、可处理的备选响应（FallBack），而不是长时间的等待或者抛出调用方法无法出的异常，这样就保证了服务调用方的不会被长时间、不必要的占用，从而避免了故障在分布式系统中蔓延（类似于病毒传染），从而避免了故障在系统中蔓延，乃至崩溃。</p><p>​	<strong>好处体现：</strong></p><p>​	对比与其他的产品而言，比如说 Hystrix，他不需要我们自己手动搭建监控平台，而且它有一套类似于 Nacos 的 Web 界面，可以让我们进行更加细粒度的配置流控、速率、服务熔断、服务降级等</p><p>​	目前主流编程都是 约定 &gt; 配置 &gt; 代码，虽然我们的配置都可以写在代码中，但是我们还是要大面积的学习配置和注解的方式，尽量少些代码，这也是 Sentinel 的理念和初衷。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005004311575.png" title="image-20211005004311575"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005004335733.png" title="image-20211005004335733"><h2 id="sentinel下载和安装"><a class="anchor" href="#sentinel下载和安装">#</a> Sentinel 下载和安装</h2><p>​	下载地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvU2VudGluZWwvcmVsZWFzZXM=">https://github.com/alibaba/Sentinel/releases</span></p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005005114846.png" title="image-20211005005114846"><p>官方提供的手册：<span class="exturl" data-url="aHR0cHM6Ly9zcHJpbmctY2xvdWQtYWxpYmFiYS1ncm91cC5naXRodWIuaW8vZ2l0aHViLXBhZ2VzL2hveHRvbi9lbi11cy9pbmRleC5odG1sI19zcHJpbmdfY2xvdWRfYWxpYmFiYV9zZW50aW5lbA==">https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/en-us/index.html#_spring_cloud_alibaba_sentinel</span></p><p><strong>Sentinel 分为两个部分</strong></p><ul><li>核心库（Java 客户端）不依赖任何框架 / 库，只需要 Java 运行时环境，同时对 Dubbo/SpringCloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 SpringBoot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><p><strong>启动步骤</strong></p><ul><li><p>前提：jdk1.8 环境和 8080 端口不能被占用</p></li><li><p>启动命令：java -jar sentinel-dashboard-1.8.2.jar</p></li><li><p>访问地址：localhost:8080</p></li><li><p>输入默认账号密码：sentinel/sentinel</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005010854771.png" title="image-20211005010854771"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005010930366.png" title="image-20211005010930366"></li></ul><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211005011050291.png" title="image-20211005011050291"><p>到这里为止，我们的 Sentinel 安装成功。</p><h1 id="sentinel初始化监控"><a class="anchor" href="#sentinel初始化监控">#</a> Sentinel 初始化监控</h1><h2 id="sentinel初始化工程演示"><a class="anchor" href="#sentinel初始化工程演示">#</a> Sentinel 初始化工程演示</h2><p>​	我们现在通过一个案例来让大家了解 Sentinel 的初始化演示，现在我们需要做几件事：</p><ol><li>启动 Nacos8848 成功</li><li>创建新的 Module：cloudalibaba-sentinel-service8401</li><li>启动 Sentinel8080</li><li>启动微服务 8401</li><li>启动 8401 微服务后查看 Sentinel 控制台</li></ol><h2 id="搭建sentinel项目"><a class="anchor" href="#搭建sentinel项目">#</a> 搭建 Sentinel 项目</h2><ol><li>Sentinel 的官方文档网址：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvcXVpY2stc3RhcnQuaHRtbA==">https://sentinelguard.io/zh-cn/docs/quick-start.html</span></li><li>创建项目 cloudalibaba-sentinel-service8401</li><li>导入依赖：</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token class-name">Nacos</span>客户端依赖 <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> sentinel依赖 <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>sentinel<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr></table></figure><ol start="4"><li>配置 yaml 文件，目的是让当前 8401 注册进 Nacos，然后被 Sentinel8080 进行监控</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8401</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    name<span class="token operator">:</span> cloudalibaba<span class="token operator">-</span>sentinel<span class="token operator">-</span>service</pre></td></tr><tr><td data-num="7"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    sentinel<span class="token operator">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      transport<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        # 配置<span class="token class-name">Sentinel</span> dashboard地址</pre></td></tr><tr><td data-num="14"></td><td><pre>        dashboard<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8080</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        # 默认<span class="token number">8719</span>端口，键入被占用会自动从<span class="token number">8719</span><span class="token operator">+</span><span class="token number">1</span>，直到找到未被占用的端口</pre></td></tr><tr><td data-num="16"></td><td><pre>        port<span class="token operator">:</span> <span class="token number">8719</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>management<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  endpoints<span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    web<span class="token operator">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      exposure<span class="token operator">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        include<span class="token operator">:</span> <span class="token char">'*'</span></pre></td></tr></table></figure><ol start="5"><li>编写 FlowLimitController</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cloudalibabasentinel8401<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testA"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testA"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testB"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testB"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="测试"><a class="anchor" href="#测试">#</a> 测试</h2><ol><li>当以上的这些配置配置好以后，我们就可以进行测试了，那我们的测试方式就是，首先保证 Nacos 和 Sentinel 都是启动状态，然后再来启动项目，按照我们的理解这个时候，就应该在 Sentinel 的 dashboard 上能体现出它监控的服务，但是此时并没有，原因是因为 Sentinel 本身采用的是懒加载机制，所以我们需要首先访问服务对应的接口，Sentinel 才能工作。</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8401</span><span class="token operator">/</span>testA</pre></td></tr><tr><td data-num="2"></td><td><pre>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">8401</span><span class="token operator">/</span>testB</pre></td></tr></table></figure><ol start="2"><li>访问之后我们来查看 Sentinel 的 dashboard</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211008125726257.png" title="image-20211008125726257"><ol start="3"><li>那么这个时候我们频繁快速的访问 testA 或者 testB 那么我们再来查看实时监控的时候，就会出现波动，体现此时 Sentinel 正在监控这我们的 8401 这个服务</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211008130011873.png" title="image-20211008130011873"><h1 id="sentinel流控规则"><a class="anchor" href="#sentinel流控规则">#</a> Sentinel 流控规则</h1><h2 id="流控规则基本介绍"><a class="anchor" href="#流控规则基本介绍">#</a> 流控规则基本介绍</h2><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009142204101.png" title="image-20211009142204101"><h2 id="名词解释"><a class="anchor" href="#名词解释">#</a> 名词解释</h2><ul><li>资源名：唯一名称，默认请求路径</li><li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认 default（不区分来源）</li><li>阈值类型 / 单机阈值：<ul><li>QPS（每秒钟的请求数量）：当调用该 API 的 QPS 达到阈值的时候，进行限流</li><li>线程数：当调用该 API 的线程数量达到阈值的时候，进行限流</li></ul></li><li>是否集群：当前不需要集群</li><li>流控模式：<ul><li>直接：API 达到限流条件时，直接限流</li><li>关联：当关联的资源达到阈值时，就限流自己</li><li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）(API 级别的针对来源)</li></ul></li><li>流控效果：<ul><li>快速失败：直接失败，抛异常</li><li>Wam Up：根据 codeFactor（冷加载因子，默认 3）的值，从阈值 /codeFacotor，经过预热时长，才达到设置的 QPS 阈值</li><li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为 QPS，否则无效</li></ul></li></ul><h2 id="具体操作"><a class="anchor" href="#具体操作">#</a> 具体操作</h2><h3 id="新增流控"><a class="anchor" href="#新增流控">#</a> 新增流控</h3><p><strong>QPS 直接失败案例</strong></p><ol><li>添加有两种方式，可以直接在流控规则选项中添加，也可以在簇点链路中添加，一般会采取第二种方式</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009153205839.png" title="image-20211009153205839"><ol start="2"><li>现在我们给 &quot;/testA&quot; 添加流控。</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009153539150.png" title="image-20211009153539150"><ol start="3"><li>这里的意思就是我们现在单机阈值设定为 1，代表的是当前这个接口只能被 1 秒访问一次，超过这个阈值，就会被 Sentinel 阻塞，现在默认为直接失败，也就是会在前台有一个体现</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009153829675.png" title="image-20211009153829675"><p><strong>线程数直接失败案例</strong></p><ol><li>刚才我们可以的设置是通过 QPS（每秒钟请求的数量）来设置的限流规则，但是我们这里其实还有一个线程数，是什么意思那？</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009154620844.png" title="image-20211009154620844"><ol start="2"><li>QPS 和并发线程数规则详解</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/%E6%9C%AA%E5%91%BD%E5%90%8D%E7%BB%98%E5%9B%BE.drawio.png" title="未命名绘图.drawio"><ol start="3"><li>那我们要演示这种效果，我们就需要让一个线程再进来办理的时候需要 0.8 秒，但是这个时候后面的线程也在疯狂的访问，所以后面的线程就会不会生效。</li></ol><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cloudalibabasentinel8401<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SentinelResource</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testA"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 暂停 0.8 秒</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testA"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testB"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testB"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ol start="4"><li>这个时候我们重启项目，然后重新通过访问 testA 接口，通过两个网页（线程）来快速访问，这个时候我们来看效果，这里要注意，要重新添加流控规则。</li></ol><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211009162325899.png" title="image-20211009162325899"><p><strong>注意：这个时候虽然效果一致，但是是两种完全不同的规则，一种是 QPS，一种是并发线程，这点大家一定要分清！</strong></p><h1 id="流控规则-关联"><a class="anchor" href="#流控规则-关联">#</a> 流控规则 - 关联</h1><p>​	首先我们先来回顾一下之前讲过的一些概念</p><h2 id="名词解释-2"><a class="anchor" href="#名词解释-2">#</a> 名词解释</h2><ul><li>资源名：唯一名称，默认请求路径</li><li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认 default（不区分来源）</li><li>阈值类型 / 单机阈值：<ul><li>QPS（每秒钟的请求数量）：当调用该 API 的 QPS 达到阈值的时候，进行限流</li><li>线程数：当调用该 API 的线程数量达到阈值的时候，进行限流</li></ul></li><li>是否集群：当前不需要集群</li><li>流控模式：<ul><li>直接：API 达到限流条件时，直接限流</li><li>关联：当关联的资源达到阈值时，就限流自己</li><li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）(API 级别的针对来源)</li></ul></li><li>流控效果：<ul><li>快速失败：直接失败，抛异常</li><li>Wam Up：根据 codeFactor（冷加载因子，默认 3）的值，从阈值 /codeFacotor，经过预热时长，才达到设置的 QPS 阈值</li><li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为 QPS，否则无效</li></ul></li></ul><h2 id="关联"><a class="anchor" href="#关联">#</a> 关联</h2><p>​	官方解释：当关联的资源达到阈值时，就限流自己。</p><p>​	通俗解释来说，比如那我们的程序，现在有<strong> testA</strong> 接口和<strong> testB</strong> 接口，当 A 关联的资源 B 达到阈值后，就限流自己，也就是 B 到达阈值，限流 A 本身。就好像我家孩子在外面打架，我来处理一样。换到程序里面来说比如一个电商系统中，支付系统达到阈值，就限流下订单系统。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101144934374.png" title="image-20211101144934374"><h2 id="具体演示"><a class="anchor" href="#具体演示">#</a> 具体演示</h2><p>​	当关联资源 **/testB<strong> 的 qps 阈值超时 1 时，就限流</strong> /testA** 的 Rest 访问地址，当关联资源到阈值后限制配置好的资源名，首先我们先把 FlowLimitController 接口恢复原样</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testA"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testA"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testB"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"-----testB"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>​	给 testA 添加流控规则</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101155951868.png" title="image-20211101155951868"><p>​	为了演示效果，所以这里我们需要借助一个工具 Postman，来模仿并发密集访问 /testB，先来测试访问 testB 接口</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101163301396.png" title="image-20211101163301396"><p>​	这个时候我们需要多次密集访问 TestB 接口，所以我们需要添加配置，具体操作如下：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101164057576.png" title="image-20211101164057576"><p>把数值修改为：</p><ul><li>Iterations：为 20</li><li>Delay：300</li></ul><p>意思就是 20 个线程每间隔 0.3 秒访问一次，然后跑起来</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101164345389.png" title="image-20211101164345389"><p>​ 这个时候我们来看网页中 testA 接口的效果</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101164427548.png" title="image-20211101164427548"><h1 id="流控规则-链路"><a class="anchor" href="#流控规则-链路">#</a> 流控规则 - 链路</h1><h2 id="名词解释-3"><a class="anchor" href="#名词解释-3">#</a> 名词解释</h2><ul><li>资源名：唯一名称，默认请求路径</li><li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认 default（不区分来源）</li><li>阈值类型 / 单机阈值：<ul><li>QPS（每秒钟的请求数量）：当调用该 API 的 QPS 达到阈值的时候，进行限流</li><li>线程数：当调用该 API 的线程数量达到阈值的时候，进行限流</li></ul></li><li>是否集群：当前不需要集群</li><li>流控模式：<ul><li>直接：API 达到限流条件时，直接限流</li><li>关联：当关联的资源达到阈值时，就限流自己</li><li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）(API 级别的针对来源)</li></ul></li><li>流控效果：<ul><li>快速失败：直接失败，抛异常</li><li>Wam Up：根据 coldFactor（冷加载因子，默认 3）的值，从阈值 /codeFacotor，经过预热时长，才达到设置的 QPS 阈值</li><li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为 QPS，否则无效</li></ul></li></ul><h2 id="链路"><a class="anchor" href="#链路">#</a> 链路</h2><p>​	链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流，它的功能有点<strong>类似于针对来源配置项</strong>，<strong>区别在于：针对来源是针对上级微服务，而链路流控是针对上级接口</strong>，也就是说<strong>它的粒度更细</strong>。</p><p>​	比如在一个微服务中，两个接口都调用了同一个 Service 中的方法，并且<strong>该方法用 SentinelResource（用于定义资源）注解标注</strong>了，然后对该注解标注的资源（方法）进行配置，则可以选择链路模式。</p><p>​	<img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101190257683.png" title="image-20211101190257683"></p><h2 id="具体演示-2"><a class="anchor" href="#具体演示-2">#</a> 具体演示</h2><p>首先我们编写一个 Service</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//service.TestService</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 定义限流资源</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"common"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后更改接口调用这个 Service 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    </pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testA"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> testService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testB"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> testService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>接下来配置流控规则：</p><p>这里要注意不要对 /testA 或者 /testB 进行限流规则的配置，要给用 SentinelResource 注解标注的资源进行配置限流规则，这里的意思为当我们用入口资源访问被 SentinelResource 注解标注的资源方法时，当超过阈值就会被限流，但是此时实际效果是没有效果。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101200050932.png" title="image-20211101200050932"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101195842516.png" title="image-20211101195842516"><p>没有效果的原因是因为我们还需要添加配置，让 Sentinel 源码中 CommonFilter 中的 WEB_CONTEXT_UNIFY 参数为 false，将其配置为 false 即可根据不同的 URL 进行链路限流，如果不配置将不会生效。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    name<span class="token operator">:</span> cloudalibaba<span class="token operator">-</span>sentinel<span class="token operator">-</span>service</pre></td></tr><tr><td data-num="4"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    sentinel<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      transport<span class="token operator">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        # 配置<span class="token class-name">Sentinel</span> dashboard地址</pre></td></tr><tr><td data-num="11"></td><td><pre>        dashboard<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8080</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        # 默认<span class="token number">8719</span>端口，键入被占用会自动从<span class="token number">8719</span><span class="token operator">+</span><span class="token number">1</span>，直到找到未被占用的端口</pre></td></tr><tr><td data-num="13"></td><td><pre>        port<span class="token operator">:</span> <span class="token number">8719</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      # 配置为<span class="token boolean">false</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      web<span class="token operator">-</span>context<span class="token operator">-</span>unify<span class="token operator">:</span> <span class="token boolean">false</span></pre></td></tr></table></figure><p>最后这个时候我们再来频繁的访问 testB 接口，就会出现异常的情况，这也是流量效果快速失败在链路上的体现，是直接抛出异常。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211101202216083.png" title="image-20211101202216083"><h1 id="sentinel流控效果-预热"><a class="anchor" href="#sentinel流控效果-预热">#</a> Sentinel 流控效果 - 预热</h1><h2 id="名词解释-4"><a class="anchor" href="#名词解释-4">#</a> 名词解释</h2><ul><li>资源名：唯一名称，默认请求路径</li><li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认 default（不区分来源）</li><li>阈值类型 / 单机阈值：<ul><li>QPS（每秒钟的请求数量）：当调用该 API 的 QPS 达到阈值的时候，进行限流</li><li>线程数：当调用该 API 的线程数量达到阈值的时候，进行限流</li></ul></li><li>是否集群：当前不需要集群</li><li>流控模式：<ul><li>直接：API 达到限流条件时，直接限流</li><li>关联：当关联的资源达到阈值时，就限流自己</li><li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）(API 级别的针对来源)</li></ul></li><li><strong>流控效果：</strong><ul><li>快速失败：直接失败，抛异常</li><li><strong>Warm Up：根据 coldFactor（冷加载因子，默认 3）的值，从阈值 /codeFacotor，经过预热时长，才达到设置的 QPS 阈值</strong></li><li>排队等待：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为 QPS，否则无效</li></ul></li></ul><h2 id="预热"><a class="anchor" href="#预热">#</a> 预热</h2><p>官网手册地址：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvZmxvdy1jb250cm9sLmh0bWw=">https://sentinelguard.io/zh-cn/docs/flow-control.html</span></p><p>概念：Warm Up 方式，即预热 / 冷启动方式。该方式主要用于系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过 &quot;冷启动&quot;，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮的情况。</p><p>​	预热公式：阈值 /coldFactor（默认值为 3），经过预热时间后才会达到阈值。</p><p>​	冷启动的过程系统允许通过的 QPS 曲线如下图：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102163029355.png" title="image-20211102163029355"><p>简单理解：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102163937106.png" title="image-20211102163937106"><p>​	使用场景：一般秒杀系统中会有这样的流控设置，为了防止秒杀瞬间造成系统崩溃。</p><h2 id="案例"><a class="anchor" href="#案例">#</a> 案例</h2><p>​	默认 coldFactor 为 3，当发起请求即请求 QPS 从（阈值 / 3）开始，经过多长预热时长才逐步升至设定的 QPS 阈值，当前阈值设置为 10，预热时长设置为 5 秒。</p><p>​	最终的效果，系统初始化时阈值 / 3 约等于 3，即阈值在此时为 3，经过 5 秒后阈值才慢慢升高到 10</p><p>首先我们先来设置流控效果：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102165915771.png" title="image-20211102165915771"><p>测试，我们用最简单的方法进行测试，直接在浏览器上手动刷新，然后我们来看 Sentinel 的实时监控</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102182120756.png" title="image-20211102182120756"><h1 id="sentinel流控效果-排队等待"><a class="anchor" href="#sentinel流控效果-排队等待">#</a> Sentinel 流控效果 - 排队等待</h1><h2 id="名词解释-5"><a class="anchor" href="#名词解释-5">#</a> 名词解释</h2><ul><li>资源名：唯一名称，默认请求路径</li><li>针对来源：Sentinel 可以针对调用者进行限流，填写微服务名，默认 default（不区分来源）</li><li>阈值类型 / 单机阈值：<ul><li>QPS（每秒钟的请求数量）：当调用该 API 的 QPS 达到阈值的时候，进行限流</li><li>线程数：当调用该 API 的线程数量达到阈值的时候，进行限流</li></ul></li><li>是否集群：当前不需要集群</li><li>流控模式：<ul><li>直接：API 达到限流条件时，直接限流</li><li>关联：当关联的资源达到阈值时，就限流自己</li><li>链路：只记录指定链路上的流量（指定资源从入口资源进来的流量，如果达到阈值，就进行限流）(API 级别的针对来源)</li></ul></li><li><strong>流控效果：</strong><ul><li>快速失败：直接失败，抛异常</li><li>Warm Up：根据 coldFactor（冷加载因子，默认 3）的值，从阈值 /codeFacotor，经过预热时长，才达到设置的 QPS 阈值</li><li><strong>排队等待（匀速器）：匀速排队，让请求以匀速的速度通过，阈值类型必须设置为 QPS，否则无效</strong></li></ul></li></ul><h2 id="排队等待"><a class="anchor" href="#排队等待">#</a> 排队等待</h2><p>​	官方文档：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvZmxvdy1jb250cm9sLmh0bWw=">https://sentinelguard.io/zh-cn/docs/flow-control.html</span></p><p>​	概念：匀速排队方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法。</p><p>​	这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求（削峰填谷）。</p><p>​	例图：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102175948987.png" title="image-20211102175948987"><h3 id="匀速器"><a class="anchor" href="#匀速器">#</a> 匀速器</h3><p>​	它的中心思想是，以固定的间隔时间让请求通过。当请求到来的时候，如果当前请求距离上个通过的请求通过的时间间隔不小于预设值，则让当前请求通过。否则，计算当前请求的预期通过时间，如果该请求的预期通过时间小于规则预设的 timeout 时间，则该请求会等待直到预设时间到来通过（排队等待处理）；若预期的通过时间超出最大排队时长，则直接拒接这个请求。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102182416282.png" title="image-20211102182416282"><p>​	Sentinel 匀速排队等待策略是漏桶算法结合虚拟队列等待机制实现的。</p><p>​	注意：匀速排队模式暂时不支持 QPS &gt; 1000 的场景。</p><h2 id="演示"><a class="anchor" href="#演示">#</a> 演示</h2><p>流控规则：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102182826152.png" title="image-20211102182826152"><p>为了看到效果，我们在代码中进行打印，更改 8401 微服务中的 FlowLimitController</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cloudalibabasentinel8401<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SentinelResource</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>cloudalibabasentinel8401<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">TestService</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowLimitController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">TestService</span> testService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testA"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"：testA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token keyword">return</span> testService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testB"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> testService<span class="token punctuation">.</span><span class="token function">common</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后我们可以通过 Postman 来进行测试，发送请求时没有延迟，同时发送 10 条请求，然后我们会发现就是排队效果 1 秒执行一个请求，同时我们在 Idea 中也可以看到打桩效果</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211102184705742.png" title="image-20211102184705742"><h1 id="sentinel-熔断降级简介"><a class="anchor" href="#sentinel-熔断降级简介">#</a> Sentinel 熔断降级简介</h1><h2 id="基本概念"><a class="anchor" href="#基本概念">#</a> 基本概念</h2><h3 id="服务降级"><a class="anchor" href="#服务降级">#</a> 服务降级</h3><blockquote><p>当我们的服务调用者，去调用服务的时候；一定的时间内，如果被调用的没有反应；自己直接返回了；</p></blockquote><h3 id="服务熔断"><a class="anchor" href="#服务熔断">#</a> 服务熔断</h3><blockquote><p>当我们出发了熔断以后；服务调用者不会去调用服务提供者；</p><p>在一个周期里面所有的请求都不会再去调用了；</p><p>周期以后会重新发送一个请求服务提供者；如果提供者正常响应了，会关闭熔断器；没有，熔断器继续开启；</p></blockquote><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20220723115405292.png" title="image-20220723115405292"><h2 id="基本介绍"><a class="anchor" href="#基本介绍">#</a> 基本介绍</h2><p>​	除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。一个服务常常会调用别的模块，可能是另外的一个远程服务、数据库，或者第三方 API 等。例如，支付的时候，可能需要远程调用银联提供的 API；查询某个商品的价格，可能需要进行数据库查询。然而，这个被依赖服务的稳定性是不能保证的。如果依赖的服务出现了不稳定的情况，请求的响应时间变长，那么调用服务的方法的响应时间也会变长，线程会产生堆积，最终可能耗尽业务自身的线程池，服务本身也变得不可用。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/62410811-cd871680-b61d-11e9-9df7-3ee41c618644.png" title="chain"><p>​	现代微服务架构都是分布式的，由非常多的服务组成。不同服务之间相互调用，组成复杂的调用链路。以上的问题在链路调用中会产生放大的效果。复杂链路上的某一环不稳定，就可能会层层级联，最终导致整个链路都不可用。因此我们需要对不稳定的<strong>弱依赖服务调用</strong>进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩。熔断降级作为保护自身的手段，通常在客户端（调用端）进行配置。</p><h2 id="熔断策略"><a class="anchor" href="#熔断策略">#</a> 熔断策略</h2><p>​	Sentinel 提供了一下几种熔断策略：</p><ul><li>慢调用比例 ( <code>SLOW_REQUEST_RATIO</code> )：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（ <code>statIntervalMs</code> ）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</li><li>异常比例 ( <code>ERROR_RATIO</code> )：当单位统计时长（ <code>statIntervalMs</code> ）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code> ，代表 0% - 100%。</li><li>异常数 ( <code>ERROR_COUNT</code> )：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</li></ul><p><strong>比例阈值</strong>：$$\frac {单位时间内慢调用的个数}{单位时间内所有请求书}$$</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103172422267.png" title="image-20211103172422267"><p>Sentinel 在 1.8.0 版本对熔断降级做了大的调整，可以定义任意时长的熔断时间，引入了半开启恢复支持。下面梳理下相关特性。</p><p>熔断状态有三种状态，非别为 OPEN、HALF_OPEN、CLOSED</p><table><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>OPEN</td><td>表示熔断开启，拒绝所有请求</td></tr><tr><td>HALF_OPEN</td><td>探测恢复状态，如果接下来的一个请求顺利通过则表示结束熔断，否则继续熔断</td></tr><tr><td>CLOSE</td><td>表示熔断关闭，请求顺利通过</td></tr></tbody></table><h2 id="熔断规则"><a class="anchor" href="#熔断规则">#</a> 熔断规则</h2><p>熔断降级规则包含下面几个重要的属性：</p><table><thead><tr><th>Field</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td>resource</td><td>资源名，即规则的作用对象</td><td></td></tr><tr><td>grade</td><td>熔断策略，支持慢调用比例 / 异常比例 / 异常数策略</td><td>慢调用比例</td></tr><tr><td>count</td><td>慢调用比例模式下为慢调用临界 RT（超出该值计为慢调用）；异常比例 / 异常数模式下为对应的阈值</td><td></td></tr><tr><td>timeWindow</td><td>熔断时长，单位为 s</td><td></td></tr><tr><td>minRequestAmount</td><td>熔断触发的最小请求数，请求数小于该值时即使异常比率超出阈值也不会熔断（1.7.0 引入）</td><td>5</td></tr><tr><td>statIntervalMs</td><td>统计时长（单位为 ms），如 60*1000 代表分钟级（1.8.0 引入）</td><td>1000 ms</td></tr><tr><td>slowRatioThreshold</td><td>慢调用比例阈值，仅慢调用比例模式有效（1.8.0 引入）</td><td></td></tr></tbody></table><p>官方文档网址：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvY2lyY3VpdC1icmVha2luZy5odG1s">https://sentinelguard.io/zh-cn/docs/circuit-breaking.html</span></p><h1 id="sentinel熔断策略-慢调用比例"><a class="anchor" href="#sentinel熔断策略-慢调用比例">#</a> Sentinel 熔断策略 - 慢调用比例</h1><h2 id="慢调用比例"><a class="anchor" href="#慢调用比例">#</a> 慢调用比例</h2><p>​	概念：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（ <code>statIntervalMs</code> ）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103175357455.png" title="image-20211103175357455"><p>​	简单理解：</p><img data-src="../../../../../../../../_各大机构/马士兵/39_spring cloud/aibaba/3_章节24-45笔记/img/image-20211103194830095.png" alt="image-20211103194830095" style="zoom:50%"><p>举例：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103182809594.png" title="image-20211103182809594"><h2 id="案例演示"><a class="anchor" href="#案例演示">#</a> 案例演示</h2><p>首先我们先添加一个控制器方法：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testC"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"----testC"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>设置熔断策略，1QPS&gt;5 并且这些请求的 RT&gt;300 并且大于比例阈值触发熔断</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103193843437.png" title="image-20211103193843437"><h2 id="测试-2"><a class="anchor" href="#测试-2">#</a> 测试</h2><p>通过 JMeter 测试，1 秒钟发起 10 个线程请求 /testC，此时就会触发熔断效果，停止测试以后，10 秒钟以后恢复正常</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103200622564.png" title="image-20211103200622564"><h1 id="sentinel熔断策略-异常比例"><a class="anchor" href="#sentinel熔断策略-异常比例">#</a> Sentinel 熔断策略 - 异常比例</h1><h2 id="异常比例"><a class="anchor" href="#异常比例">#</a> 异常比例</h2><p>​	概念：异常比例 ( <code>ERROR_RATIO</code> )：当单位统计时长（ <code>statIntervalMs</code> ）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 <code>[0.0, 1.0]</code> ，代表 0% - 100%。</p><p>​	注意：异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（ <code>BlockException</code> ）不生效。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104143705448.png" title="image-20211104143705448"><p>简单理解：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104150725704.png" title="image-20211104150725704"><h2 id="案例-2"><a class="anchor" href="#案例-2">#</a> 案例</h2><p>编写测试接口</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testD"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testD</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"异常比例测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"------------testD"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>设置熔断策略异常比例</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104202552823.png" title="image-20211104202552823"><h2 id="测试-3"><a class="anchor" href="#测试-3">#</a> 测试</h2><p>我们通过 JMeter 来测试，设定 HTTP 请求地址</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104154856685.png" title="image-20211104154856685"><p>1 秒钟发送 10 个请求</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104154931689.png" title="image-20211104154931689"><p>当启动 JMeter 的时候，就会触发熔断，因为此时我们 1 秒钟发送 10 个请求超过了最小请求数 5，同时超过了阈值，满足了两个条件，当熔断时长过后就会恢复正常。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104155351048.png" title="image-20211104155351048"><h1 id="sentinel熔断策略-异常数"><a class="anchor" href="#sentinel熔断策略-异常数">#</a> Sentinel 熔断策略 - 异常数</h1><h2 id="异常数"><a class="anchor" href="#异常数">#</a> 异常数</h2><p>​	概念：异常数 ( <code>ERROR_COUNT</code> )：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。</p><p>​	注意：异常降级<strong>仅针对业务异常</strong>，对 Sentinel 限流降级本身的异常（ <code>BlockException</code> ）不生效。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104160536648.png" title="image-20211104160536648"><p>简单理解：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104162446764.png" title="image-20211104162446764"><h2 id="案例演示-2"><a class="anchor" href="#案例演示-2">#</a> 案例演示</h2><p>编写接口</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testE"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testE</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> id <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"异常数测试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"------------testE"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>设置异常数策略，当 1 秒钟内请求超过 5 并且异常数大约 5 个的时候触发熔断</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104162844045.png" title="image-20211104162844045"><h2 id="测试-4"><a class="anchor" href="#测试-4">#</a> 测试</h2><p>通过 JMeter 来测试</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104163014944.png" title="image-20211104163014944"><p>1 秒钟发送 10 个请求</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104163107494.png" title="image-20211104163107494"><p>此时就会触发熔断</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104163209702.png" title="image-20211104163209702"><h1 id="sentinel-热点规则上"><a class="anchor" href="#sentinel-热点规则上">#</a> Sentinel 热点规则（上）</h1><h2 id="概念"><a class="anchor" href="#概念">#</a> 概念</h2><p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p><ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li><li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul><p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效</p><p>官网：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvcGFyYW1ldGVyLWZsb3ctY29udHJvbC5odG1s">https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html</span></p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/sentinel-hot-param-overview-1.png" title="sentinel-hot-param-overview-1"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104175442912.png" title="image-20211104175442912"><p>这里还有相对应的高级选项，我们这里先了解基本规则。</p><h2 id="使用sentinelresource注解"><a class="anchor" href="#使用sentinelresource注解">#</a> 使用 @SentinelResource 注解</h2><p>其实这个热点限流其实就是更加细粒度的流控规则，那么如果想使用它就必须要配合对应 SentinelResource 注解。</p><p>Sentinel 提供了 @SentinelResource 注解用于定义资源，它有很多的参数，我们这里主要关注两个参数：</p><ol><li>value：代表资源名称，必需项，因为需要通过 resource name 找到对应的规则，这个是必须配置的</li><li>blockHandler：blockHandler 对应处理 BlockException 的方法名称，可选项，访问范围需要是 public，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException。</li></ol><h2 id="案例讲解"><a class="anchor" href="#案例讲解">#</a> 案例讲解</h2><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104185357465.png" title="image-20211104185357465"><h3 id="sentinelresourcevaluexxx"><a class="anchor" href="#sentinelresourcevaluexxx">#</a> @SentinelResource(value=&quot;xxx&quot;)</h3><p>那现在我们要完成以上图中的效果，这个时候我们首先要编写代码，在 FlowLimitController 中编写代码</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testHotKey"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">"testHotKey"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot1"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> hot1<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot2"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> hot2<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot13"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> hot3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"----testHotKey"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后再来配置热点规则</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104185609520.png" title="image-20211104185609520"><p>这里要说明一下，参数索引 0 实际上代表的就是我们设置的 hot1 参数</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104190217984.png" title="image-20211104190217984"><p>测试，此时如果我们传入参数 hot1，并且超过阈值，就会出现限流，但是此时的限流效果为报错，显示不友好</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104192341003.png" title="image-20211104192341003"><h3 id="sentinelresourcevaluexxxblockhandlerxxx"><a class="anchor" href="#sentinelresourcevaluexxxblockhandlerxxx">#</a> @SentinelResource(value=&quot;xxx&quot;,blockHandler=&quot;xxx&quot;)</h3><p>刚才的演示中，我们明显发现这种限流方法的提示效果非常不友好，所以如果我们需要能够得到友好的提示，我们就需要使用 @SentinelResource 注解提供的另外一个参数 blockHandler，这个参数是可以指定当出现异常时的处理方法，具体操作如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testHotKey"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"testHotKey"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"handler_HotKey"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testHotKey</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot1"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> hot1<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot2"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token class-name">String</span> hot2<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>                         <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"hot13"</span><span class="token punctuation">,</span>required <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token class-name">String</span> hot3<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"----testHotKey"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">// 处理异常方法，方法签名要和对应的接口方法保持一致</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handler_HotKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> hot1<span class="token punctuation">,</span> <span class="token class-name">String</span> hot2<span class="token punctuation">,</span><span class="token class-name">String</span> hot3<span class="token punctuation">,</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"系统繁忙稍后重试。。"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后热点规则不变，我们最终的到的限流效果如下：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104195122220.png" title="image-20211104195122220"><h1 id="sentinel-热点规则下"><a class="anchor" href="#sentinel-热点规则下">#</a> Sentinel 热点规则（下）</h1><h2 id="概念-2"><a class="anchor" href="#概念-2">#</a> 概念</h2><p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的 Top K 数据，并对其访问进行限制。比如：</p><ul><li>商品 ID 为参数，统计一段时间内最常购买的商品 ID 并进行限制</li><li>用户 ID 为参数，针对一段时间内频繁访问的用户 ID 进行限制</li></ul><p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效</p><p>官网：<span class="exturl" data-url="aHR0cHM6Ly9zZW50aW5lbGd1YXJkLmlvL3poLWNuL2RvY3MvcGFyYW1ldGVyLWZsb3ctY29udHJvbC5odG1s">https://sentinelguard.io/zh-cn/docs/parameter-flow-control.html</span></p><p>![sentinel-hot-param-overview-1](../../../../../../../../_各大机构 / 马士兵 / 39_spring cloud/aibaba/3_章节 24-45 笔记 /sentinel-hot-param-overview-1.png)</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211105144025601.png" title="image-20211105144025601"><h2 id="参数例外项"><a class="anchor" href="#参数例外项">#</a> 参数例外项</h2><p>​	其实参数例外项就是可以达到更加细粒度的控制，比如我们当前的例子中，目前 hot1 参数在访问时超过阈值就会被限流，但是我们可以通过参数例外项设置 hot1 具体等于特殊的某个值的时候，触发不同的限流效果。假如 hot1 的值等于 5 时，它的阈值可以达到 200。</p><p>​	** 注意：** 参数例外项中的参数类型仅支持一下 7 种数据类型</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211105144912213.png" title="image-20211105144912213"><h2 id="案例演示-3"><a class="anchor" href="#案例演示-3">#</a> 案例演示</h2><p>当前我们需要让 hot1 的值为 5 的时候阈值可以达到 200，首先 Sentinel 页面中修改对应热点规则（在这之前，先演示传递一个参数，否则配置失败）</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211105145445284.png" title="image-20211105145445284"><p>此时的规则为：如果当前 hot1 值为除 5 以外的其他值，都会走普通的阈值规则，但是如果一旦 hot1 的值为 5 的时候，将会走参数例外项，此时的阈值为 200，我们通过浏览器测试，当 hot1 的值等于 5 是只要阈值不超过 200 就不会出现限流。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211105154930110.png" title="image-20211105154930110"><p>​	注意：题我们到现在代码中使用了 @SentinelResource 注解，此注解处理的是<strong> Sentinel 控制台配置的异常</strong>，通过 blockHandler 属性设置对应方法来处理和程序本身异常无关。</p><p>​	所以以下程序中如果 hot1 的值等于 6 还是会出现 RuntimeException。</p><pre><code>@SentinelResource(value = &quot;testHotKey&quot;,blockHandler = &quot;handler_HotKey&quot;)
public String testHotKey(@RequestParam(value = &quot;hot1&quot;,required = false) String hot1,
                         @RequestParam(value = &quot;hot2&quot;,required = false) String hot2,
                         @RequestParam(value = &quot;hot3&quot;,required = false) String hot3)&#123;
    if(&quot;6&quot;.equals(hot1))&#123;
        throw new RuntimeException(&quot;运行时异常&quot;);
    &#125;
    return &quot;-----testHotKey&quot;;
&#125;
</code></pre><h1 id="sentinel-系统规则"><a class="anchor" href="#sentinel-系统规则">#</a> Sentinel 系统规则</h1><p>​	Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><h2 id="系统规则"><a class="anchor" href="#系统规则">#</a> 系统规则</h2><p>​	系统保护规则是从应用级别 的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p><p>​	系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量，比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108170904455.png" title="image-20211108170904455"><p><strong>系统规则支持一下的模式：</strong></p><ul><li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1（1 分钟平均负载） 作为启发指标，进行自适应系统保护。当系统 load1（1 分钟平均负载） 超过设定的启发值（阈值），且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps(秒级统计的最大QPS) * minRt(秒级统计的最小响应时间)</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code> 。</li><li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li><li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li><li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li><li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108162812623.png" title="image-20211108162812623"><h2 id="案例演示-4"><a class="anchor" href="#案例演示-4">#</a> 案例演示</h2><p>这里我们只通过入口 QPS 来进行测试，直接设置规则</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108173108215.png" title="image-20211108173108215"><p>最后测试效果不管现在我们访问那个接口只要超过阈值就会被限流</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108173202180.png" title="image-20211108173202180"><h1 id="sentinelresource-自定义限流逻辑处理"><a class="anchor" href="#sentinelresource-自定义限流逻辑处理">#</a> @SentinelResource 自定义限流逻辑处理</h1><p>​	Sentinel 提供了 @SentinelResource 注解用于定义资源，并提供了 AspectJ 的扩展用于自定义资源，处理 BlockException 等。</p><h2 id="案例复习"><a class="anchor" href="#案例复习">#</a> 案例复习</h2><p>之前我们用过这个注解，同时了解了它的两个属性：</p><ul><li>value：资源名称，必须项（唯一，不能为空）</li><li>blockHandler：对应处理 BlockException 的函数名称可选项.blockHandler 函数访问需要 public, 返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 BlockException.blockHandler 函数默认需要和原方法在同一个类中</li></ul><p>我们之前利用这个注解完成了热点规则的学习，同时做了一个案例，我们简单复习一下，这个案例的核心思想就是我们传递一个指定参数，然后通过注解 @SentinelResource 注解标注资源进行限流，当出现限流以后，通过 blockHandler 属性设置限流以后的解决方法。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211104185357465.png" title="image-20211104185357465"><p>其实这个注解不仅仅可以用到热点规则上，还可以用到流控上，我们可以做一个资源的流控和一个请求的流控，通过此注解来解决限流之后问题。</p><h2 id="sentinelresource-资源限流"><a class="anchor" href="#sentinelresource-资源限流">#</a> @SentinelResource 资源限流</h2><p>** 核心点：** 使用 @SentinelResource 注解的 blockHandler 属性，定义出现限流效果时的解决方法。</p><p>编写一个新的控制器类型 SentinelResourceTestController，使用 @SentinelResource 注解同时使用 blockHandler 属性</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/byResource"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"byResource"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"handler_resource"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">byResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"-----byResource"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">handler_resource</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"系统繁忙"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里要注意一定要给 byResource 资源添加流控</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108195609306.png" title="image-20211108195609306"><p>具体规则</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108195638721.png" title="image-20211108195638721"><p>测试，测试我们去快速访问 http://localhost:8401/byResource，就会出现我们使用 @SentinelResource 注解中 blockHandler 属性提供的解决限流异常的方法。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108195926004.png" title="image-20211108195926004"><h2 id="sentinelresource-url限流"><a class="anchor" href="#sentinelresource-url限流">#</a> @SentinelResource URL 限流</h2><p>** 核心点：** 使用 @SentinelResource 注解，但是不使用 blockHandler 属性，系统会调用默认限流异常处理方法。</p><p>其实这个注解，我们还可以更换请求地址为资源，比如我们在新建一个测试接口方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/byRest"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"byRest"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">byRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"-----byRest"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>给这个接口地址添加流控</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108200724588.png" title="image-20211108200724588"><p>此时如果没有自己定义限流处理方法，会走系统默认的</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108200750521.png" title="image-20211108200750521"><h2 id="结论"><a class="anchor" href="#结论">#</a> 结论</h2><ol><li>@SentinelResource 既可以配置资源名称也可以配置 URL</li><li>如果配置了 @SentinelResource 的 blockHandler 属性对应方法，出现限流会调用对应方法</li><li>如果没有配置 @SentinelResource 的 blockHandler 属性，系统会走默认的限流处理。</li></ol><h2 id="自定义限流处理逻辑"><a class="anchor" href="#自定义限流处理逻辑">#</a> 自定义限流处理逻辑</h2><p>其实我们在使用 @SentinelResource 注解这两种方案的时候，会出现一些问题：</p><ol><li>没有体现我们自己的业务要求。</li><li>自定义处理方法和业务代码耦合在一起。</li><li>每个业务方法都添加一个限流处理方法，代码将会加剧膨胀。</li><li>无法实现统一全局处理。</li></ol><p>解决：@<strong>SentinelResource</strong> 除了<strong> blockHandler</strong> 可以设置自定义限流处理逻辑方法以外，还提供另外一个属性来设置限流处理逻辑类型<strong> blockHandlerClass</strong> 属性，此属性中设置的方法必需为 static 函数，否则无法解析。</p><h3 id="具体逻辑"><a class="anchor" href="#具体逻辑">#</a> 具体逻辑</h3><p><strong>第一步</strong></p><p>创建 CustomerBlockHandler 类型用于处理自定义限流处理逻辑，首先创建 myhandler.CustomerBlockHandler</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 此类型用来处理限流自定义逻辑</pre></td></tr><tr><td data-num="3"></td><td><pre> */</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerBlockHandler</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">handlerException1</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"handlerException1：系统异常，请稍后重试！"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">handlerException2</span><span class="token punctuation">(</span><span class="token class-name">BlockException</span> exception<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"handlerException2：网络崩溃了，请稍后重试！"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>第二步</strong></p><p>我们在 SentinelResourceTestController 类型中添加一个接口方法，同时设置 @SentinelResource 注解和 blockHandlerClass 属性对应的类型和这个类型中对应的处理方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* 此方法用到了自定义限流处理类型 CustomerBlockHandler</pre></td></tr><tr><td data-num="3"></td><td><pre>* 中的 handlerException1 方法来处理限流逻辑。</pre></td></tr><tr><td data-num="4"></td><td><pre>*/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/bycustomer"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"bycustomer"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                  blockHandlerClass <span class="token operator">=</span> <span class="token class-name">CustomerBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                  blockHandler <span class="token operator">=</span> <span class="token string">"handlerException1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">bycustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"-----bycustomer"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>第三步</strong></p><p>测试：给 bycustomer 资源添加限流规则，然后来测试在超过限流阈值时处理方法是否为 CustomerBlockHandler 中 handlerException1 来进行处理。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108205553306.png" title="image-20211108205553306"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108205606689.png" title="image-20211108205606689"><p>添加流控规则以后，我们再来频繁访问 http://localhost:8401/bycustomer，就会看见是 CustomerBlockHandler 类型的 handlerException1 方法来处理自定义限流逻辑</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108205735265.png" title="image-20211108205735265"><h3 id="对应关系图"><a class="anchor" href="#对应关系图">#</a> 对应关系图</h3><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211108210142209.png" title="image-20211108210142209"><h1 id="sentinel服务熔断环境搭建"><a class="anchor" href="#sentinel服务熔断环境搭建">#</a> Sentinel 服务熔断环境搭建</h1><p>服务熔断：应对微服务雪崩效应的一种链路保护机制，类似保险丝。</p><p>需要完成 Sentinel 整合 Ribbon+openFeign，所以我们先要搭建环境，那么先从整合 Ribbon 开始</p><h2 id="环境搭建"><a class="anchor" href="#环境搭建">#</a> 环境搭建</h2><p>为了演示操作，所以在这里我们需要利用 Ribbon 进行负载均衡的调用，所以我们需要创建一个服务消费者 cloudalibaba-consumer8084 和两个服务提供者 cloudalibaba-provider9003 和 cloudalibaba-provider9004，以下是结构图</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211109170609356.png" title="image-20211109170609356"><p>其实我们之前就搭建过这种结构，比较简单，所以我们快速搭建</p><h3 id="新建cloudalibaba-provider-90039004"><a class="anchor" href="#新建cloudalibaba-provider-90039004">#</a> 新建 cloudalibaba-provider-9003/9004</h3><p>在建立 9003 和 9004 之前，先建立一个共享项目 cloudalibaba-commons，在其中新建一个类型 JsonResult，这个类型用于返回 JSON 数据类型</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建服务提供者 9003，9004 基本上是一样的，所以我们建立 9003 复制就可以得到 9004</p><p><strong>pom</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">></span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>parent<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span><span class="token class-name">SpringAlibabaMSB</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token operator">&lt;</span>relativePath<span class="token operator">/</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> lookup parent from repository <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>parent<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">9003</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>name<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">9003</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>description<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>provider<span class="token operator">-</span><span class="token number">9003</span><span class="token operator">&lt;</span><span class="token operator">/</span>description<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>java<span class="token punctuation">.</span>version<span class="token punctuation">></span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>java<span class="token punctuation">.</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">></span></span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>commons<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">></span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>build<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>plugin<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">></span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">></span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>build<span class="token operator">></span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">></span></pre></td></tr></table></figure><p><strong>yml</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">9003</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    name<span class="token operator">:</span> nacos<span class="token operator">-</span>provider</pre></td></tr><tr><td data-num="7"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span> #配置<span class="token class-name">Nacos</span>地址</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>management<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  endpoints<span class="token operator">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    web<span class="token operator">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      exposure<span class="token operator">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        include<span class="token operator">:</span> <span class="token char">'*'</span></pre></td></tr></table></figure><p><strong>主启动添加注解</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaprovider9003</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">EnableDiscoveryClient</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@EnableDiscoveryClient</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloudalibabaProvider9003Application</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CloudalibabaProvider9003Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><strong>控制器</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaprovider9003<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabacommons<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">Log</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;server.port&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> serverPort<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 模仿数据库存储数据</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">></span></span> hashMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">1l</span><span class="token punctuation">,</span><span class="token string">"鼠标"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">2l</span><span class="token punctuation">,</span><span class="token string">"键盘"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        hashMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token number">3l</span><span class="token punctuation">,</span><span class="token string">"耳机"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"info/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">msbSql</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token punctuation">(</span><span class="token number">1L</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span>hashMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>** 注意：**9004 和 9003 一致，但是要注意修改 yml 文件端口号</p><h3 id="新建cloudalibaba-consumer8084"><a class="anchor" href="#新建cloudalibaba-consumer8084">#</a> 新建 cloudalibaba-consumer8084</h3><p><strong>pom</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">></span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>parent<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span><span class="token class-name">SpringAlibabaMSB</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token operator">&lt;</span>relativePath<span class="token operator">/</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> lookup parent from repository <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>parent<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>consumer8084<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>name<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>consumer8084<span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>description<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>consumer8084<span class="token operator">&lt;</span><span class="token operator">/</span>description<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>java<span class="token punctuation">.</span>version<span class="token punctuation">></span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>java<span class="token punctuation">.</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">></span></span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">SpringCloud</span> ailibaba nacos <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token class-name">SpringCloud</span> ailibaba sentinel <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>sentinel<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>commons<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">></span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>build<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>plugin<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="51"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">></span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">></span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>build<span class="token operator">></span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">></span></pre></td></tr></table></figure><p><strong>yml</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8084</span></pre></td></tr><tr><td data-num="3"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    name<span class="token operator">:</span> nacos<span class="token operator">-</span>consumer</pre></td></tr><tr><td data-num="6"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    sentinel<span class="token operator">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      transport<span class="token operator">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        #配置<span class="token class-name">Sentinel</span> dashboard地址</pre></td></tr><tr><td data-num="13"></td><td><pre>        dashboard<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8080</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        #默认<span class="token number">8719</span>端口，假如被占用会自动从<span class="token number">8719</span>开始依次<span class="token operator">+</span><span class="token number">1</span>扫描<span class="token punctuation">,</span>直至找到未被占用的端口</pre></td></tr><tr><td data-num="15"></td><td><pre>        port<span class="token operator">:</span> <span class="token number">8719</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>#消费者将要去访问的微服务名称<span class="token punctuation">(</span>注册成功进nacos的微服务提供者<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre>service<span class="token operator">-</span>url<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  nacos<span class="token operator">-</span>user<span class="token operator">-</span>service<span class="token operator">:</span> http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>nacos<span class="token operator">-</span>provider</pre></td></tr></table></figure><p>主启动添加注解和 9003/9004 一致</p><p><strong>控制器</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabacommons<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 服务提供者 URL</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;service-url.nacos-user-service&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SERVICE_URL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer/fallback/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 通过 Ribbon 发起远程访问，访问 9003/9004</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">SERVICE_URL</span><span class="token operator">+</span><span class="token string">"/info/"</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    	<span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="最后测试"><a class="anchor" href="#最后测试">#</a> 最后测试</h2><p>访问 http://localhost:8084/consumer/fallback/1</p><p>查看最后结果是否为 9003/9004 切换调用</p><h1 id="sentinelresource的fallback属性"><a class="anchor" href="#sentinelresource的fallback属性">#</a> SentinelResource 的 fallback 属性</h1><h2 id="fallback属性"><a class="anchor" href="#fallback属性">#</a> fallback 属性</h2><p>** 概念：**fallback 函数名称，可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：</p><ul><li>返回值类型必须与原函数返回值类型一致；</li><li>方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li><li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li></ul><p>其实通过官网上提供的概念，我们不难看出这个属性类似于 blockHandler，但是各位一定要注意他们有本质的不同。</p><p>** 注意：**fallback 属性和 blockHandler 属性的本质不同在于他们作用的异常不同：</p><ul><li>blockHandler：针对违反 Sentinel 控制台配置规则时触发 BlockException 异常时对应处理的属性</li><li>fallback：针对 Java 本身出现的异常进行处理的对应属性。</li></ul><h2 id="案例演示-5"><a class="anchor" href="#案例演示-5">#</a> 案例演示</h2><p>​	上节课我们已经完成环境的搭建，那我们就直接在 8084 项目的 DemoController 中编写对应代码</p><p>首先我们先来设置异常规则</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaconsumer8084</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabacommons<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Value</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 服务提供者 URL</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;service-url.nacos-user-service&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SERVICE_URL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer/fallback/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 通过 Ribbon 发起远程访问，访问 9003/9004</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">SERVICE_URL</span><span class="token operator">+</span><span class="token string">"/info/"</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"没有对应的数据记录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>​	此时我们任务添加了异常，此时如果我们访问 http://localhost:8084/consumer/fallback/4（id 非法）地址时，就会出现对应的显示效果：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211111180018647.png" title="image-20211111180018647"><p>​	明显此时显示效果非常不好，我们就可以通过 @SentinelResource 注解的 fallback 属性来解决这种 java 异常，给出友好提示</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 服务提供者 URL</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;service-url.nacos-user-service&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SERVICE_URL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer/fallback/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 添加 SentinelResource 注解的 fallback 属性，同时设置方法来解决 Java 异常</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"falllback"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"fallbackHandler"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 通过 Ribbon 发起远程访问，访问 9003/9004</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">SERVICE_URL</span><span class="token operator">+</span><span class="token string">"/info/"</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"没有对应的数据记录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 保证方法签名基本保持一致，但是要添加异常类型参数</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallbackHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"出现未知商品id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>​	到这里为止，我们就很清楚的知道了 fallback 属性的作用，同时它和 blockHandler 属性类似，也可以设置 fallbackClass 属性，来指定对应类型，来处理对应的 Java 异常，当然要注意和 blockHandlerClass 属性一样，也需要让所有的方法都必需为 static 函数，否则无法解析。</p><h2 id="同时配置blockhandler和fallback属性"><a class="anchor" href="#同时配置blockhandler和fallback属性">#</a> 同时配置 blockHandler 和 fallback 属性</h2><p>​	通过上述的内容，我们很清楚的知道了 fallback 属性的作用，但是大家现在想一个问题，如果我们在使用 @SentinelResource 属性的时候，同时设置 blockHandler 属性和 fallback 属性时，并且同时出现了 Sentinel 异常和 Java 异常，这个时候会执行哪个方法那。</p><p>我们还是回顾一下 blockHandler 属性的概念：</p><ul><li><code>blockHandler</code> / <code>blockHandlerClass</code> : <code>blockHandler</code> 对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code> ，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code> 。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li></ul><h2 id="案例演示-6"><a class="anchor" href="#案例演示-6">#</a> 案例演示</h2><p>​	我们现在同时在 DemoController 中设置 fallback 属性和 blockHandler 属性</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 服务提供者 URL</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;service-url.nacos-user-service&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SERVICE_URL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer/fallback/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 同时添加 SentinelResource 注解的 fallback 和 blockHandler 属性</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"falllback"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"fallbackHandler"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"blockHandler"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 通过 Ribbon 发起远程访问，访问 9003/9004</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">SERVICE_URL</span><span class="token operator">+</span><span class="token string">"/info/"</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"没有对应的数据记录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">// 处理 Java 异常</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallbackHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"NullPointerException异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">// 处理 Sentinel 限流</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">445</span><span class="token punctuation">,</span><span class="token string">"BlockException限流"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>​	此时我们来设置 Sentinel 配置，我们通过熔断规则中的异常数来演示（当然也可以用其他的）</p><p>规则：在一秒内超过最小访问次数 5 次，并且异常数超过 2 的时候，就会触发熔断规则。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211111182629454.png" title="image-20211111182629454"><p>此时我们来访问 http://localhost:8084/consumer/fallback/6 看效果：</p><ul><li>在没有触发熔断之前的异常交给 fallback 来处理</li></ul><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211111182834520.png" title="image-20211111182834520"><ul><li>但是一旦触发熔断规则就变成了 blockHandler 来处理</li></ul><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211111183011670.png" title="image-20211111183011670"><h2 id="exceptionstoignore属性"><a class="anchor" href="#exceptionstoignore属性">#</a> exceptionsToIgnore 属性</h2><ul><li><code>exceptionsToIgnore</code> （since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DemoController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 服务提供者 URL</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"$&#123;service-url.nacos-user-service&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token constant">SERVICE_URL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/consumer/fallback/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 同时添加 SentinelResource 注解的 fallback 和 blockHandler 属性</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"falllback"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">"fallbackHandler"</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">"blockHandler"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            exceptionsToIgnore <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token class-name">NullPointerException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token comment">// 被标注的异常将会被 原样抛出</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">&lt;=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token comment">// 通过 Ribbon 发起远程访问，访问 9003/9004</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span><span class="token constant">SERVICE_URL</span><span class="token operator">+</span><span class="token string">"/info/"</span><span class="token operator">+</span>id<span class="token punctuation">,</span><span class="token class-name">JsonResult</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">else</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"没有对应的数据记录"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 处理 Java 异常</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">fallbackHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"NullPointerException异常"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token comment">// 处理 Sentinel 限流</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">445</span><span class="token punctuation">,</span><span class="token string">"BlockException限流"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="openfeign基础应用"><a class="anchor" href="#openfeign基础应用">#</a> OpenFeign 基础应用</h1><h2 id="概念-3"><a class="anchor" href="#概念-3">#</a> 概念</h2><p>OpenFeign 是一种声明式、模板化的 HTTP 客户端。在 Spring Cloud 中使用 OpenFeign，可以做到使用 HTTP 请求访问远程服务，就像调用本地方法一样的，开发者完全感知不到这是在调用远程方法，更感知不到在访问 HTTP 请求，用法其实就是编写一个接口，在接口上添加注解即可。</p><p>可以简单理解它是借鉴 Ribbon 的基础之上，封装的一套服务接口 + 注解的方式的远程调用器。</p><h2 id="openfeign能干什么"><a class="anchor" href="#openfeign能干什么">#</a> OpenFeign 能干什么</h2><p>它的宗旨是在编写 Java Http 客户端接口的时候变得更加容易，其底层整合了 Ribbon，所以也支持负载均衡。</p><p>之前我们使用 Ribbon 的时候，利用 RestTemplate 对 Http 请求进行封装处理，但是在实际开发中，由于对服务依赖的调用不可能就一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用。所以 OpenFeign 在此基础之上做了进一步的封装，由它来帮助我们定义和实现依赖服务接口的定义，我们只需创建一个接口并使用注解的方式来配置它，即可完成对微服务提供方的接口绑定，简化 Ribbon 的操作。</p><h2 id="具体使用"><a class="anchor" href="#具体使用">#</a> 具体使用</h2><p>这里我们通过一个案例来演示，首先我们要明确使用 OpenFeign 是使用在消费者端去远程调用，就必须要是用 FeignClient 注解，来标注要调用的服务提供者名称，然后在通过一个接口来定义要调用的方法，所以我们首先新建一个 Model：cloudalibaba-openFeign-consumer-8888</p><h3 id="pom"><a class="anchor" href="#pom">#</a> pom</h3><p>注意：需要在父级项目引入对应依赖坐标</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span>$<span class="token punctuation">&#123;</span>openfeign<span class="token operator">-</span>version<span class="token punctuation">&#125;</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">?</span><span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">&lt;</span>project xmlns<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0"</span> xmlns<span class="token operator">:</span>xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span></pre></td></tr><tr><td data-num="3"></td><td><pre>         xsi<span class="token operator">:</span>schemaLocation<span class="token operator">=</span><span class="token string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>modelVersion<span class="token punctuation">></span></span><span class="token number">4.0</span><span class="token number">.0</span><span class="token operator">&lt;</span><span class="token operator">/</span>modelVersion<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>parent<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span><span class="token class-name">SpringAlibabaMSB</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token operator">&lt;</span>relativePath<span class="token operator">/</span><span class="token operator">></span> <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> lookup parent from repository <span class="token operator">--</span><span class="token operator">></span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>parent<span class="token operator">></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>openFeign<span class="token operator">-</span>consumer<span class="token operator">-</span><span class="token number">8888</span><span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>name<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>openFeign<span class="token operator">-</span>consumer<span class="token operator">-</span><span class="token number">8888</span><span class="token operator">&lt;</span><span class="token operator">/</span>name<span class="token operator">></span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>description<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>openFeign<span class="token operator">-</span>consumer<span class="token operator">-</span><span class="token number">8888</span><span class="token operator">&lt;</span><span class="token operator">/</span>description<span class="token operator">></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>properties<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>java<span class="token punctuation">.</span>version<span class="token punctuation">></span></span><span class="token number">1.8</span><span class="token operator">&lt;</span><span class="token operator">/</span>java<span class="token punctuation">.</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>properties<span class="token operator">></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>dependencies<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>test<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>scope<span class="token punctuation">></span></span>test<span class="token operator">&lt;</span><span class="token operator">/</span>scope<span class="token operator">></span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>alibaba<span class="token operator">-</span>nacos<span class="token operator">-</span>discovery<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>mashibing<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>cloudalibaba<span class="token operator">-</span>commons<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">0.0</span><span class="token number">.1</span><span class="token operator">-</span><span class="token constant">SNAPSHOT</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>dependencies<span class="token operator">></span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>build<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token generics"><span class="token punctuation">&lt;</span>plugins<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token generics"><span class="token punctuation">&lt;</span>plugin<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>maven<span class="token operator">-</span>plugin<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token operator">&lt;</span><span class="token operator">/</span>plugin<span class="token operator">></span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token operator">&lt;</span><span class="token operator">/</span>plugins<span class="token operator">></span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token operator">&lt;</span><span class="token operator">/</span>build<span class="token operator">></span></pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>project<span class="token operator">></span></pre></td></tr></table></figure><h3 id="javalangillegalstateexception-no-feign-client-for-loadbalancing-defined-did-you-forget-to-include-spring-cloud-starter-loadbalancer"><a class="anchor" href="#javalangillegalstateexception-no-feign-client-for-loadbalancing-defined-did-you-forget-to-include-spring-cloud-starter-loadbalancer">#</a> java.lang.IllegalStateException: No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-loadbalancer?</h3><p>由于 Spring Cloud Feign 在 Hoxton.M2 RELEASED 版本之后不再使用 Ribbon 而是使用 spring-cloud-loadbalancer，所以不引入 spring-cloud-loadbalancer 会报错.</p><p>解决方法：<br>加入 spring-cloud-loadbalancer 依赖 并且在 nacos 中排除 ribbon 依赖，不然 loadbalancer 无效</p><p>排除 ribbon 依赖</p><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">&lt;!-- 服务注册 / 发现  --></span></pre></td></tr><tr><td data-num="2"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-cloud-starter-alibaba-nacos-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>com.netflix.ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre>                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>ribbon<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><h3 id="yml配置"><a class="anchor" href="#yml配置">#</a> YML 配置</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8888</span></pre></td></tr><tr><td data-num="3"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    name<span class="token operator">:</span> nacos<span class="token operator">-</span>consumer<span class="token operator">-</span>openFeign</pre></td></tr><tr><td data-num="6"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>management<span class="token operator">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  endpoints<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    web<span class="token operator">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      exposure<span class="token operator">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        include<span class="token operator">:</span> <span class="token char">'*'</span></pre></td></tr></table></figure><h3 id="主启动中添加注解"><a class="anchor" href="#主启动中添加注解">#</a> 主启动中添加注解</h3><pre><code>@SpringBootApplication
@EnableDiscoveryClient
@EnableFeignClients//添加此注解
public class CloudalibabaOpenFeignConsumer8888Application &#123;

    public static void main(String[] args) &#123;
        SpringApplication.run(CloudalibabaOpenFeignConsumer8888Application.class, args);
    &#125;

&#125;
</code></pre><h3 id="调用服务提供者对外提供接口"><a class="anchor" href="#调用服务提供者对外提供接口">#</a> 调用服务提供者对外提供接口</h3><p>这里要调用的是服务提供者 9003/9004</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112183106167.png" title="image-20211112183106167"><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaopenFeignconsumer8888<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabacommons<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>openfeign<span class="token punctuation">.</span></span><span class="token class-name">FeignClient</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * 此接口就是配合使用 OpenFeign 的接口，</pre></td></tr><tr><td data-num="11"></td><td><pre> * 在此接口中添加 @FeignClient 接口同时标注</pre></td></tr><tr><td data-num="12"></td><td><pre> * 要调用的服务端名称，同时使用与服务提供者</pre></td></tr><tr><td data-num="13"></td><td><pre> * 方法签名一致的抽象方法来表示远程调用的</pre></td></tr><tr><td data-num="14"></td><td><pre> * 具体内容</pre></td></tr><tr><td data-num="15"></td><td><pre> */</pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment">// 表示远程调用服务名称</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span><span class="token string">"nacos-provider"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OpenFeignService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * 此方法表示远程调用 info/&#123;id&#125; 接口</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"info/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">msbSql</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="控制器"><a class="anchor" href="#控制器">#</a> 控制器</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaopenFeignconsumer8888<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabacommons<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">JsonResult</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaopenFeignconsumer8888<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">OpenFeignService</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PathVariable</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OpenFeignController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OpenFeignService</span> openFeignService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"getInfo/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">return</span> openFeignService<span class="token punctuation">.</span><span class="token function">msbSql</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="测试结果"><a class="anchor" href="#测试结果">#</a> 测试结果</h2><p>能够远程调用的同时还有负载均衡效果</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112205138375.png" title="image-20211112205138375"><h1 id="openfeign超时时间控制"><a class="anchor" href="#openfeign超时时间控制">#</a> OpenFeign 超时时间控制</h1><h2 id="概念-4"><a class="anchor" href="#概念-4">#</a> 概念</h2><p>OpenFeign 客户端默认等待 1 秒钟，但是如果服务端业务超过 1 秒，则会报错。为了避免这样的情况，我们需要设置 feign 客户端的超时控制。</p><h2 id="解决办法"><a class="anchor" href="#解决办法">#</a> 解决办法</h2><p>由于 OpenFeign 底层是 ribbon 。所以超时控制由 ribbon 来控制。在 yml 文件中配置</p><h2 id="超时案例演示"><a class="anchor" href="#超时案例演示">#</a> 超时案例演示</h2><p>首先演示超时效果，我们现在 9003/9004 上设置一个延迟 3 秒执行的方法，来模仿长业务线调用。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/timeOut"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">timeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"延迟响应"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> serverPort<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>客户端 8888 通过 OpenFeign 来进行调用</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//OpenFeginController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/testTimeout"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token class-name">TestTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> openFeginService<span class="token punctuation">.</span><span class="token function">timeOut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="测试结果-2"><a class="anchor" href="#测试结果-2">#</a> 测试结果</h3><p>客户端报错：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112195205208.png" title="image-20211112195205208"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112195244240.png" title="image-20211112195244240"><h2 id="设置超时控制案例演示"><a class="anchor" href="#设置超时控制案例演示">#</a> 设置超时控制案例演示</h2><p>首先我们需要在 8888 消费者端的 yml 文件中配置超时时间，因为 OpenFeign 本身整合了 Ribbon 所以，这里其实我们用的是 Ribbon 来配置</p><h3 id="yml"><a class="anchor" href="#yml">#</a> YML</h3><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8888</span></pre></td></tr><tr><td data-num="3"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    name<span class="token operator">:</span> nacos<span class="token operator">-</span>consumer<span class="token operator">-</span>openfegin</pre></td></tr><tr><td data-num="6"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>#设置feign客户端超时时间<span class="token punctuation">(</span><span class="token class-name">OpenFeign</span>默认支持ribbon<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>ribbon<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  #指的是建立连接所用的时间，适用于网络状况正常的情况下<span class="token punctuation">,</span>两端连接所用的时间</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token class-name">ReadTimeout</span><span class="token operator">:</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  #指的是建立连接后从服务器读取到可用资源所用的时间</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token class-name">ConnectTimeout</span><span class="token operator">:</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>management<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  endpoints<span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    web<span class="token operator">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      exposure<span class="token operator">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        include<span class="token operator">:</span> <span class="token char">'*'</span></pre></td></tr></table></figure><h3 id="测试结果-3"><a class="anchor" href="#测试结果-3">#</a> 测试结果</h3><p>正常响应</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112195615566.png" title="image-20211112195615566"><h2 id="openfeign日志打印"><a class="anchor" href="#openfeign日志打印">#</a> OpenFeign 日志打印</h2><h2 id="概念-5"><a class="anchor" href="#概念-5">#</a> 概念</h2><p>Feign 提供了日志打印功能，我们可以通过配置来调整日志级别，从而了解 Feign 中 Http 请求的细节。<br>简单理解，就是对 Feign 接口的调用情况进行监控和输出</p><p><strong>日志级别：</strong></p><ul><li><p>NONE：默认的，不显示任何日志；</p></li><li><p>BASIC：仅记录请求方法、URL、响应状态码及执行时间；</p></li><li><p>HEADERS：除了 BASIC 中定义的信息之外，还有请求和响应的头信息；</p></li><li><p>FULL：除了 HEADERS 中定义的信息之外，还有请求和响应的正文及元数据。</p></li></ul><h2 id="具体使用-2"><a class="anchor" href="#具体使用-2">#</a> 具体使用</h2><p>需要在启动类中通过 @Bean 注解注入 OpenFeign 的日志功能</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@EnableFeignClients</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloudalibabaOpenFeginConsumer8888Application</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CloudalibabaOpenFeginConsumer8888Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span> <span class="token function">feignLoggerLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 开启详细日志</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">Logger<span class="token punctuation">.</span>Level</span><span class="token punctuation">.</span><span class="token constant">FULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 yml 中配置中配置</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8888</span></pre></td></tr><tr><td data-num="3"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    name<span class="token operator">:</span> nacos<span class="token operator">-</span>consumer<span class="token operator">-</span>openfegin</pre></td></tr><tr><td data-num="6"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>#设置feign客户端超时时间<span class="token punctuation">(</span><span class="token class-name">OpenFeign</span>默认支持ribbon<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>ribbon<span class="token operator">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  #指的是建立连接所用的时间，适用于网络状况正常的情况下<span class="token punctuation">,</span>两端连接所用的时间</pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token class-name">ReadTimeout</span><span class="token operator">:</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  #指的是建立连接后从服务器读取到可用资源所用的时间</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token class-name">ConnectTimeout</span><span class="token operator">:</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>logging<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  level<span class="token operator">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    # openfeign日志以什么级别监控哪个接口</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mashibing<span class="token punctuation">.</span>cloudalibabaopenfeginconsumer8888<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span>OpenFeginService</span><span class="token operator">:</span> debug</pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>management<span class="token operator">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>  endpoints<span class="token operator">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    web<span class="token operator">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      exposure<span class="token operator">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        include<span class="token operator">:</span> <span class="token char">'*'</span></pre></td></tr></table></figure><p>测试效果，发起一次调用以后的日志内容：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211112201418950.png" title="image-20211112201418950"><h1 id="sentinel整合openfegin"><a class="anchor" href="#sentinel整合openfegin">#</a> Sentinel 整合 OpenFegin</h1><p>根据之前的学习，我们已经学习过了包括 Sentinel 整合 Ribbon，包括对 OpenFegin 的基本学习，那么这节课，我们就需要通过 Sentinel 来进行整合 OpenFegin</p><h2 id="引入openfegin"><a class="anchor" href="#引入openfegin">#</a> 引入 OpenFegin</h2><p>我们需要在当前的 8084 项目中引入对应的依赖</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>openfeign<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr></table></figure><p>激活 Sentinel 对 OpenFeign 的支持，所以配置 yml</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre># 激活<span class="token class-name">Sentinel</span>对<span class="token class-name">OpenFeign</span>的支持</pre></td></tr><tr><td data-num="2"></td><td><pre>feign<span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  sentinel<span class="token operator">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    enabled<span class="token operator">:</span> <span class="token boolean">true</span></pre></td></tr></table></figure><p>主启动类要添加 @EnableFeignClients 注解</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SpringBootApplication</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@EnableDiscoveryClient</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@EnableFeignClients</span><span class="token comment">// 注入 Feign</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CloudalibabaConsumer8084Application</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">CloudalibabaConsumer8084Application</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token annotation punctuation">@LoadBalanced</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">getRestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="openfegin接口编写"><a class="anchor" href="#openfegin接口编写">#</a> OpenFegin 接口编写</h2><p>这里我们的接口写法和之前保持一致，但是要注意，我们这里要多增加一个 FeignClient 的属性：</p><ul><li>fallback: 定义容错的处理类，当调用远程接口失败或超时时，会调用对应接口的容错逻辑，fallback 指定的类必须实现 @FeignClient 标记的接口</li></ul><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 当没有成功调用 /info/&#123;id&#125; 接口时会走 fallback 属性标注的类型的处理方法</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"nacos-provider"</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token class-name">FeignServiceImpl</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">FeignService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     * 远程调用对应方法</pre></td></tr><tr><td data-num="7"></td><td><pre>     */</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"info/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">msbSql</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>实现类必须添加 @Component 注解，否则无法注入到容器中</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FeignServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">FeignService</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">msbSql</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">,</span><span class="token string">"服务降级返回！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里完成后我们来编写控制器</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">FeignService</span> feignService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"getInfo/&#123;id&#125;"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">JsonResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">></span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"没有该id"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> feignService<span class="token punctuation">.</span><span class="token function">msbSql</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="测试-5"><a class="anchor" href="#测试-5">#</a> 测试</h2><p>此时如果我们访问 http://localhost:8084/getInfo/1 的地址，是没有问题的，但是如果此时我们人为结束 9003/9004 服务，这个时候就会触发 fallback 属性对应的处理类型，完成服务降级。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211115200122605.png" title="image-20211115200122605"><p>断开服务以后</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211115200243827.png" title="image-20211115200243827"><h1 id="sentinel持久化配置"><a class="anchor" href="#sentinel持久化配置">#</a> Sentinel 持久化配置</h1><p>我们首先需要知道：在 Sentinel Dashboard 中配置规则之后重启应用就会丢失，所以实际生产环境中需要配置规则的持久化实现，Sentinel 提供多种不同的数据源来持久化规则配置，包括 file，redis、nacos、zk。</p><h2 id="sentinel规则持久化到nacos"><a class="anchor" href="#sentinel规则持久化到nacos">#</a> Sentinel 规则持久化到 Nacos</h2><p>将限流规则持久化进 Nacos 保存，只要刷新 8401 某个接口地址，Sentinel 控制台的流控规则就能感应到，同时只要 Nacos 里面的配置不删除，针对 8401 上 Sentinel 的流控规则就持续有效。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211115204021997.png" title="image-20211115204021997"><p>其实就是实现 Sentinel Dashboard 与 Nacos 之间的相互通信</p><p>通过 Nacos 配置文件修改流控规则 --- 拉取 ---&gt;Sentinel Dashboard 界面显示最新的流控规则</p><p>** 注意：** 在 Nacos 控制台上修改流控制，虽然可以同步到 Sentinel Dashboard，但是 Nacos 此时应该作为一个流控规则的持久化平台，所以正常操作过程应该是开发者在 Sentinel Dashboard 上修改流控规则后同步到 Nacos，遗憾的是目前 Sentinel Dashboard 不支持该功能。</p><h2 id="具体操作-2"><a class="anchor" href="#具体操作-2">#</a> 具体操作</h2><p>第一件事情我们首先要引入依赖：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">></span></span>com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">></span></span>sentinel<span class="token operator">-</span>datasource<span class="token operator">-</span>nacos<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">></span></span><span class="token number">1.8</span><span class="token number">.1</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">></span></pre></td></tr></table></figure><p>第二件事情我们需要配置 YML</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre># 端口号</pre></td></tr><tr><td data-num="2"></td><td><pre>server<span class="token operator">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  port<span class="token operator">:</span> <span class="token number">8890</span></pre></td></tr><tr><td data-num="4"></td><td><pre># 服务名</pre></td></tr><tr><td data-num="5"></td><td><pre>spring<span class="token operator">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>  application<span class="token operator">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    name<span class="token operator">:</span> order</pre></td></tr><tr><td data-num="8"></td><td><pre>  cloud<span class="token operator">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      discovery<span class="token operator">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        # nacos注册中心地址</pre></td></tr><tr><td data-num="12"></td><td><pre>        server<span class="token operator">-</span>addr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    sentinel<span class="token operator">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      transport<span class="token operator">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        dashboard<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8080</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      datasource<span class="token operator">:</span> # 配置<span class="token class-name">Sentinel</span>的持久化</pre></td></tr><tr><td data-num="17"></td><td><pre>        nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          nacos<span class="token operator">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            serverAddr<span class="token operator">:</span> localhost<span class="token operator">:</span><span class="token number">8848</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            groupId<span class="token operator">:</span> <span class="token constant">DEFAULT_GROUP</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            dataId<span class="token operator">:</span> order<span class="token operator">-</span>sentinel<span class="token punctuation">.</span>json</pre></td></tr><tr><td data-num="22"></td><td><pre>            ruleType<span class="token operator">:</span> flow</pre></td></tr><tr><td data-num="23"></td><td><pre>  profiles<span class="token operator">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    active<span class="token operator">:</span> dev</pre></td></tr></table></figure><p>第三步我们需要进入到 Nacos 控制台，添加配置</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211116200354133.png" title="image-20211116200354133"><p>具体配置内容：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token punctuation">[</span>   </pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token string">"resource"</span><span class="token operator">:</span> <span class="token string">"test1"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token string">"limitApp"</span><span class="token operator">:</span> <span class="token string">"default"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token string">"grade"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token string">"count"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token string">"strategy"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token string">"controlBehavior"</span><span class="token operator">:</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>具体内容含义<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="12"></td><td><pre>resource：资源名称；</pre></td></tr><tr><td data-num="13"></td><td><pre>limitApp：来源应用；</pre></td></tr><tr><td data-num="14"></td><td><pre>grade：阈值类型，<span class="token number">0</span>表示线程数，<span class="token number">1</span>表示<span class="token constant">QPS</span>；</pre></td></tr><tr><td data-num="15"></td><td><pre>count：单机阈值；</pre></td></tr><tr><td data-num="16"></td><td><pre>strategy：流控模式，<span class="token number">0</span>表示直接，<span class="token number">1</span>表示关联，<span class="token number">2</span>表示链路；</pre></td></tr><tr><td data-num="17"></td><td><pre>controlBehavior：流控效果，<span class="token number">0</span>表示快速失败，<span class="token number">1</span>表示<span class="token class-name">Warm</span> <span class="token class-name">Up</span>，<span class="token number">2</span>表示排队等待；</pre></td></tr><tr><td data-num="18"></td><td><pre>clusterMode：是否集群。</pre></td></tr></table></figure><p>控制器</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/order/test1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"test1"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token string">"test1 "</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="测试-6"><a class="anchor" href="#测试-6">#</a> 测试</h2><p>当我们重启项目以后，我们访问对应接口 http://localhost:8890/order/test1，就会在 Sentinel 界面上看到对应的限流规则：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211116200654500.png" title="image-20211116200654500"><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结</h2><p>当我们配置成功之后我们每次访问接口的时候，我们都会从我们的仓库中去获取配置，有的话直接用，没有的话将持久化后的资源重新加入到 sentinel 配置中，在下一次的资源访问过程中就会经历这个判断。</p><div id="gitalk-container"></div><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalkConfig={clientID:"6db178ba46c8af8f6a6f",clientSecret:"90f730e5956024596558df00975cd8eae28cae3d",repo:"bk-comment01",owner:"onlymarryu",admin:["onlymarryu"],distractionFreeMode:!1,language:"zh-CN",proxy:"https://gitalk-comments.netlify.app/github_access_token",perPage:15};gitalkConfig.id=md5(location.pathname);var gitalk=new Gitalk(gitalkConfig);gitalk.render("gitalk-container")</script><div class="tags"><a href="/tags/spring-cloud-alibaba/" rel="tag"><i class="ic i-tag"></i> spring-cloud-alibaba</a> <a href="/tags/sentinel/" rel="tag"><i class="ic i-tag"></i> sentinel</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-07-10 22:05:12" itemprop="dateModified" datetime="2023-07-10T22:05:12+08:00">2023-07-10</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="雾都 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="雾都 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="雾都 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>雾都 <i class="ic i-at"><em>@</em></i>每天进步一点点，就是成功的开始</li><li class="link"><strong>本文链接：</strong> <a href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" title="Sentinel 系统学习">https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel系统学习/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Spring_Family/spring-cloud-alibaba/Nacos%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;api.yimian.xyz&#x2F;img?572196" title="Nacos系统学习"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务</span><h3>Nacos系统学习</h3></a></div><div class="item right"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;api.yimian.xyz&#x2F;img?870462" title="Sentinel源码系统学习"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务</span><h3>Sentinel源码系统学习</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">Sentinel 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFsentinel"><span class="toc-number">1.1.</span> <span class="toc-text">什么是 Sentinel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E5%A5%BD%E5%A4%84"><span class="toc-number">1.2.</span> <span class="toc-text">Sentinel 好处</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E4%B8%8B%E8%BD%BD%E5%92%8C%E5%AE%89%E8%A3%85"><span class="toc-number">1.3.</span> <span class="toc-text">Sentinel 下载和安装</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E5%88%9D%E5%A7%8B%E5%8C%96%E7%9B%91%E6%8E%A7"><span class="toc-number">2.</span> <span class="toc-text">Sentinel 初始化监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E5%88%9D%E5%A7%8B%E5%8C%96%E5%B7%A5%E7%A8%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">2.1.</span> <span class="toc-text">Sentinel 初始化工程演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAsentinel%E9%A1%B9%E7%9B%AE"><span class="toc-number">2.2.</span> <span class="toc-text">搭建 Sentinel 项目</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">3.</span> <span class="toc-text">Sentinel 流控规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.1.</span> <span class="toc-text">流控规则基本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">3.2.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="toc-number">3.3.</span> <span class="toc-text">具体操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E6%B5%81%E6%8E%A7"><span class="toc-number">3.3.1.</span> <span class="toc-text">新增流控</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99-%E5%85%B3%E8%81%94"><span class="toc-number">4.</span> <span class="toc-text">流控规则 - 关联</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-2"><span class="toc-number">4.1.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E8%81%94"><span class="toc-number">4.2.</span> <span class="toc-text">关联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%BC%94%E7%A4%BA"><span class="toc-number">4.3.</span> <span class="toc-text">具体演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99-%E9%93%BE%E8%B7%AF"><span class="toc-number">5.</span> <span class="toc-text">流控规则 - 链路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-3"><span class="toc-number">5.1.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%93%BE%E8%B7%AF"><span class="toc-number">5.2.</span> <span class="toc-text">链路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%BC%94%E7%A4%BA-2"><span class="toc-number">5.3.</span> <span class="toc-text">具体演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C-%E9%A2%84%E7%83%AD"><span class="toc-number">6.</span> <span class="toc-text">Sentinel 流控效果 - 预热</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-4"><span class="toc-number">6.1.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%84%E7%83%AD"><span class="toc-number">6.2.</span> <span class="toc-text">预热</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-number">6.3.</span> <span class="toc-text">案例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C-%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">7.</span> <span class="toc-text">Sentinel 流控效果 - 排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A-5"><span class="toc-number">7.1.</span> <span class="toc-text">名词解释</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E9%98%9F%E7%AD%89%E5%BE%85"><span class="toc-number">7.2.</span> <span class="toc-text">排队等待</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%80%E9%80%9F%E5%99%A8"><span class="toc-number">7.2.1.</span> <span class="toc-text">匀速器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%94%E7%A4%BA"><span class="toc-number">7.3.</span> <span class="toc-text">演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7%E7%AE%80%E4%BB%8B"><span class="toc-number">8.</span> <span class="toc-text">Sentinel 熔断降级简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">8.1.</span> <span class="toc-text">基本概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E9%99%8D%E7%BA%A7"><span class="toc-number">8.1.1.</span> <span class="toc-text">服务降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD"><span class="toc-number">8.1.2.</span> <span class="toc-text">服务熔断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.2.</span> <span class="toc-text">基本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="toc-number">8.3.</span> <span class="toc-text">熔断策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E8%A7%84%E5%88%99"><span class="toc-number">8.4.</span> <span class="toc-text">熔断规则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-number">9.</span> <span class="toc-text">Sentinel 熔断策略 - 慢调用比例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%85%A2%E8%B0%83%E7%94%A8%E6%AF%94%E4%BE%8B"><span class="toc-number">9.1.</span> <span class="toc-text">慢调用比例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">9.2.</span> <span class="toc-text">案例演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-2"><span class="toc-number">9.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-number">10.</span> <span class="toc-text">Sentinel 熔断策略 - 异常比例</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%AF%94%E4%BE%8B"><span class="toc-number">10.1.</span> <span class="toc-text">异常比例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B-2"><span class="toc-number">10.2.</span> <span class="toc-text">案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-3"><span class="toc-number">10.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5-%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">11.</span> <span class="toc-text">Sentinel 熔断策略 - 异常数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E6%95%B0"><span class="toc-number">11.1.</span> <span class="toc-text">异常数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-2"><span class="toc-number">11.2.</span> <span class="toc-text">案例演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-4"><span class="toc-number">11.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E4%B8%8A"><span class="toc-number">12.</span> <span class="toc-text">Sentinel 热点规则（上）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">12.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8sentinelresource%E6%B3%A8%E8%A7%A3"><span class="toc-number">12.2.</span> <span class="toc-text">使用 @SentinelResource 注解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E8%AE%B2%E8%A7%A3"><span class="toc-number">12.3.</span> <span class="toc-text">案例讲解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinelresourcevaluexxx"><span class="toc-number">12.3.1.</span> <span class="toc-text">@SentinelResource(value&#x3D;&quot;xxx&quot;)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sentinelresourcevaluexxxblockhandlerxxx"><span class="toc-number">12.3.2.</span> <span class="toc-text">@SentinelResource(value&#x3D;&quot;xxx&quot;,blockHandler&#x3D;&quot;xxx&quot;)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel-%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99%E4%B8%8B"><span class="toc-number">13.</span> <span class="toc-text">Sentinel 热点规则（下）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-2"><span class="toc-number">13.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E4%BE%8B%E5%A4%96%E9%A1%B9"><span class="toc-number">13.2.</span> <span class="toc-text">参数例外项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-3"><span class="toc-number">13.3.</span> <span class="toc-text">案例演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel-%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-number">14.</span> <span class="toc-text">Sentinel 系统规则</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="toc-number">14.1.</span> <span class="toc-text">系统规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-4"><span class="toc-number">14.2.</span> <span class="toc-text">案例演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinelresource-%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E9%80%BB%E8%BE%91%E5%A4%84%E7%90%86"><span class="toc-number">15.</span> <span class="toc-text">@SentinelResource 自定义限流逻辑处理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%A4%8D%E4%B9%A0"><span class="toc-number">15.1.</span> <span class="toc-text">案例复习</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinelresource-%E8%B5%84%E6%BA%90%E9%99%90%E6%B5%81"><span class="toc-number">15.2.</span> <span class="toc-text">@SentinelResource 资源限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinelresource-url%E9%99%90%E6%B5%81"><span class="toc-number">15.3.</span> <span class="toc-text">@SentinelResource URL 限流</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E8%AE%BA"><span class="toc-number">15.4.</span> <span class="toc-text">结论</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%99%90%E6%B5%81%E5%A4%84%E7%90%86%E9%80%BB%E8%BE%91"><span class="toc-number">15.5.</span> <span class="toc-text">自定义限流处理逻辑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E9%80%BB%E8%BE%91"><span class="toc-number">15.5.1.</span> <span class="toc-text">具体逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="toc-number">15.5.2.</span> <span class="toc-text">对应关系图</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%9C%8D%E5%8A%A1%E7%86%94%E6%96%AD%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">16.</span> <span class="toc-text">Sentinel 服务熔断环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">16.1.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloudalibaba-provider-90039004"><span class="toc-number">16.1.1.</span> <span class="toc-text">新建 cloudalibaba-provider-9003&#x2F;9004</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BAcloudalibaba-consumer8084"><span class="toc-number">16.1.2.</span> <span class="toc-text">新建 cloudalibaba-consumer8084</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E%E6%B5%8B%E8%AF%95"><span class="toc-number">16.2.</span> <span class="toc-text">最后测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinelresource%E7%9A%84fallback%E5%B1%9E%E6%80%A7"><span class="toc-number">17.</span> <span class="toc-text">SentinelResource 的 fallback 属性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#fallback%E5%B1%9E%E6%80%A7"><span class="toc-number">17.1.</span> <span class="toc-text">fallback 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-5"><span class="toc-number">17.2.</span> <span class="toc-text">案例演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%97%B6%E9%85%8D%E7%BD%AEblockhandler%E5%92%8Cfallback%E5%B1%9E%E6%80%A7"><span class="toc-number">17.3.</span> <span class="toc-text">同时配置 blockHandler 和 fallback 属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA-6"><span class="toc-number">17.4.</span> <span class="toc-text">案例演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exceptionstoignore%E5%B1%9E%E6%80%A7"><span class="toc-number">17.5.</span> <span class="toc-text">exceptionsToIgnore 属性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#openfeign%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8"><span class="toc-number">18.</span> <span class="toc-text">OpenFeign 基础应用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-3"><span class="toc-number">18.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openfeign%E8%83%BD%E5%B9%B2%E4%BB%80%E4%B9%88"><span class="toc-number">18.2.</span> <span class="toc-text">OpenFeign 能干什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%BD%BF%E7%94%A8"><span class="toc-number">18.3.</span> <span class="toc-text">具体使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom"><span class="toc-number">18.3.1.</span> <span class="toc-text">pom</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#javalangillegalstateexception-no-feign-client-for-loadbalancing-defined-did-you-forget-to-include-spring-cloud-starter-loadbalancer"><span class="toc-number">18.3.2.</span> <span class="toc-text">java.lang.IllegalStateException: No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-loadbalancer?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#yml%E9%85%8D%E7%BD%AE"><span class="toc-number">18.3.3.</span> <span class="toc-text">YML 配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%90%AF%E5%8A%A8%E4%B8%AD%E6%B7%BB%E5%8A%A0%E6%B3%A8%E8%A7%A3"><span class="toc-number">18.3.4.</span> <span class="toc-text">主启动中添加注解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E8%80%85%E5%AF%B9%E5%A4%96%E6%8F%90%E4%BE%9B%E6%8E%A5%E5%8F%A3"><span class="toc-number">18.3.5.</span> <span class="toc-text">调用服务提供者对外提供接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">18.3.6.</span> <span class="toc-text">控制器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="toc-number">18.4.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#openfeign%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4%E6%8E%A7%E5%88%B6"><span class="toc-number">19.</span> <span class="toc-text">OpenFeign 超时时间控制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-4"><span class="toc-number">19.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95"><span class="toc-number">19.2.</span> <span class="toc-text">解决办法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B6%85%E6%97%B6%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">19.3.</span> <span class="toc-text">超时案例演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-2"><span class="toc-number">19.3.1.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%B6%85%E6%97%B6%E6%8E%A7%E5%88%B6%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">19.4.</span> <span class="toc-text">设置超时控制案例演示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#yml"><span class="toc-number">19.4.1.</span> <span class="toc-text">YML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C-3"><span class="toc-number">19.4.2.</span> <span class="toc-text">测试结果</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openfeign%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0"><span class="toc-number">19.5.</span> <span class="toc-text">OpenFeign 日志打印</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-5"><span class="toc-number">19.6.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E4%BD%BF%E7%94%A8-2"><span class="toc-number">19.7.</span> <span class="toc-text">具体使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%95%B4%E5%90%88openfegin"><span class="toc-number">20.</span> <span class="toc-text">Sentinel 整合 OpenFegin</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%85%A5openfegin"><span class="toc-number">20.1.</span> <span class="toc-text">引入 OpenFegin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openfegin%E6%8E%A5%E5%8F%A3%E7%BC%96%E5%86%99"><span class="toc-number">20.2.</span> <span class="toc-text">OpenFegin 接口编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-5"><span class="toc-number">20.3.</span> <span class="toc-text">测试</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%8C%81%E4%B9%85%E5%8C%96%E9%85%8D%E7%BD%AE"><span class="toc-number">21.</span> <span class="toc-text">Sentinel 持久化配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96%E5%88%B0nacos"><span class="toc-number">21.1.</span> <span class="toc-text">Sentinel 规则持久化到 Nacos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B7%E4%BD%93%E6%93%8D%E4%BD%9C-2"><span class="toc-number">21.2.</span> <span class="toc-text">具体操作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95-6"><span class="toc-number">21.3.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">21.4.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Spring_Family/spring-cloud-alibaba/Nacos%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Nacos系统学习">Nacos系统学习</a></li><li class="active"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Sentinel系统学习">Sentinel系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Sentinel源码系统学习">Sentinel源码系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Gateway%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Gateway系统学习">Gateway系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Seata%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Seata系统学习">Seata系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Problem/%E5%85%B3%E4%BA%8E%E5%85%B3%E4%BA%8ENacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%9A%84%E9%85%8D%E7%BD%AE/" rel="bookmark" title="关于关于Nacos配置中心的配置">关于关于Nacos配置中心的配置</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Problem/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E9%A1%BA%E5%BA%8F/" rel="bookmark" title="微服务加载配置顺序">微服务加载配置顺序</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="雾都" data-src="/images/avatar.jpg"><p class="name" itemprop="name">雾都</p><div class="description" itemprop="description">花非花，雾非雾</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">85</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">30</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29ubHltYXJyeXU=" title="https:&#x2F;&#x2F;github.com&#x2F;onlymarryu"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvbXkvbS9tdXNpYy9wbGF5bGlzdD9pZD0zMTY2MDYwNzkw" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;my&#x2F;m&#x2F;music&#x2F;playlist?id&#x3D;3166060790"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>时间轴</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/toolPage/" rel="section"><i class="ic i-feather"></i>常用工具设置技巧</a></li><li class="item"><a href="/projectBuild/" rel="section"><i class="ic i-th"></i>SpringBoot常用配置</a></li></ul></li><li class="item"><a href="/mianshi/" rel="section"><i class="ic i-calendar"></i>面试</a></li><li class="item"><a href="/study/" rel="section"><i class="ic i-sakura"></i>小实验</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-calendar"></i>留言</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Spring_Family/spring-cloud-alibaba/Nacos%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/SpringSecurity/" title="SpringSecurity">SpringSecurity</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaSE/" title="分类于 JavaSE">JavaSE</a></div><span><a href="/Java/%E7%AC%AC13%E7%AB%A0%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="第13章多线程">第13章多线程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaSE/" title="分类于 JavaSE">JavaSE</a></div><span><a href="/Java/%E7%AC%AC7%E7%AB%A0_IDEA%E7%9A%84%E4%BD%BF%E7%94%A8/" title="第7章_IDEA的使用">第7章_IDEA的使用</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" title="分类于 微服务">微服务</a></div><span><a href="/Spring_Family/spring-cloud-alibaba/Problem/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E9%A1%BA%E5%BA%8F/" title="微服务加载配置顺序">微服务加载配置顺序</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/toolsPage/VsCode/" title="VsCode常用插件和配置方案">VsCode常用插件和配置方案</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/JavaSE/" title="分类于 JavaSE">JavaSE</a></div><span><a href="/Java/%E7%AC%AC1%E7%AB%A0%E5%88%9D%E8%AF%86JAVA/" title="第1章初识JAVA">第1章初识JAVA</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B0%8F%E5%AE%9E%E9%AA%8C/" title="分类于 小实验">小实验</a></div><span><a href="/study/develop/hexo-shoka/" title="hexo_shoka">hexo_shoka</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%89%8D%E7%AB%AF/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%89%8D%E7%AB%AF/%E6%A1%86%E6%9E%B6/" title="分类于 框架">框架</a></div><span><a href="/Web-anteriore/Vue2-3/vue3%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" title="Vue3">Vue3</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/" title="分类于 分布式">分布式</a></div><span><a href="/Distribution/FastDFS/" title="FastDFS">FastDFS</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" title="分类于 微服务">微服务</a></div><span><a href="/Spring_Family/spring-cloud-alibaba/Seata%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" title="Seata系统学习">Seata系统学习</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">雾都 @ 雾都博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.5m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">22:43</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Spring_Family/spring-cloud-alibaba/Sentinel系统学习/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(i){return i.includes("#")},function(i){return new RegExp(LOCAL.path+"$").test(i)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>