<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="每天进步一点点，就是成功的开始" href="https://eth168.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="每天进步一点点，就是成功的开始" href="https://eth168.top/atom.xml"><link rel="alternate" type="application/json" title="每天进步一点点，就是成功的开始" href="https://eth168.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="spring-cloud-alibaba,sentinel"><link rel="canonical" href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"><title>Sentinel 源码系统学习 - 微服务 | 雾都博客 = 每天进步一点点，就是成功的开始</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Sentinel 源码系统学习</h1><div class="meta"><span class="item" title="创建时间：2023-07-10 21:53:51"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-07-10T21:53:51+08:00">2023-07-10</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>48k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>44 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">雾都博客</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://api.yimian.xyz/img?607804"></li><li class="item" data-background-image="https://api.yimian.xyz/img?28350"></li><li class="item" data-background-image="https://api.yimian.xyz/img?485914"></li><li class="item" data-background-image="https://api.yimian.xyz/img?399172"></li><li class="item" data-background-image="https://api.yimian.xyz/img?586498"></li><li class="item" data-background-image="https://api.yimian.xyz/img?547852"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="item" rel="index" title="分类于 微服务"><span itemprop="name">微服务</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="雾都"><meta itemprop="description" content=", 花非花，雾非雾"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="每天进步一点点，就是成功的开始"></span><div class="body md" itemprop="articleBody"><h1 id="sentinel核心源码分析-课程开篇"><a class="anchor" href="#sentinel核心源码分析-课程开篇">#</a> Sentinel 核心源码分析 - 课程开篇</h1><p>Sentinel 是分布式系统的防御系统。以流量为切入点，通过动态设置的流量控制、服务熔断等手段达到 保护系统的目的，通过服务降级增强服务被拒后用户的体验。</p><h2 id="sentinel工作原理"><a class="anchor" href="#sentinel工作原理">#</a> Sentinel 工作原理</h2><p><strong>ProcessorSlotChain</strong></p><p>Sentinel 的核心骨架，将不同的 Slot 按照顺序串在一起（责任链模式），从而将不同的功能（限流、降级、系统保护）组合在一起。slot chain 其实可以分为两部分：统计数据构建部分（statistic）和判断部分（rule checking）。核心结构</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/sentinel-slot-chain-architecture.png" title="arch overview"><p>Sentinel 将 <code>ProcessorSlot</code> 作为 SPI 接口进行扩展，使得 Slot Chain 具备了扩展的能力。您可以自行加入自定义的 slot 并编排 slot 间的顺序，从而可以给 Sentinel 添加自定义的功能。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/46783631-93324d00-cd5d-11e8-8ad1-a802bcc8f9c9.png" title="Slot Chain SPI"><h2 id="官方版本说明"><a class="anchor" href="#官方版本说明">#</a> 官方版本说明</h2><p>通过官方网站我们可以看到现在应该使用的 Sentinel 版本，通过官方的要求我们下载对应版本的 Sentinel 源码：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvc3ByaW5nLWNsb3VkLWFsaWJhYmEvd2lraS8lRTclODklODglRTYlOUMlQUMlRTglQUYlQjQlRTYlOTglOEU=">https://github.com/alibaba/spring-cloud-alibaba/wiki/ 版本说明</span></p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211116203605431.png" title="image-20211116203605431"><h2 id="sentinel源码下载"><a class="anchor" href="#sentinel源码下载">#</a> Sentinel 源码下载</h2><p>下载地址：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvU2VudGluZWwvdHJlZS9yZWxlYXNlLTEuOA==">https://github.com/alibaba/Sentinel/tree/release-1.8</span></p><p>下载方式，我们可以下载 zip 包，也可以直接通过 idea 进行下载和打开</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211116203821710.png" title="image-20211116203821710"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211116203908000.png" title="image-20211116203908000"><h1 id="sentinel核心概念"><a class="anchor" href="#sentinel核心概念">#</a> Sentinel 核心概念</h1><p>Sentinel 作为 ali 开源的一款轻量级流控框架，<strong>主要以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度来帮助用户保护服务的稳定性</strong>。相比于 Hystrix，Sentinel 的设计更加简单，在 Sentinel 中资源定义和规则配置是分离的，也就是说用户可以先通过 Sentinel API 给对应的业务逻辑定义资源（埋点），然后在需要的时候再配置规则，通过这种组合方式，极大的增加了 Sentinel 流控的灵活性。</p><p>引入 Sentinel 带来的性能损耗非常小。只有在业务单机量级超过 25W QPS 的时候才会有一些显著的影响（5% - 10% 左右），单机 QPS 不太大的时候损耗几乎可以忽略不计。</p><p>Sentinel 提供两种埋点方式：</p><ul><li><p>try-catch 方式（通过 SphU.entry (...)），用户在 catch 块中执行异常处理</p></li><li><p>if-else 方式（通过 SphO.entry (...)），当返回 false 时执行异常处理</p></li></ul><h2 id="工作流程"><a class="anchor" href="#工作流程">#</a> 工作流程</h2><p>在此之前，需要先了解一下 Sentinel 的工作流程</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/sentinel-slot-chain-architecture.png" title="sentinel-slot-chain-architecture"><p>在 Sentinel 里面，所有的资源都对应一个资源名称（resourceName），每次资源调用都会创建一个 Entry 对象。Entry 可以通过对主流框架的适配自动创建，也可以通过注解的方式或调用 SphU API 显式创建。Entry 创建的时候，同时也会创建一系列功能插槽（slot chain），这些插槽有不同的职责，例如默认情况下会创建一下 7 个插槽：</p><ul><li>NodeSelectorSlot 负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级；</li><li>ClusterBuilderSlot 则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据，对应簇点链路；</li><li>StatisticSlot 则用于记录、统计不同纬度的 runtime 指标监控信息；</li><li>FlowSlot 则用于根据预设的限流规则以及前面 slot 统计的状态，来进行流量控制，对应流控规则；</li><li>AuthoritySlot 则根据配置的黑白名单和调用来源信息，来做黑白名单控制，对应授权规则；</li><li>DegradeSlot 则通过统计信息以及预设的规则，来做熔断降级，对应熔断规则；</li><li>SystemSlot 则通过系统的状态，例如 load1 等，来控制总的入口流量，对应系统规则；</li></ul><p>重要的概念：</p><ul><li>slot chain：插槽</li><li>Node：根节点</li><li>Context：对资源操作时的上下文环境，每个资源操作 ( <code>针对Resource进行的entry/exit</code> ) 必须属于一个 Context，如果程序中未指定 Context，会创建 name 为 &quot;sentinel_default_context&quot; 的默认 Context。一个 Context 生命周期内可能有多个资源操作，Context 生命周期内的最后一个资源 exit 时会清理该 Context，这也预示这真个 Context 生命周期的结束。</li><li>Entry：表示一次资源操作，内部会保存当前调用信息。在一个 Context 生命周期中多次资源操作，也就是对应多个 Entry，这些 Entry 形成 parent/child 结构保存在 Entry 实例中</li></ul><h2 id="官方案例演示"><a class="anchor" href="#官方案例演示">#</a> 官方案例演示</h2><p>我们先从官方文档提供的演示代码来进行分析</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211118223922490.png" title="image-20211118223922490"><p>我们来改写一下，如果只有一个资源情况如下</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span></span><span class="token class-name">Entry</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span></span><span class="token class-name">SphU</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ContextUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span></span><span class="token class-name">BlockException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 创建一个来自 appA 访问的 Context</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">//Context 的名称为 entrance1</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">"entrance1"</span><span class="token punctuation">,</span> <span class="token string">"appA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// Entry 就是一个资源操作对象</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">Entry</span> nodeA <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 获取资源 resource 的 entry</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            nodeA <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 后续会展开这个位置</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，说明当前资源的请求通过了流控，可以继续进行相关业务处理</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 如果没有通过走到了这里，就表示请求被限流，这里进行降级操作</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeA <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                nodeA<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// 释放 Context</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>多个资源的情况</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        <span class="token comment">// 创建一个来自 appA 访问的 Context</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token comment">//Context 的名称为 entrance1</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">"entrance1"</span><span class="token punctuation">,</span> <span class="token string">"appA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// Entry 就是一个资源操作对象</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">Entry</span> nodeA <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">Entry</span> nodeB <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token comment">// 获取资源 resource1 的 entry</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            nodeA <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，说明当前资源的请求通过了流控，可以继续进行相关业务处理</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token comment">// 获取资源 resource2 的 entry</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            nodeB <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，说明当前资源的请求通过了流控，可以继续进行相关业务处理</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 如果没有通过走到了这里，就表示请求被限流，这里进行降级操作</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeA <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                nodeA<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeB <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                nodeB<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 释放 Context</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码解析-node之间的关系"><a class="anchor" href="#sentinel源码解析-node之间的关系">#</a> Sentinel 源码解析 - Node 之间的关系</h1><p>在上节课我们通过官方演示代码，搞清楚一个 Context 之中，Resource 和 Entry 的关系，一个 Context 中可以有多个 Resource，每个资源都必须都应一个 Entry，这节课我们来研究一下 Node 之间的关系</p><h2 id="node-关系官方图解"><a class="anchor" href="#node-关系官方图解">#</a> Node 关系官方图解</h2><p>这张图的上班部分其实体现了 Node 之间的关系，官方提供的图不够明显，我们需要进行细化</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/sentinel-slot-chain-architecture.png" title="sentinel-slot-chain-architecture"><p>要先理解这个官方提供的图，我们需要看一下源码的关系</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211119175902973.png" title="image-20211119175902973"><p>从这张图片我们能够提取出几个 Node：</p><ul><li>Node：接口，Sentinel 里面的各种种类的统计节点</li><li>StatisticNode：统计节点，是 Node 的实现类，用于完成数据统计</li><li>EntranceNode：DefaultNode 的子类，入口节点，一个 Context 会有一个入口节点，用于统计当前 Context 的总体流量数据，统计维度为 Context</li><li>DefaultNode：默认节点，用于统计一个 resource 在当前 Context 中的流量数据，DefaultNode 持有指定的 Context 和指定的 Resource 的统计数据，意味着 DefaultNode 是以 Context 和 Resource 为维度的统计节点</li><li>ClusterNode：ClusterNode 保存的是同一个 Resource 的相关的统计信息，是以 Resource 为维度的，不区分 Context，这个是和 DefaultNode 的区别</li></ul><h2 id="node之间的关系"><a class="anchor" href="#node之间的关系">#</a> Node 之间的关系</h2><p>Node 接口定义了一个 Node 类所需要提供的各项指标数据统计的相关功能，为外部屏蔽滑动窗口的存在。提供记录请求被拒绝、请求被放行、请求处理异常、请求处理成功的方法，以及获取当前时间窗口统计的请求总数、平均耗时等方法。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211123135428060.png" title="image-20211123135428060"><h2 id="案例代码改进"><a class="anchor" href="#案例代码改进">#</a> 案例代码改进</h2><p>昨天我们通过官方提供的演示案例写一个演示代码，那么我们为了理解这个 Node 之间的关系，我们再来增加一些代码，为了理解 Node 之间的关系</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 增加一个 Context</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">demo</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span></span><span class="token class-name">Entry</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span></span><span class="token class-name">Sph</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span></span><span class="token class-name">SphU</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>context<span class="token punctuation">.</span></span><span class="token class-name">ContextUtil</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span></span><span class="token class-name">BlockException</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ContextDemo</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 创建一个来自 appA 访问的 Context</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// Context 的名称为 entrance1</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">"entrance1"</span><span class="token punctuation">,</span> <span class="token string">"appA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// Entry 就是一个资源操作对象</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">Entry</span> nodeA <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Entry</span> nodeB <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token comment">// 获取资源 resource 的 entry</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            nodeA <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 后续会展开这个位置</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，就说明当前请求通过了流控，可以继续记性相关业务处理</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            nodeB <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，就说明当前请求通过了流控，可以继续记性相关业务处理</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 如果没有通过走到了这里，就表示请求被限流，这里进行降级操作</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeA <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                nodeA<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeB <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                nodeB<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token comment">// 释放 Context</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>       <span class="token comment">//--------------------- 创建另一个来自 appA 访问的 Context------------------------------</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 创建一个来自 appA 访问的 Context</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token comment">// Context 的名称为 entrance1</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span><span class="token string">"entrance2"</span><span class="token punctuation">,</span> <span class="token string">"appA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// Entry 就是一个资源操作对象</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token class-name">Entry</span> nodeC <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            nodeB <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>            <span class="token comment">// 如果代码走到这个位置，就说明当前请求通过了流控，可以继续记性相关业务处理</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            nodeC <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span><span class="token string">"resource3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token comment">// 如果没有通过走到了这里，就表示请求被限流，这里进行降级操作</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeB <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                nodeB<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>nodeC <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                nodeC<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token comment">// 释放 Context</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码解析-源码入口"><a class="anchor" href="#sentinel源码解析-源码入口">#</a> Sentinel 源码解析 - 源码入口</h1><h2 id="分析入口"><a class="anchor" href="#分析入口">#</a> 分析入口</h2><p>在微服务的使用 Sentinel 实际工作场景中，我们只需要引入对应依赖：spring-cloud-starter-alibaba-sentinel，就会进行自动装配，所以我们之间看 META-INF/spring.factories，然后我们这里从 SentinelAutoConfiguration 开始看起</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211123175158774.png" title="image-20211123175158774"><p>为了我们方便跟踪，我们在找到这个类型以后，直接通过源码进行查看，然后在这个类型中我们要找到以下代码，之前我们就说过 Sentinel 是通过 AOP 的方式进行切入的，从这里我们看到了 Aspect 关键字，所以我们就从这里跟进去</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@ConditionalOnMissingBean</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">SentinelResourceAspect</span> <span class="token function">sentinelResourceAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SentinelResourceAspect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>跟进去以后，我们就会发现这里就是再利用 AOP 通过 @SentinelResource 为注解来作为切入点，进行切入</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Aspect</span> <span class="token comment">// 切面</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SentinelResourceAspect</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractSentinelAspectSupport</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 指定切入点为 SentinelResource 注解</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">"@annotation(com.alibaba.csp.sentinel.annotation.SentinelResource)"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sentinelResourceAnnotationPointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>再往下跟我们会发现，还有 @Around 注解进行环绕通知，根据我们之前学习的知道我们从这里可以得知，其实这就是是利用 @SentinelResource 注解作为切点，然后在通过 AOP 环绕通知，来进行增强，在执行原方法前，来执行对应操作，当然这里我们可以看出，一旦出现了限流或者限流就会走 BlockException。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 环绕通知</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"sentinelResourceAnnotationPointcut()"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invokeResourceWithSentinel</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> pjp<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Method</span> originMethod <span class="token operator">=</span> <span class="token function">resolveMethod</span><span class="token punctuation">(</span>pjp<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">SentinelResource</span> annotation <span class="token operator">=</span> originMethod<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">SentinelResource</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>annotation <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// Should not go through here.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Wrong state for SentinelResource annotation"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">String</span> resourceName <span class="token operator">=</span> <span class="token function">getResourceName</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> originMethod<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">EntryType</span> entryType <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">entryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">int</span> resourceType <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">resourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 创建资源操作对象</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        entry <span class="token operator">=</span> <span class="token class-name">SphU</span><span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">,</span> resourceType<span class="token punctuation">,</span> entryType<span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 调用原方法</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> pjp<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">handleBlockException</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Throwable</span><span class="token punctuation">></span></span><span class="token punctuation">[</span><span class="token punctuation">]</span> exceptionsToIgnore <span class="token operator">=</span> annotation<span class="token punctuation">.</span><span class="token function">exceptionsToIgnore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// The ignore list will be checked first.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>exceptionsToIgnore<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">exceptionBelongsTo</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> exceptionsToIgnore<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">exceptionBelongsTo</span><span class="token punctuation">(</span>ex<span class="token punctuation">,</span> annotation<span class="token punctuation">.</span><span class="token function">exceptionsToTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token function">traceException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">handleFallback</span><span class="token punctuation">(</span>pjp<span class="token punctuation">,</span> annotation<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// No fallback function can handle the exception, so throw it out.</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">throw</span> ex<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            entry<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> pjp<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在以上的这段代码中还有一个问题，我们在之前就说过，在创建资源操作对象的时候我们需要先创建 Context，但是明显这里没有显示创建，但是实际上我们如果看 Context 概念的话，就会知道，如果程序中未指定 Context，会创建 name 为 &quot;sentinel_default_context&quot; 的默认 Context，然后我们继续往下跟踪。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Entry</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> resourceType<span class="token punctuation">,</span> <span class="token class-name">EntryType</span> trafficType<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 限流方法</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token class-name">Env</span><span class="token punctuation">.</span>sph<span class="token punctuation">.</span><span class="token function">entryWithType</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> resourceType<span class="token punctuation">,</span> trafficType<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>进入到 entry 方法中，这里的 entryWithType 方法就是我们要看的真正的限流的方法，具体的实现方法在<strong> com.alibaba.csp.sentinel.CtSph.entryWithType</strong></p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Entry</span> <span class="token function">entryWithType</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> resourceType<span class="token punctuation">,</span> <span class="token class-name">EntryType</span> entryType<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">entryWithType</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> resourceType<span class="token punctuation">,</span> entryType<span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Entry</span> <span class="token function">entryWithType</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> resourceType<span class="token punctuation">,</span> <span class="token class-name">EntryType</span> entryType<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                           <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 这里将资源的名称和信息封装称为资源对象</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">StringResourceWrapper</span> resource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> entryType<span class="token punctuation">,</span> resourceType<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 返回一个 Entry 资源操作对象</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">//prioritized 属性表示优先级，默认值为 false，表示当前请求不按照优先级执行，直接执行</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">entryWithPriority</span><span class="token punctuation">(</span>resource<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>我们接下来来具体分析核心方法 entryWithPriority</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">Entry</span> <span class="token function">entryWithPriority</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 从当前线程中获取 Context</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 一个请求会占用一个线程，并且绑定一个 Context</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Context</span> context <span class="token operator">=</span> <span class="token class-name">ContextUtil</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 一个请求对应一个 Context</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   	<span class="token comment">// 如果当前类型为 NullContext，表示此时请求已经超出了阈值，无需检测规则</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token keyword">instanceof</span> <span class="token class-name">NullContext</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// The &#123;@link NullContext&#125; indicates that the amount of context has exceeded the threshold,</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// so here init the entry only. No rule checking will be done.</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 此时如果获取 Context 为空，就创建默认的 sentinel_default_context，并且会放入到当前线程中</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// Using default context.</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        context <span class="token operator">=</span> <span class="token class-name">InternalContextUtil</span><span class="token punctuation">.</span><span class="token function">internalEnter</span><span class="token punctuation">(</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">CONTEXT_DEFAULT_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 判断全局开关，如果是关闭状态，直接返回无需检测规则</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// Global switch is close, no rule checking will do.</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ON</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>     * 这里是整个架构的核心所在，这里是在构建一个处理链，这个处理链是一个单向链表结构，类似于 Filter 一样，构建这个链条的</pre></td></tr><tr><td data-num="27"></td><td><pre>     * 原因是对业务进行解耦，像限流资源保护有很多，比如限流、降级、热点参数、系统降级等等，如果都写在一起就耦合很严重，我们知道 oop 的</pre></td></tr><tr><td data-num="28"></td><td><pre>     * 思想就是让每个类确定各自的职责，不要让他做不相干的事情，所以这里将业务进行全面解耦，然后在解耦的同时又通过链式编程将它们串起来</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> chain <span class="token operator">=</span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="33"></td><td><pre>         * Means amount of resources (slot chain) exceeds &#123;@link Constants.MAX_SLOT_CHAIN_SIZE&#125;,</pre></td></tr><tr><td data-num="34"></td><td><pre>         * so no rule checking will be done.</pre></td></tr><tr><td data-num="35"></td><td><pre>         */</pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token class-name">Entry</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CtEntry</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 针对资源操作</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">throw</span> e1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">// This should not happen, unless there are errors existing in Sentinel internal.</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel unexpected exception"</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> e<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码解析-构建context"><a class="anchor" href="#sentinel源码解析-构建context">#</a> Sentinel 源码解析 - 构建 Context</h1><p>我们继续分析当前这个类型中的 InternalContextUtil.internalEnter (Constants.CONTEXT_DEFAULT_NAME); 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* This class is used for skip context name checking.</pre></td></tr><tr><td data-num="3"></td><td><pre>此类型是用于跳过 Context 名称的检测</pre></td></tr><tr><td data-num="4"></td><td><pre>*/</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InternalContextUtil</span> <span class="token keyword">extends</span> <span class="token class-name">ContextUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">internalEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// 从这里继续跟踪</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">internalEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> origin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>首先这里要明确一下，一个 Context 的组成实际上需要 name (名称) 和 origin (来源)，所以方法上传入这两个参数</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">static</span> <span class="token class-name">Context</span> <span class="token function">trueEnter</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">String</span> origin<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 从当前线程中获取当前 context 名称</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Context</span> context <span class="token operator">=</span> contextHolder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 如果当前 context 为空</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>context <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 从缓存中获取，当前缓存中 key 值为：Context 名称，value 值为：EntranceNode</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token comment">// （因为后续创建的是 EntranceNode），需要它的原因是因为构建 Context 需要 EntranceNode</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> localCacheNameMap <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 在缓存中获取 EntranceNode</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> localCacheNameMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 如果 node 为空</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token comment">// 当前缓存的 size>Context 的最大数量，返回 NULL_Context 类型</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>localCacheNameMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MAX_CONTEXT_NAME_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token keyword">return</span> <span class="token constant">NULL_CONTEXT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token comment">// 加锁</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    node <span class="token operator">=</span> contextNameNodeMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                    <span class="token comment">// 这里两次判断是采用了双重检测锁的机制：为了防止并发创建</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MAX_CONTEXT_NAME_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                            <span class="token function">setNullContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                            <span class="token keyword">return</span> <span class="token constant">NULL_CONTEXT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                            <span class="token comment">//node 赋值为 EntranceNode</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                            node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EntranceNode</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringResourceWrapper</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">EntryType</span><span class="token punctuation">.</span><span class="token constant">IN</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                            <span class="token comment">// Add entrance node.</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                            <span class="token comment">// 将新建的 EntranceNode 添加到 ROOT 中</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                            <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">ROOT</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                            <span class="token comment">// 将新建的 EntranceNode 添加到缓存中</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                            newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>contextNameNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                            newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                            contextNameNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                    <span class="token constant">LOCK</span><span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">// 将 name 和 node 封装成 Context</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token comment">// 设定来源</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">// 将 context 写入到当前线程中</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        contextHolder<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>	<span class="token comment">// 返回 Context</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token keyword">return</span> context<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码解析-slotchain入口解析"><a class="anchor" href="#sentinel源码解析-slotchain入口解析">#</a> Sentinel 源码解析 - SlotChain 入口解析</h1><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/sentinel-slot-chain-architecture.png" title="arch overview"><h2 id="默认chain解析"><a class="anchor" href="#默认chain解析">#</a> 默认 Chain 解析</h2><p>​	我们从这里继续分析，这个位置的 chain.entry 方法，但是此时这个 chain 是谁？</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//CtSph 中</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 针对资源操作</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">throw</span> e1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// This should not happen, unless there are errors existing in Sentinel internal.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel unexpected exception"</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么这个位置开始，我们就要分析一下如下代码</p><p>官方定义：Sentinel 将 ProcessorSlot 作为 SPI 接口进行扩展（1.7.2 版本以前 SlotChainBuilder 作为 SPI），使得 Slot Chain 具备了扩展的能力。您可以自行加入自定义的 slot 并编排 slot 间的顺序，从而可以给 Sentinel 添加自定义的功能。</p><p>lookProcessChain () 用于构建一个责任链。Sentinel 的处理核心都在这个责任链中，链中每一个节点是一个 Slot 实例，这个链通过 BlockException 异常来告知调用入口最终的执行情况</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取 chain 链</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> chain <span class="token operator">=</span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//------------------- 具体看 lookProcessChain 方法 ---------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name">ProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">></span></span> <span class="token function">lookProcessChain</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 先从 chainMap 获取，若是存在，则直接返回</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">ProcessorSlotChain</span> chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token constant">LOCK</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            chain <span class="token operator">=</span> chainMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>chain <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token comment">// Entry size limit.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token class-name">Constants</span><span class="token punctuation">.</span><span class="token constant">MAX_SLOT_CHAIN_SIZE</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>				<span class="token comment">// 通过 SlotChainProvider 创建一个 slot 链</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                chain <span class="token operator">=</span> <span class="token class-name">SlotChainProvider</span><span class="token punctuation">.</span><span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ProcessorSlotChain</span><span class="token punctuation">></span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ProcessorSlotChain</span><span class="token punctuation">></span></span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    chainMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>chainMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token comment">// 添加到 Map 缓存中</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> chain<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                chainMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> chain<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个位置我们要具体分析 SlotChainProvider 这个类型，它的主要作用就是通过已解析的槽链构建器，创建槽链的提供者</p><p>从这里我们可以看出 SlotChainBuilder 及 ProcessorSlot 使用 Java SPI 技术实现可配置化，即在 / META-INF/services/ 接口全限命名 的文件中配置实现类，然后由 ServiceLoader 实现加载，这种技术在 SpringBoot 中都有使用。不作讲解。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slotchain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>log<span class="token punctuation">.</span></span><span class="token class-name">RecordLog</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span></span><span class="token class-name">DefaultSlotChainBuilder</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>spi<span class="token punctuation">.</span></span><span class="token class-name">SpiLoader</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * A provider for creating slot chains via resolved slot chain builder SPI.</pre></td></tr><tr><td data-num="9"></td><td><pre> *</pre></td></tr><tr><td data-num="10"></td><td><pre> * @author Eric Zhao</pre></td></tr><tr><td data-num="11"></td><td><pre> * @since 0.2.0</pre></td></tr><tr><td data-num="12"></td><td><pre> */</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">SlotChainProvider</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">SlotChainBuilder</span> slotChainBuilder <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>     * The load and pick process is not thread-safe, but it's okay since the method should be only invoked</pre></td></tr><tr><td data-num="19"></td><td><pre>     * via &#123;@code lookProcessChain&#125; in &#123;@link com.alibaba.csp.sentinel.CtSph&#125; under lock.</pre></td></tr><tr><td data-num="20"></td><td><pre>     *</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @return new created slot chain</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">newSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 读取配置文件在 / META-INF/services/ 接口全限定命名的文件中配置实现类.</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        slotChainBuilder <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">SlotChainBuilder</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadFirstInstanceOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>slotChainBuilder <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// Should not go through here.</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"[SlotChainProvider] Wrong state when resolving slot chain builder, using default"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">// 使用默认的 DefaultSlotChainBuilder 来构建 ProcessorSlotChain</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            slotChainBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultSlotChainBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[SlotChainProvider] Global slot chain builder resolved: &#123;&#125;"</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                slotChainBuilder<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token comment">// 使用 DefaultSlotChainBuilder 构建</span></pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> slotChainBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">SlotChainProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>到这里我们就清楚的知道了其实现在使用的是使用 DefaultSlotChainBuilder.build () 来创建的，以下是源码</p><p>在这个其中，做了几件事：</p><pre><code>1. 创建DefaultProcessorSlotChain
2. 读取/META-INF/services/中的配置文件
3. 强制转型为AbstractLinkedProcessorSlot（所有插槽的抽象父类）
</code></pre><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Spi</span><span class="token punctuation">(</span>isDefault <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultSlotChainBuilder</span> <span class="token keyword">implements</span> <span class="token class-name">SlotChainBuilder</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">ProcessorSlotChain</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 创建 DefaultProcessorSlotChain</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">ProcessorSlotChain</span> chain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultProcessorSlotChain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>		<span class="token comment">// 读取配置文件在 / META-INF/services/ 接口全限定命名的文件</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">></span></span> sortedSlotList <span class="token operator">=</span> <span class="token class-name">SpiLoader</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadInstanceListSorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProcessorSlot</span> slot <span class="token operator">:</span> sortedSlotList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>slot <span class="token keyword">instanceof</span> <span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"The ProcessorSlot("</span> <span class="token operator">+</span> slot<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">") is not an instance of AbstractLinkedProcessorSlot, can't be added into ProcessorSlotChain"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>            chain<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">AbstractLinkedProcessorSlot</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span><span class="token punctuation">)</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">return</span> chain<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>具体读取的内容如下：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre># <span class="token class-name">Sentinel</span> <span class="token keyword">default</span> <span class="token class-name">ProcessorSlots</span> </pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>nodeselector<span class="token punctuation">.</span></span>NodeSelectorSlot</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>clusterbuilder<span class="token punctuation">.</span></span>ClusterBuilderSlot</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>logger<span class="token punctuation">.</span></span>LogSlot</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>statistic<span class="token punctuation">.</span></span>StatisticSlot</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>authority<span class="token punctuation">.</span></span>AuthoritySlot</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>system<span class="token punctuation">.</span></span>SystemSlot</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>flow<span class="token punctuation">.</span></span>FlowSlot</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span>degrade<span class="token punctuation">.</span></span>DegradeSlot</span></pre></td></tr></table></figure><p>这些就是 Sentinel 提供的默认功能插槽</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211209165106934.png" title="image-20211209165106934"><h2 id="nodeselectorslot解析"><a class="anchor" href="#nodeselectorslot解析">#</a> NodeSelectorSlot 解析</h2><p>分析到这里我们就可以回到 CtSph 中，查看 entry 方法这个时候我们就知道了实际上调用 entry 方法的是 DefaultProcessorSlotChain</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>     <span class="token comment">// 针对资源操作</span></pre></td></tr><tr><td data-num="3"></td><td><pre>     chain<span class="token punctuation">.</span><span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">BlockException</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     e<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     <span class="token keyword">throw</span> e1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     <span class="token comment">// This should not happen, unless there are errors existing in Sentinel internal.</span></pre></td></tr><tr><td data-num="9"></td><td><pre>     <span class="token class-name">RecordLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sentinel unexpected exception"</span><span class="token punctuation">,</span> e1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那我们向下跟踪</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> t<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 转到下一个节点</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    first<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这个位置是转入到下一个节点，那么下一个节点明显就是 NodeSelectorSlot，那我们来看具体操作</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">transformEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">//NodeSelectorSlot</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>NodeSelectorSlot 具体内容官网有给出解释：</p><p>这个 slot 主要负责收集资源的路径，并将这些资源的调用路径，以树状结构存储起来，用于根据调用路径来限流降级。</p><p>DefaultNode 用于统计一个 resource 在当前 Context 中的流量数据，所以再结合 NodeSelectorSlot，最终得出结论：处理不同的 Context name，同一个 Resource name 的情况</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211209171805499.png" title="image-20211209171805499"> <img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211123135428060.png" title="image-20211123135428060"><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 从缓存中获取，创建 DefaultNode</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 双重判断，如果判断为空</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token comment">// 创建一个 DefaultNode 并且放入到缓存中</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                cacheMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                map <span class="token operator">=</span> cacheMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token comment">// Build invocation tree</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token comment">// 将新建的 Node 添加到调用树中</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	</pre></td></tr><tr><td data-num="26"></td><td><pre>    context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 触发下一个节点</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码解析-clusterbuilderslot解析"><a class="anchor" href="#sentinel源码解析-clusterbuilderslot解析">#</a> Sentinel 源码解析 - ClusterBuilderSlot 解析</h1><p>上节课我们分析了 SlotChain 入口和 NodeSelectorSlot 那么这节课分析 ClusterBuilderSlot</p><h2 id="官方定义"><a class="anchor" href="#官方定义">#</a> 官方定义</h2><p>ClusterBuilderSlot：则用于存储资源的统计信息以及调用者信息，例如该资源的 RT, QPS, thread count 等等，这些信息将用作为多维度限流，降级的依据；</p><p>那我们来进行分析，首先我们先看上节课分析到的位置</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//NodeSelectorSlot.entry()</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 从缓存中获取，创建 DefaultNode</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">DefaultNode</span> node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 双重判断，如果判断为空</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            node <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token comment">// 创建一个 DefaultNode 并且放入到缓存中</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                node <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span> cacheMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                cacheMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                cacheMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                map <span class="token operator">=</span> cacheMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                <span class="token comment">// Build invocation tree</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token comment">// 将新建的 Node 添加到调用树中</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">DefaultNode</span><span class="token punctuation">)</span> context<span class="token punctuation">.</span><span class="token function">getLastNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    context<span class="token punctuation">.</span><span class="token function">setCurNode</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 触发下一个节点</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>再触发下一个节点以后，调用的是父级 AbstractLinkedProcessorSlot.fireEntry () 方法，然后 next 调用 transformEntry</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 调用下一个节点</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        next<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">//next 就代表循环到下一个节点所以这里调用 entry 的就是 ClusterBuilderSlot</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token keyword">void</span> <span class="token function">transformEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="clusterbuilderslot"><a class="anchor" href="#clusterbuilderslot">#</a> ClusterBuilderSlot</h2><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// ClusterBuilderSlot.entry</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                  <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>lock<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>clusterNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                <span class="token comment">// Create the cluster node.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>                clusterNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">.</span><span class="token function">getResourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                <span class="token comment">//key 为资源 value 为 ClusterNode</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResourceWrapper</span><span class="token punctuation">,</span> <span class="token class-name">ClusterNode</span><span class="token punctuation">></span></span> newMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                newMap<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>clusterNodeMap<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                newMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>                clusterNodeMap <span class="token operator">=</span> newMap<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre> 	<span class="token comment">// 添加节点</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    node<span class="token punctuation">.</span><span class="token function">setClusterNode</span><span class="token punctuation">(</span>clusterNode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="24"></td><td><pre>         * if context origin is set, we should get or create a new &#123;@link Node&#125; of</pre></td></tr><tr><td data-num="25"></td><td><pre>         * the specific origin.</pre></td></tr><tr><td data-num="26"></td><td><pre>         */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token comment">// 确认资源的来源</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">Node</span> originNode <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateOriginNode</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOriginNode</span><span class="token punctuation">(</span>originNode<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="总结"><a class="anchor" href="#总结">#</a> 总结：</h2><p>ClusterNode 作用就是与 DefaultNode 进行关联，即不同的 DefaultNode 都关联了一个 ClusterNode，这样我们在不同上下文中都可以拿到当前资源一个总的流量统计情况。</p><h1 id="sentinel源码解析-slot分析后续1"><a class="anchor" href="#sentinel源码解析-slot分析后续1">#</a> Sentinel 源码解析 - Slot 分析后续 1</h1><p>这节课我们继续分析 Sentinel 调用链路中的 Slot，那么我们还是先来分析 StatisticSlot：</p><h2 id="statisticslot定义"><a class="anchor" href="#statisticslot定义">#</a> StatisticSlot 定义：</h2><p>StatisticSlot 是 Sentinel 最为重要的类之一，用于根据规则判断结果进行相应的统计操作。</p><p>entry 的时候：依次执行后面的判断 slot。每个 slot 触发流控的话会抛出异常（BlockException 的子类）。若有 BlockException 抛出，则记录 block 数据；若无异常抛出则算作可通过（pass），记录 pass 数据。</p><p>exit 的时候：若无 error（无论是业务异常还是流控异常），记录 complete（success）以及 RT，线程数 - 1。</p><p>记录数据的维度：线程数 + 1、记录当前 DefaultNode 数据、记录对应的 originNode 数据（若存在 origin）、累计 IN 统计数据（若流量类型为 IN）。</p><h2 id="分析源码核心方法"><a class="anchor" href="#分析源码核心方法">#</a> 分析源码核心方法</h2><p>首先我们从 ClusterNodeSlot 中的 entry 方法中找到调用下一节点方法，然后向下跟踪，道理和之前的都一样，调用的是父级方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">//------------------- 父级方法 -----------------------------</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> obj<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        next<span class="token punctuation">.</span><span class="token function">transformEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> obj<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>找到 transformEntry 方法，然后此时的下一个节点必然是 StatisticSlot</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"unchecked"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">transformEntry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">T</span> t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">T</span><span class="token punctuation">)</span>o<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">//StatisticSlot</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">entry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> t<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后我们来看 StatisticSlot 的核心方法，这里的核心思想就是：封装了基础的流量统计和获取方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                  <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// Do some checking.</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// 此位置会调用 SlotChain 中后续的所有 Slot，完成所有规则检测。</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// Request passed, add thread count and pass count.</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 代码运行到这个位置，就证明之前的所有 Slot 检测都通过了，此时就可以统计请求的相应数据了。</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 增加线程数（+1）</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        node<span class="token punctuation">.</span><span class="token function">increaseThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 增加通过请求的数量 (这里涉及到滑动窗口算法)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        node<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>		<span class="token comment">//..... 以下全部是流量统计的方法</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>看到这里以后，我们对 StatisticSlot 作用已经比较了解了，那么现在我们主要要分析这个位置，也就是说向下分析一下的节点</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>这里向下的节点调用方式和之前的都一样，所以剩下的节点非别为：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211213152938457.png" title="image-20211213152938457"><p>但是其实这里的 ParamFlowSlot 包括 SystemSlot 和 AuthoritySlot 我们在操作的时候其实就已经知道了它们就是根据不同维度进行统计和检测，那么这三个我们就不再详细分析，这条链路中我们要主要分析流控和熔断：FlowSlot、DegradeSlot</p><h2 id="flowslot定义"><a class="anchor" href="#flowslot定义">#</a> FlowSlot 定义：</h2><p>这个 slot 主要根据预设的资源的统计信息，按照固定的次序，依次生效。如果一个资源对应两条或者多条流控规则，则会根据如下次序依次检验，直到全部通过或者有一个规则生效为止:</p><ul><li>指定应用生效的规则，即针对调用方限流的；</li><li>调用方为 other 的规则；</li><li>调用方为 default 的规则。</li></ul><h2 id="分析核心方法"><a class="anchor" href="#分析核心方法">#</a> 分析核心方法</h2><p>进入到核心方法的方式和之前的都一样，所以我们直接来看</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                  <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 检测并且应用流量规则</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 触发下一个 Slot</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那我们先来分析 checkFlow 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 在这里继续跟踪</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    checker<span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>ruleProvider<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//---------------checkFlow 具体实现 ----------------------</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                      <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 判断规则和资源不能为空</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ruleProvider <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> resource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 获取到指定资源的所有流控规则</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">// 逐个应用流控规则。若无法通过则抛出异常，后续规则不再应用</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canPassCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token comment">// FlowException 继承 BlockException</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里我们需要注意一下 FlowRule（流控规则），它继承自 AbstractRule，那我们来看一下 AbstractRule 其中的两个类型，分别是资源名称和资源的来源</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> resource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">private</span> <span class="token class-name">String</span> limitApp<span class="token punctuation">;</span></pre></td></tr></table></figure><p>那么通过这里我们就可以得知，流控的规则设置其实就是通过这个 FlowRule 来完成的，同样它的数据来源，就是我们使用的 Sentinel-dashboard，当然也可以通过代码来进行设置</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlowRule</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractRule</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 来源默认 Default</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FlowRule</span><span class="token punctuation">(</span><span class="token class-name">String</span> resourceName<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 资源名称</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">setResource</span><span class="token punctuation">(</span>resourceName<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token function">setLimitApp</span><span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * The threshold type of flow control (0: thread count, 1: QPS).</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">// 设置阈值类型 0 是线程 1 为 QPS</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> grade <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="23"></td><td><pre>     * Flow control threshold count.</pre></td></tr><tr><td data-num="24"></td><td><pre>     */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token comment">// 单机阈值</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="29"></td><td><pre>     * Flow control strategy based on invocation chain.</pre></td></tr><tr><td data-num="30"></td><td><pre>     * 直接流控</pre></td></tr><tr><td data-num="31"></td><td><pre>     * &#123;@link RuleConstant#STRATEGY_DIRECT&#125; for direct flow control (by origin);</pre></td></tr><tr><td data-num="32"></td><td><pre>     * 关联流控</pre></td></tr><tr><td data-num="33"></td><td><pre>     * &#123;@link RuleConstant#STRATEGY_RELATE&#125; for relevant flow control (with relevant resource);</pre></td></tr><tr><td data-num="34"></td><td><pre>     * 链路流控</pre></td></tr><tr><td data-num="35"></td><td><pre>     * &#123;@link RuleConstant#STRATEGY_CHAIN&#125; for chain flow control (by entrance resource).</pre></td></tr><tr><td data-num="36"></td><td><pre>     */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">// 流控模式</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> strategy <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="41"></td><td><pre>     * Reference resource in flow control with relevant resource or context.</pre></td></tr><tr><td data-num="42"></td><td><pre>     */</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token comment">// 关联流控模式，关联的资源设置</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> refResource<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="47"></td><td><pre>     * Rate limiter control behavior.</pre></td></tr><tr><td data-num="48"></td><td><pre>     * 0. default(reject directly), 1. warm up, 2. rate limiter, 3. warm up + rate limiter</pre></td></tr><tr><td data-num="49"></td><td><pre>     */</pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token comment">// 流控效果 0 快速失败 1 预热（令牌桶算法） 2 排队等待（漏斗算法） 3 预热 + 排队等待（目前控制台没有）</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> controlBehavior <span class="token operator">=</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">CONTROL_BEHAVIOR_DEFAULT</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token comment">//warp up 预热时长</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> warmUpPeriodSec <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="57"></td><td><pre>     * Max queueing time in rate limiter behavior.</pre></td></tr><tr><td data-num="58"></td><td><pre>     */</pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// 排队等待的超时时间</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> maxQueueingTimeMs <span class="token operator">=</span> <span class="token number">500</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre></pre></td></tr><tr><td data-num="62"></td><td><pre>    <span class="token comment">// 是否为集群模式</span></pre></td></tr><tr><td data-num="63"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> clusterMode<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="65"></td><td><pre>     * Flow rule config for cluster mode.</pre></td></tr><tr><td data-num="66"></td><td><pre>     */</pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token comment">// 集群模式配置</span></pre></td></tr><tr><td data-num="68"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">ClusterFlowConfig</span> clusterConfig<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre></pre></td></tr><tr><td data-num="70"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="71"></td><td><pre>     * The traffic shaping (throttling) controller.</pre></td></tr><tr><td data-num="72"></td><td><pre>     */</pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">TrafficShapingController</span> controller<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>   <span class="token comment">//.... 省略以下方法</span></pre></td></tr><tr><td data-num="76"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里还涉及到两个算法：令牌桶算法和漏斗算法</p><ul><li>令牌桶算法：令牌桶算法的原理是系统会以一个恒定的速度往桶里放入令牌，而如果请求需要被处理，则需要先从桶里获取一个令牌，当桶里没有令牌可取时，则拒绝服务。</li><li>漏斗算法：漏桶算法思路很简单，请求先进入到漏桶里，漏桶以固定的速度出水，也就是处理请求，当水加的过快，则会直接溢出，也就是拒绝请求，可以看出漏桶算法能强行限制数据的传输速率。</li></ul><h1 id="sentinel源码解析-slot分析后续2"><a class="anchor" href="#sentinel源码解析-slot分析后续2">#</a> Sentinel 源码解析 - Slot 分析后续 2</h1><p>这节课我们继续分析 Sentinel 调用链路中的 Slot，那么我们还是继续分析 FlowSlot</p><h2 id="flowslot获取全部流控规则"><a class="anchor" href="#flowslot获取全部流控规则">#</a> FlowSlot 获取全部流控规则</h2><p>上节课我们分析到这个位置，这节课我们主要研究一下如何获取全部的流控规则</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取到指定资源的所有流控规则</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">// 逐个应用流控规则。若无法通过则抛出异常，后续规则不再应用</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canPassCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>            <span class="token comment">// FlowException 继承 BlockException</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment">// 这里调用的 apply 方法就是 FlowSlot 中的对应方法</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token class-name">String</span> resource<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// Flow rule map should not be null.</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 获取所有资源和对应的流控规则 key 为资源名称，value 为该资源对应的所有流控规则</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getFlowRuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 获取指定资源的流控规则</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">return</span> flowRules<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>那我们来看 apply 方法，要注意的是其中的 FlowRuleManager 其实如果我们通过代码的方式来设置流控就会使用到它，因为它提供了对应的方法 FlowRuleManager.loadRules ()</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre>* Load &#123;@link FlowRule&#125; s, former rules will be replaced.</pre></td></tr><tr><td data-num="3"></td><td><pre>* 添加新的流控规则</pre></td></tr><tr><td data-num="4"></td><td><pre>* @param rules new rules to load.</pre></td></tr><tr><td data-num="5"></td><td><pre>*/</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadRules</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    currentProperty<span class="token punctuation">.</span><span class="token function">updateValue</span><span class="token punctuation">(</span>rules<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>但是现在这个位置源码用的 FlowRuleManager.getFlowRuleMap ()，其实通过这个方法我们就可以得知，FlowRuleManager 的作用就是设置对应资源的流控规则，资源对应的流控规则 (list 集合) 组成一个 Map</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 获取所有资源和对应的流控规则 key 为资源名称，value 为该资源对应的所有流控规则</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> flowRules <span class="token operator">=</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">getFlowRuleMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>那我们现在来看 FlowRuleChecker.checkFlow () 方法如何应用规则，这里我们要注意遍历</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">Function</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span><span class="token punctuation">></span></span> ruleProvider<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                      <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 判断规则和资源不能为空</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ruleProvider <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> resource <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 获取到指定资源的所有流控规则</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">FlowRule</span><span class="token punctuation">></span></span> rules <span class="token operator">=</span> ruleProvider<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>resource<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 逐个应用流控规则。若无法通过则抛出异常，后续规则不再应用</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rules <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule <span class="token operator">:</span> rules<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token comment">// 遍历规则，应用规则，判断是否能够通过规则</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canPassCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                <span class="token comment">// FlowException 继承 BlockException</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FlowException</span><span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rule<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那我们需要跟进去看一下 canPassCheck 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPassCheck</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span><span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 从规则中获取要限定的来源</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 如果来源为空，则请求直接通过</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 处理集群流控</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule<span class="token punctuation">.</span><span class="token function">isClusterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">passClusterCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 处理单机流控</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么这里我们要关注的是处理单机流控的方法 passLocalCheck</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">passLocalCheck</span><span class="token punctuation">(</span><span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="2"></td><td><pre>                                      <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 根据请求选择节点</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Node</span> selectedNode <span class="token operator">=</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>selectedNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 根据配置 FlowRule 配置的流控效果 (流控效果：直接拒绝、排队等待、预热)，选择不同的 Controller，判断是否通过</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">getRater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canPass</span><span class="token punctuation">(</span>selectedNode<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这里我们来看一下根据请求来选择节点</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">static</span> <span class="token class-name">Node</span> <span class="token function">selectNodeByRequesterAndStrategy</span><span class="token punctuation">(</span><span class="token comment">/*@NonNull*/</span> <span class="token class-name">FlowRule</span> rule<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// The limit app should not be empty.</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取限定来源 (调用方)、流控模式（直接）、获取 context 中的调用发（从当前上下文环境中获取）</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">String</span> limitApp <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> strategy <span class="token operator">=</span> rule<span class="token punctuation">.</span><span class="token function">getStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> origin <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getOrigin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 判断来源如果不是 Default（默认）和 Other（其他）</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>limitApp<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">filterOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token comment">// Matches limit origin, return origin statistic node.</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 如果是默认来源</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_DEFAULT</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 是否是直接流控模式</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// Return the cluster node.</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 返回统计数据</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">return</span> node<span class="token punctuation">.</span><span class="token function">getClusterNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 其他来源 other</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">LIMIT_APP_OTHER</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>limitApp<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="28"></td><td><pre>               <span class="token operator">&amp;&amp;</span> <span class="token class-name">FlowRuleManager</span><span class="token punctuation">.</span><span class="token function">isOtherOrigin</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> rule<span class="token punctuation">.</span><span class="token function">getResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">STRATEGY_DIRECT</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">return</span> context<span class="token punctuation">.</span><span class="token function">getOriginNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">selectReferenceNode</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那到这为止，我们就知道如何获取流控规则和针对不同来源的不同操作，那么现在还有一个问题就是，就是这个位置的解析</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 根据配置 FlowRule 配置的流控效果 (流控效果：直接拒绝、排队等待、预热)，选择不同的 Controller，判断是否通过</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">getRater</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">canPass</span><span class="token punctuation">(</span>selectedNode<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h2 id="流控效果对应的controller"><a class="anchor" href="#流控效果对应的controller">#</a> 流控效果对应的 Controller</h2><p>其实这个位置的 rule.getRater () 的返回值类型为 TrafficShapingController，而这里的类结构为：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token class-name">TrafficShapingController</span> <span class="token function">getRater</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> controller<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211216210615881.png" title="image-20211216210615881"><p>其实从这里我们就能看出针对不同的流控模式，针对不同的控制器来进行处理，那么我们这里演示一个 DefaultController</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211216210800196.png" title="image-20211216210800196"><p>那我们现在来看一下具体 DefaultController 的操作，在 DefaultController 中，首先获取当前的线程数或者 QPS 数，如果当前的线程数或者 QPS + 申请的数量 &gt; 配置的总数，则不通过，如果当前线程数或者 QPS + 申请的数量 &lt;= 配置的总数，则直接通过</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultController</span> <span class="token keyword">implements</span> <span class="token class-name">TrafficShapingController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">DEFAULT_AVG_USED_TOKENS</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">double</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> grade<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DefaultController</span><span class="token punctuation">(</span><span class="token keyword">double</span> count<span class="token punctuation">,</span> <span class="token keyword">int</span> grade<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>grade <span class="token operator">=</span> grade<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> <span class="token function">canPass</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 获取当前 node 节点的线程数或者请求通过的 qps 总数</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">int</span> curCount <span class="token operator">=</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 当前请求数（请求的令牌）+ 申请总数是否（已经消耗的令牌）> 该资源配置的总数（阈值）</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> acquireCount <span class="token operator">></span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>prioritized <span class="token operator">&amp;&amp;</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token keyword">long</span> currentTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token keyword">long</span> waitInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                currentTime <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                waitInMs <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">tryOccupyNext</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">&lt;</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    node<span class="token punctuation">.</span><span class="token function">addWaitingRequest</span><span class="token punctuation">(</span>currentTime <span class="token operator">+</span> waitInMs<span class="token punctuation">,</span> acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    node<span class="token punctuation">.</span><span class="token function">addOccupiedPass</span><span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token function">sleep</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>                    <span class="token comment">// PriorityWaitException indicates that the request will pass after waiting for &#123;@link @waitInMs&#125;.</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PriorityWaitException</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">return</span> <span class="token constant">DEFAULT_AVG_USED_TOKENS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">return</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_THREAD</span> <span class="token operator">?</span> node<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token comment">// Ignore.</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h2 id="流程总结"><a class="anchor" href="#流程总结">#</a> 流程总结</h2><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211216214823684.png" title="image-20211216214823684"><h1 id="sentinel源码解析-熔断降级degradeslot解析"><a class="anchor" href="#sentinel源码解析-熔断降级degradeslot解析">#</a> Sentinel 源码解析 - 熔断降级 DegradeSlot 解析</h1><p>上节课我们分析完了限流 FlowSlot，那么我们继续想下一个链路中的元素来看，下一个就是熔断降级的 Slot，那我们直接来看核心方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//DegradeSlot.entry</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="4"></td><td><pre>                  <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 熔断降级检测</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">performChecking</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 触发下一个节点</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那我们先来跟踪熔断降级检测的方法，在这里我们可以看见，这里其实就是对熔断器的状态进行判断</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">performChecking</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> r<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 获取所有资源的熔断器</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CircuitBreaker</span><span class="token punctuation">></span></span> circuitBreakers <span class="token operator">=</span> <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">getCircuitBreakers</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 判断是否获取到熔断器，如果为空直接结束</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreakers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> circuitBreakers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CircuitBreaker</span> cb <span class="token operator">:</span> circuitBreakers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 判断所有熔断器的状态，如果是开启状态直接抛出异常</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cb<span class="token punctuation">.</span><span class="token function">tryPass</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token comment">// 此异常继承于 BlockException</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">DegradeException</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLimitApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cb<span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>而真正判断是否需要开启熔断器是在 exit 方法中进行的，这个方法是在业务方法执行以后调用了，熔断器需要手机业务异常或者业务的执行时间来判断是开启熔断</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exit</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 如果当前其他的 Slot 已经有了 BlockException，就直接跳过</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Entry</span> curEntry <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>curEntry<span class="token punctuation">.</span><span class="token function">getBlockError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> r<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 通过资源名称获取熔断器</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CircuitBreaker</span><span class="token punctuation">></span></span> circuitBreakers <span class="token operator">=</span> <span class="token class-name">DegradeRuleManager</span><span class="token punctuation">.</span><span class="token function">getCircuitBreakers</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreakers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> circuitBreakers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> r<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>curEntry<span class="token punctuation">.</span><span class="token function">getBlockError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">// passed request</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 调用 CircuitBreaker 的 onRequestComplete () 方法</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CircuitBreaker</span> circuitBreaker <span class="token operator">:</span> circuitBreakers<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            circuitBreaker<span class="token punctuation">.</span><span class="token function">onRequestComplete</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token function">fireExit</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> r<span class="token punctuation">,</span> count<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这个代码中，有一个比较关键的地方就是 CircuitBreaker（熔断器），那我们来分析一下：</p><h2 id="circuitbreaker熔断器"><a class="anchor" href="#circuitbreaker熔断器">#</a> CircuitBreaker 熔断器</h2><p>首先我们要知道其实 CircuitBreaker 是一个接口</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="2"></td><td><pre> * 熔断器中将三种熔断策略封装（慢调用比例 / 异常比例 / 异常数）为两种熔断器：</pre></td></tr><tr><td data-num="3"></td><td><pre> * 响应时间熔断器、异常熔断器</pre></td></tr><tr><td data-num="4"></td><td><pre> */</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CircuitBreaker</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre>     * Get the associated circuit breaking rule.</pre></td></tr><tr><td data-num="9"></td><td><pre>     *</pre></td></tr><tr><td data-num="10"></td><td><pre>     * @return associated circuit breaking rule</pre></td></tr><tr><td data-num="11"></td><td><pre>     * 获取熔断规则</pre></td></tr><tr><td data-num="12"></td><td><pre>     */</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token class-name">DegradeRule</span> <span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     * Acquires permission of an invocation only if it is available at the time of invoking.</pre></td></tr><tr><td data-num="17"></td><td><pre>     *</pre></td></tr><tr><td data-num="18"></td><td><pre>     * @param context context of current invocation</pre></td></tr><tr><td data-num="19"></td><td><pre>     * @return &#123;@code true&#125; if permission was acquired and &#123;@code false&#125; otherwise</pre></td></tr><tr><td data-num="20"></td><td><pre>     * 判断是否需要降级 返回值为 false 开启降级</pre></td></tr><tr><td data-num="21"></td><td><pre>     */</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">boolean</span> <span class="token function">tryPass</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="25"></td><td><pre>     * Get current state of the circuit breaker.</pre></td></tr><tr><td data-num="26"></td><td><pre>     *</pre></td></tr><tr><td data-num="27"></td><td><pre>     * @return current state of the circuit breaker</pre></td></tr><tr><td data-num="28"></td><td><pre>     * 当前熔断器状态</pre></td></tr><tr><td data-num="29"></td><td><pre>     */</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token class-name">State</span> <span class="token function">currentState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="33"></td><td><pre>     * &lt;p>Record a completed request with the context and handle state transformation of the circuit breaker.&lt;/p></pre></td></tr><tr><td data-num="34"></td><td><pre>     * &lt;p>Called when a &lt;strong>passed&lt;/strong> invocation finished.&lt;/p></pre></td></tr><tr><td data-num="35"></td><td><pre>     *</pre></td></tr><tr><td data-num="36"></td><td><pre>     * @param context context of current invocation</pre></td></tr><tr><td data-num="37"></td><td><pre>     * 回调方法 当请求通过后触发</pre></td></tr><tr><td data-num="38"></td><td><pre>     */</pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">onRequestComplete</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="42"></td><td><pre>     * Circuit breaker state.</pre></td></tr><tr><td data-num="43"></td><td><pre>     * 三种熔断器状态：</pre></td></tr><tr><td data-num="44"></td><td><pre>     * OPEN 开启</pre></td></tr><tr><td data-num="45"></td><td><pre>     * HALF_OPEN 半开启</pre></td></tr><tr><td data-num="46"></td><td><pre>     * CLOSED 关闭</pre></td></tr><tr><td data-num="47"></td><td><pre>     */</pre></td></tr><tr><td data-num="48"></td><td><pre>    <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="50"></td><td><pre>         * In &#123;@code OPEN&#125; state, all requests will be rejected until the next recovery time point.</pre></td></tr><tr><td data-num="51"></td><td><pre>         */</pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token constant">OPEN</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="54"></td><td><pre>         * In &#123;@code HALF_OPEN&#125; state, the circuit breaker will allow a "probe" invocation.</pre></td></tr><tr><td data-num="55"></td><td><pre>         * If the invocation is abnormal according to the strategy (e.g. it's slow), the circuit breaker</pre></td></tr><tr><td data-num="56"></td><td><pre>         * will re-transform to the &#123;@code OPEN&#125; state and wait for the next recovery time point;</pre></td></tr><tr><td data-num="57"></td><td><pre>         * otherwise the resource will be regarded as "recovered" and the circuit breaker</pre></td></tr><tr><td data-num="58"></td><td><pre>         * will cease cutting off requests and transform to &#123;@code CLOSED&#125; state.</pre></td></tr><tr><td data-num="59"></td><td><pre>         */</pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token constant">HALF_OPEN</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="62"></td><td><pre>         * In &#123;@code CLOSED&#125; state, all requests are permitted. When current metric value exceeds the threshold,</pre></td></tr><tr><td data-num="63"></td><td><pre>         * the circuit breaker will transform to &#123;@code OPEN&#125; state.</pre></td></tr><tr><td data-num="64"></td><td><pre>         */</pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token constant">CLOSED</span></pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>以上代码中其中三种熔断状态对应的原理如下（这个原理在基础应用讲过）</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211103194830095.png" title="image-20211103194830095"><h2 id="熔断策略"><a class="anchor" href="#熔断策略">#</a> 熔断策略</h2><p>对应的实现类有两个 ExceptionCircuitBreaker（异常熔断器）、ResponseTimeCircuitBreaker（响应时间熔断器），这个我们可以从类图看到</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211221193548988.png" title="image-20211221193548988"><p>那我们这里来看看 ExceptionCircuitBreaker (异常熔断器)，对应的策略是</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211221225941518.png" title="image-20211221225941518"><p>我们来看对应回调方法 ExceptionCircuitBreaker.onRequestComplete</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRequestComplete</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">Entry</span> entry <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCurEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">Throwable</span> error <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 异常事件窗口计数器</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">SimpleErrorCounter</span> counter <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 如果有异常，异常数 + 1</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        counter<span class="token punctuation">.</span><span class="token function">getErrorCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 总异常数 + 1</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    counter<span class="token punctuation">.</span><span class="token function">getTotalCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token function">handleStateChangeWhenThresholdExceeded</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleStateChangeWhenThresholdExceeded</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token comment">// 如果熔断器已经开启直接返回</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token comment">// 进入办开启状态</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentState<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">State</span><span class="token punctuation">.</span><span class="token constant">HALF_OPEN</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// In detecting request</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">// 本次请求没有出现异常，关闭熔断器</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token function">fromHalfOpenToClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 本次请求出现异常，打开熔断</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token function">fromHalfOpenToOpen</span><span class="token punctuation">(</span><span class="token number">1.0d</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SimpleErrorCounter</span><span class="token punctuation">></span></span> counters <span class="token operator">=</span> stat<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">long</span> errCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 异常数量</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token keyword">long</span> totalCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 总异常数</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SimpleErrorCounter</span> counter <span class="token operator">:</span> counters<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        errCount <span class="token operator">+=</span> counter<span class="token punctuation">.</span>errorCount<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        totalCount <span class="token operator">+=</span> counter<span class="token punctuation">.</span>totalCount<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    <span class="token comment">// 请求数量 & lt; 最小的请求数量时不开启熔断</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>totalCount <span class="token operator">&lt;</span> minRequestAmount<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>    <span class="token keyword">double</span> curCount <span class="token operator">=</span> errCount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token comment">// 熔断策略为慢调用比例</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>strategy <span class="token operator">==</span> <span class="token constant">DEGRADE_GRADE_EXCEPTION_RATIO</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token comment">// Use errorRatio</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token comment">// 计算百分比</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        curCount <span class="token operator">=</span> errCount <span class="token operator">*</span> <span class="token number">1.0d</span> <span class="token operator">/</span> totalCount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 错误率或者错误数大于阈值时开启熔断</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">></span> threshold<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token function">transformToOpen</span><span class="token punctuation">(</span>curCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="sentinel源码分析-滑动时间窗口算法原理"><a class="anchor" href="#sentinel源码分析-滑动时间窗口算法原理">#</a> Sentinel 源码分析 - 滑动时间窗口算法原理</h1><p>在之前的学习中，我们已经学习完成了 Sentinel 源码的 Node 关系、责任链调用，那么这节课我们就要学习 Sentinel 核心源码中的一个非常重要的算法 “滑动时间窗口算法”</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222170933011.png" title="image-20211222170933011"><h2 id="时间窗算法"><a class="anchor" href="#时间窗算法">#</a> 时间窗算法</h2><p>那么在了解滑动时间窗算法之前，我们先要来了解时间窗算法，也可以称之为：固定时间窗算法</p><p>概念：固定时间窗口计数器算法思想：在固定的时间窗口内，可以允许固定数量的请求进入。超过数量就拒绝或者排队，等下一个时间段进入。</p><p>那我们来看图分析：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222174050592.png" title="image-20211222174050592"><p>具体分析一下：</p><ol><li>将当前的时间分为 10t 大小的几个时间窗</li><li>规则是阈值为 100 个请求数，每个时间窗里面的请求数量不能超过阈值 100</li><li>10t 到 16t 进入请求 10 个，16t 到 20t 进入请求 50 个，总数 60 个请求，没有超过阈值 100</li><li>20t 到 26t 进入请求 60 个，26t 到 30t 进入请求 20 个，总数 80 个请求，没有超过阈值 100</li><li>30t 到 40t 之间进入请求 120 个，超过阈值 20 个，所以 20 个请求无法进入</li></ol><p>存在问题：16t 到 26t 之间也是 10t 大小的一个时间窗，但是请求总数为 110，超过阈值，这种固定时间窗无法处理这部分超出的请求，解决办法就是使用滑动时间窗。</p><h2 id="滑动时间窗算法"><a class="anchor" href="#滑动时间窗算法">#</a> 滑动时间窗算法</h2><p>使用滑动时间窗的原因，就在于虽然以上提到超出阈值的部分分别在两个时间窗中，但是实际上我们要清楚，我们系统限流的目的是要在任意时间都要能应对突然的流量暴增，如果使用以上的算法，就会造成在 16t 和 26t 之间的请求无法限流，从而严重会导致服务雪崩。</p><p>要解决的话，我们就需要使用滑动时间窗算法，具体原理如下：</p><p>滑动时间窗限流算法解决了固定时间窗限流算法的问题。其没有划分固定的时间窗起点与终点，而是将每一次请求的到来时间点作为统计时间窗的终点，起点则是终点向前推时间窗长度的时间点。这种时间窗称为 “滑动时间窗”</p><p>看图分析：</p><p>此图中我们可以分析中，实际上当前的时间窗不再是固定的，而是可以从时间的起始位置一直向右滑动</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222190154070.png" title="image-20211222190154070"><p>这样的话就可以解决固定时间窗带来的问题，如图所示：</p><p>其原理就是：</p><ol><li>当前时间窗口为滑动窗口，可以从左向右按照时间顺序进行滑动，并且大小为 10t，同时此时的阈值为 100</li><li>红色线的位置进入一个请求，此时想要判断这个请求是否能够正常通过，就要看当前滑动窗口中的请求数量是否达到阈值，如果当前没有达到阈值 100，就可以正常通过，但是如果一旦超过阈值，就会被进行限流。</li></ol><p>没有超过阈值：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222191157347.png" title="image-20211222191157347"><p>超过阈值：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222191224880.png" title="image-20211222191224880"><p>但是此时滑动时间窗还是有问题的，问题就是会出现大量的重复统计，造成系统效率下降，如下图所示：</p><p>在此图中我们就可以看出，这个蓝色的区域就是重复统计的区域，也就是说每一次移动时间窗口，都需要重新统计重复区域的请求数量，从而导致浪费大量的系统资源。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222193546553.png" title="image-20211222193546553"><h2 id="滑动时间窗口算法-改进"><a class="anchor" href="#滑动时间窗口算法-改进">#</a> 滑动时间窗口算法 - 改进</h2><p>想要解决以上的问题，我们就需要更加细粒度话的计算，增加多个子时间窗口：样本窗口</p><p>概念：</p><ol><li>样本窗口的长度必须小于滑动窗口长度，如果等于滑动窗口长度就会变成固定时间窗口</li><li>一般滑动窗口长度是样本窗口的整数倍，比如：4 * 样本窗口 = 1 个滑动窗口</li><li>每个样本窗口在到达终点时间时，会统计本样本窗口中的流量数据并且记录下来。</li><li>当一个请求达到时，会统计当前请求时间点所在的样本窗口中的流量数据，然后在获取当前请求时间的样本窗口以外的同一个滑动窗口中的样本窗口的统计数据，进行求和，如果没有超出阈值，则通过，否则就会被限流。</li></ol><p>原理图：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222201207217.png" title="image-20211222201207217"><p>下一个进入请求的时间点</p><p>此时这个请求将不会被限流，因为本次请求的时间的对应的样本窗口只有 5 个请求加上之前重复的样本窗口统计的流量值，没有超过阈值 100，所以本次请求会通过。</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211222202102495.png" title="image-20211222202102495"><h1 id="sentinel源码分析-sentinel滑动时间窗口算法源码解析"><a class="anchor" href="#sentinel源码分析-sentinel滑动时间窗口算法源码解析">#</a> Sentinel 源码分析 - Sentinel 滑动时间窗口算法源码解析</h1><p>上节课我们分析了 Sentinel 的滑动时间窗口算法原理，那么这节课我们来研究一下源码中的具体实现</p><h2 id="整体流程图"><a class="anchor" href="#整体流程图">#</a> 整体流程图</h2><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0.png" title="滑动时间窗算法实现"><h2 id="源码分析"><a class="anchor" href="#源码分析">#</a> 源码分析</h2><p>那我们就按照这个流程图来从头分析</p><p>首先看 StatisticSlot.entry 方法中 node.addPassRequest (count) 方法，这里我之前就提到过用到了滑动窗口算法，那我们来具体分析</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 增加通过请求的数量 (这里涉及到滑动窗口算法)</span></pre></td></tr><tr><td data-num="2"></td><td><pre>node<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>进入方法 DefaultNode.addPassRequest</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>clusterNode<span class="token punctuation">.</span><span class="token function">addPassRequest</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>继续向下跟踪</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPassRequest</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 为滑动计数器增加本次的访问数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    rollingCounterInMinute<span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后进入 ArrayMetric.addPass，这是一个使用数组保存数据的计量器类</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPass</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取当前时间点所在的样本窗口</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> wrap <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 将当前请求的计数量添加到当前样本窗口的统计数据中</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    wrap<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>先来跟踪 data.currentWindow ();</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 获取当前时间所在的样本窗口</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里就会进入 LeapArray（环形数组）中的 currentWindow 方法中，这个环形数组，其实就是 Sentinel 官方提供的原理图中的环形数组 WindowLeapArray</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223172002547.png" title="image-20211223172002547"><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 环形数组</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">LeapArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 样本窗口长度</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">int</span> windowLengthInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 一个时间窗中包含的时间窗数量</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">int</span> sampleCount<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 时间窗长度</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">int</span> intervalInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">double</span> intervalInSecond<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre> </pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 这个一个数组，元素为 WindowWrap 样本窗口</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 注意，这里的泛型 T 实际为 MetricBucket 类型</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">AtomicReferenceArray</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WindowWrap</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span><span class="token punctuation">></span></span> array<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   </pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里要注意这个数组，这个数组里面所存放的类型就是 WindowWrap 窗口类型，泛型 T 是 MetricBucket 这里我们来看一下这个类型</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">WindowWrap</span><span class="token punctuation">(</span><span class="token keyword">long</span> windowLengthInMs<span class="token punctuation">,</span> <span class="token keyword">long</span> windowStart<span class="token punctuation">,</span> <span class="token class-name">T</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 样本窗口长度</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>windowLengthInMs <span class="token operator">=</span> windowLengthInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 样本窗口的起始时间戳</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>windowStart <span class="token operator">=</span> windowStart<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 当前样本窗口的统计数据 其类型为 MetricBucket</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//..LeapArray</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取当前时间所在的样本窗口</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">//------------------------------------------------------------</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 计算当前时间所在的样本窗口 id，即在计算数组 LeapArray 中的索引</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">calculateTimeIdx</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// Calculate current bucket start time.</span></pre></td></tr><tr><td data-num="14"></td><td><pre>     	<span class="token comment">// 计算当前样本窗口的开始时间点</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">long</span> windowStart <span class="token operator">=</span> <span class="token function">calculateWindowStart</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="17"></td><td><pre> <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在这里我们先分析 calculateTimeIdx 方法</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">calculateTimeIdx</span><span class="token punctuation">(</span><span class="token comment">/*@Valid*/</span> <span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 计算当前时间在那个样本窗口（样本窗口下标），当前时间 / 样本窗口长度</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">long</span> timeId <span class="token operator">=</span> timeMillis <span class="token operator">/</span> windowLengthInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// Calculate current index so we can map the timestamp to the leap array.</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 计算具体索引，这个 array 就是装样本窗口的数组</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>timeId <span class="token operator">%</span> array<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>timeId（样本窗口下标）原理如下：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223202827754.png" title="image-20211223202827754"><p>具体索引原理：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223204246750.png" title="image-20211223204246750"><p>这里分析完成我们接着分析这里，计算当前样本窗口的起点</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 计算当前样本窗口的开始时间点</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">long</span> windowStart <span class="token operator">=</span> <span class="token function">calculateWindowStart</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//------------------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">protected</span> <span class="token keyword">long</span> <span class="token function">calculateWindowStart</span><span class="token punctuation">(</span><span class="token comment">/*@Valid*/</span> <span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 计算当前样本窗口的起点 当前时间点 -（当前时间点 % 样本窗口长度）</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> timeMillis <span class="token operator">-</span> timeMillis <span class="token operator">%</span> windowLengthInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>原理如下：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223205936680.png" title="image-20211223205936680"><p>这里分析完成之后我们继续向下分析</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 获取到当前时间所在的样本窗口</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> old <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 如果获取不到，表示没有创建</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>old <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="7"></td><td><pre>                 *     B0       B1      B2    NULL      B4</pre></td></tr><tr><td data-num="8"></td><td><pre>                 * ||_______|_______|_______|_______|_______||___</pre></td></tr><tr><td data-num="9"></td><td><pre>                 * 200     400     600     800     1000    1200  timestamp</pre></td></tr><tr><td data-num="10"></td><td><pre>                 *                             ^</pre></td></tr><tr><td data-num="11"></td><td><pre>                 *                          time=888</pre></td></tr><tr><td data-num="12"></td><td><pre>                 *            bucket is empty, so create new and update</pre></td></tr><tr><td data-num="13"></td><td><pre>                 *</pre></td></tr><tr><td data-num="14"></td><td><pre>                 * If the old bucket is absent, then we create a new bucket at &#123;@code windowStart&#125;,</pre></td></tr><tr><td data-num="15"></td><td><pre>                 * then try to update circular array via a CAS operation. Only one thread can</pre></td></tr><tr><td data-num="16"></td><td><pre>                 * succeed to update, while other threads yield its time slice.</pre></td></tr><tr><td data-num="17"></td><td><pre>                 */</pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 创建新的时间窗口</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> window <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>windowLengthInMs<span class="token punctuation">,</span> windowStart<span class="token punctuation">,</span> <span class="token function">newEmptyBucket</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 通过 CAS 方式将新建窗口放入 Array</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> window<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token comment">// Successfully updated, return the created bucket.</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token keyword">return</span> window<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// Contention failed, the thread will yield its time slice to wait for bucket available.</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 若当前样本窗口的起始时间点与计算出的样本窗口起始点相同，则说明两个是同一个样本窗口</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">==</span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                 *     B0       B1      B2     B3      B4</pre></td></tr><tr><td data-num="32"></td><td><pre>                 * ||_______|_______|_______|_______|_______||___</pre></td></tr><tr><td data-num="33"></td><td><pre>                 * 200     400     600     800     1000    1200  timestamp</pre></td></tr><tr><td data-num="34"></td><td><pre>                 *                             ^</pre></td></tr><tr><td data-num="35"></td><td><pre>                 *                          time=888</pre></td></tr><tr><td data-num="36"></td><td><pre>                 *            startTime of Bucket 3: 800, so it's up-to-date</pre></td></tr><tr><td data-num="37"></td><td><pre>                 *</pre></td></tr><tr><td data-num="38"></td><td><pre>                 * If current &#123;@code windowStart&#125; is equal to the start timestamp of old bucket,</pre></td></tr><tr><td data-num="39"></td><td><pre>                 * that means the time is within the bucket, so directly return the bucket.</pre></td></tr><tr><td data-num="40"></td><td><pre>                 */</pre></td></tr><tr><td data-num="41"></td><td><pre>        <span class="token keyword">return</span> old<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>        <span class="token comment">// 若当前样本窗口的起始时间点 大于 计算出的样本窗口起始时间点，说明计算出的样本窗口已经过时了，</span></pre></td></tr><tr><td data-num="43"></td><td><pre>        <span class="token comment">// 需要将原来的样本窗口替换</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">></span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                 *   (old)</pre></td></tr><tr><td data-num="47"></td><td><pre>                 *             B0       B1      B2    NULL      B4</pre></td></tr><tr><td data-num="48"></td><td><pre>                 * |_______||_______|_______|_______|_______|_______||___</pre></td></tr><tr><td data-num="49"></td><td><pre>                 * ...    1200     1400    1600    1800    2000    2200  timestamp</pre></td></tr><tr><td data-num="50"></td><td><pre>                 *                              ^</pre></td></tr><tr><td data-num="51"></td><td><pre>                 *                           time=1676</pre></td></tr><tr><td data-num="52"></td><td><pre>                 *          startTime of Bucket 2: 400, deprecated, should be reset</pre></td></tr><tr><td data-num="53"></td><td><pre>                 *</pre></td></tr><tr><td data-num="54"></td><td><pre>                 * If the start timestamp of old bucket is behind provided time, that means</pre></td></tr><tr><td data-num="55"></td><td><pre>                 * the bucket is deprecated. We have to reset the bucket to current &#123;@code windowStart&#125;.</pre></td></tr><tr><td data-num="56"></td><td><pre>                 * Note that the reset and clean-up operations are hard to be atomic,</pre></td></tr><tr><td data-num="57"></td><td><pre>                 * so we need a update lock to guarantee the correctness of bucket update.</pre></td></tr><tr><td data-num="58"></td><td><pre>                 *</pre></td></tr><tr><td data-num="59"></td><td><pre>                 * The update lock is conditional (tiny scope) and will take effect only when</pre></td></tr><tr><td data-num="60"></td><td><pre>                 * bucket is deprecated, so in most cases it won't lead to performance loss.</pre></td></tr><tr><td data-num="61"></td><td><pre>                 */</pre></td></tr><tr><td data-num="62"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>updateLock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>                <span class="token comment">// Successfully get the update lock, now we reset the bucket.</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                <span class="token comment">// 替换掉老的样本窗口</span></pre></td></tr><tr><td data-num="66"></td><td><pre>                <span class="token keyword">return</span> <span class="token function">resetWindowTo</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> windowStart<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>                updateLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>            <span class="token comment">// Contention failed, the thread will yield its time slice to wait for bucket available.</span></pre></td></tr><tr><td data-num="72"></td><td><pre>            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>        <span class="token comment">// 当前样本窗口的起始时间点 小于 计算出的样本窗口起始时间点，</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token comment">// 这种情况一般不会出现，因为时间不会倒流。除非人为修改了系统时钟</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>windowStart <span class="token operator">&lt;</span> old<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token comment">// Should not go through here, as the provided time is already behind.</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>windowLengthInMs<span class="token punctuation">,</span> windowStart<span class="token punctuation">,</span> <span class="token function">newEmptyBucket</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里的原理如下：</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223213543463.png" title="image-20211223213543463"><p>具体是如何替换的拿，我们来看源码</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 替换掉老的样本窗口</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">return</span> <span class="token function">resetWindowTo</span><span class="token punctuation">(</span>old<span class="token punctuation">,</span> windowStart<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">//------------------------------------------------------------</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// BucketLeapArray.resetWindowTo</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">protected</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> <span class="token function">resetWindowTo</span><span class="token punctuation">(</span><span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> w<span class="token punctuation">,</span> <span class="token keyword">long</span> startTime<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// Update the start time and reset value.</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 更新窗口起始时间</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    w<span class="token punctuation">.</span><span class="token function">resetTo</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">// 将多维度统计数据清零</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    w<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> w<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>更新数据分析</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">MetricBucket</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 将每个维度的统计数据清零</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetricEvent</span> event <span class="token operator">:</span> <span class="token class-name">MetricEvent</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        counters<span class="token punctuation">[</span>event<span class="token punctuation">.</span><span class="token function">ordinal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token function">initMinRt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>最后我们再来看一下具体是那个维度，其实是通过维度</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPass</span><span class="token punctuation">(</span><span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取当前时间点所在的样本窗口</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> wrap <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 将当前请求的计数量添加到当前样本窗口的统计数据中</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    wrap<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPass</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment">//----------------------------------------</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPass</span><span class="token punctuation">(</span><span class="token keyword">int</span> n<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">MetricEvent</span><span class="token punctuation">.</span><span class="token constant">PASS</span><span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211223221413399.png" title="image-20211223221413399"><h1 id="sentinel-源码分析-滑动窗口数据统计解析"><a class="anchor" href="#sentinel-源码分析-滑动窗口数据统计解析">#</a> Sentinel 源码分析 - 滑动窗口数据统计解析</h1><h2 id="源码结构图"><a class="anchor" href="#源码结构图">#</a> 源码结构图</h2><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1.png" title="滑动窗口数据统计"><h2 id="分析源码"><a class="anchor" href="#分析源码">#</a> 分析源码</h2><p>上节课我们通过分析源码已经知道了滑动窗口算法在 Sentinel 中的应用，那么这节课我们来研究一些其中的数据统计，首先入口我们就从限流的 Slot：FlowSlot 的 entry 方法入手：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">entry</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ResourceWrapper</span> resourceWrapper<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="3"></td><td><pre>                  <span class="token keyword">boolean</span> prioritized<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 检测并且应用流控规则</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token function">checkFlow</span><span class="token punctuation">(</span>resourceWrapper<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 触发下一个 Slot</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token function">fireEntry</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> resourceWrapper<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">void</span> <span class="token function">checkFlow</span><span class="token punctuation">(</span><span class="token class-name">ResourceWrapper</span> resource<span class="token punctuation">,</span> <span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">DefaultNode</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">throws</span> <span class="token class-name">BlockException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">// 从这里进入</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    checker<span class="token punctuation">.</span><span class="token function">checkFlow</span><span class="token punctuation">(</span>ruleProvider<span class="token punctuation">,</span> resource<span class="token punctuation">,</span> context<span class="token punctuation">,</span> node<span class="token punctuation">,</span> count<span class="token punctuation">,</span> prioritized<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>checkFlow 方法里面找到遍历所有规则的 canPassCheck 方法然后在进入 canPass 方法，找到 DefaultController 对应实现，快速失败的流控效果，我们从这里来看，这里我们要关注的是 avgUsedTokens 方法，这个方法实际上就是获取当前时间窗里面的已经统计的数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">canPass</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">,</span> <span class="token keyword">int</span> acquireCount<span class="token punctuation">,</span> <span class="token keyword">boolean</span> prioritized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 获取当前 node 节点的线程数或者请求通过的 qps 总数</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 获取当前时间窗已经统计的数据</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">int</span> curCount <span class="token operator">=</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 当前请求数（请求的令牌）+ 申请总数是否（已经消耗的令牌）> 该资源配置的总数（阈值）</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 以前的数据 + 新的数据</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>curCount <span class="token operator">+</span> acquireCount <span class="token operator">></span> count<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>prioritized <span class="token operator">&amp;&amp;</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_QPS</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token keyword">long</span> currentTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">long</span> waitInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            currentTime <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            waitInMs <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">tryOccupyNext</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">,</span> acquireCount<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitInMs <span class="token operator">&lt;</span> <span class="token class-name">OccupyTimeoutProperty</span><span class="token punctuation">.</span><span class="token function">getOccupyTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                node<span class="token punctuation">.</span><span class="token function">addWaitingRequest</span><span class="token punctuation">(</span>currentTime <span class="token operator">+</span> waitInMs<span class="token punctuation">,</span> acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                node<span class="token punctuation">.</span><span class="token function">addOccupiedPass</span><span class="token punctuation">(</span>acquireCount<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token function">sleep</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token comment">// PriorityWaitException indicates that the request will pass after waiting for &#123;@link @waitInMs&#125;.</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">PriorityWaitException</span><span class="token punctuation">(</span>waitInMs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>所以这里我们跟进一下，看如何获取已经统计的数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">avgUsedTokens</span><span class="token punctuation">(</span><span class="token class-name">Node</span> node<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 如果没有选出 node，代表没有做统计工作，直接返回 0</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        <span class="token keyword">return</span> <span class="token constant">DEFAULT_AVG_USED_TOKENS</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 判断阈值类型，如果为 QPS，则返回当前统计的 QPS</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 如果为线程数，则返回当前的线程数总量</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">return</span> grade <span class="token operator">==</span> <span class="token class-name">RuleConstant</span><span class="token punctuation">.</span><span class="token constant">FLOW_GRADE_THREAD</span> <span class="token operator">?</span> node<span class="token punctuation">.</span><span class="token function">curThreadNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这里实际上就是判断阈值类型，我们这里看 QPS 类型的统计</p><img data-src="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/image-20211227174205035.png" title="image-20211227174205035"><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">passQps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">//rollingCounterInSecond.pass () 当前时间窗中统计的通过请求数量</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">//rollingCounterInSecond.getWindowIntervalInSec () 时间窗口长度</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">// 这两个数相除，计算出的就是 QPS</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">return</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> rollingCounterInSecond<span class="token punctuation">.</span><span class="token function">getWindowIntervalInSec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么这里就需要查看 pass 方法，看是如何统计通过请求总量的</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 更新 array 中当前时间点所在样本窗口实例中的数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    data<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">long</span> pass <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 将当前时间窗口中的所有样本窗口统计的 value 读取出来，并且记录</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetricBucket</span> window <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        pass <span class="token operator">+=</span> window<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> pass<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么这里我们先跟踪 values ()，其实这里就是拿出没有过时有效的样本窗口数据</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token class-name">TimeUtil</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment">// ----------------------------</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeMillis<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeMillis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">int</span> size <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 这个遍历 array 中的每一个样本窗口实例</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> windowWrap <span class="token operator">=</span> array<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 若当前遍历实例为空或者已经过时，则继续下一个</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>windowWrap <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isWindowDeprecated</span><span class="token punctuation">(</span>timeMillis<span class="token punctuation">,</span> windowWrap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">continue</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>windowWrap<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>判断位置过时判断逻辑：</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isWindowDeprecated</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">WindowWrap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> windowWrap<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 当前时间 - 样本窗口起始时间 > 时间窗口  说明过时了</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">return</span> time <span class="token operator">-</span> windowWrap<span class="token punctuation">.</span><span class="token function">windowStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> intervalInMs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>那么这里分析完成以后我们再回到 ArrayMetric 中的 pass 方法中，看遍历方法，就是将所有的有效并且是通过维度的数据统计出来进行求和，看是否超过阈值。</p><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 更新 array 中当前时间点所在样本窗口实例中的数据</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    data<span class="token punctuation">.</span><span class="token function">currentWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">long</span> pass <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 将当前时间窗口中的所有样本窗口统计的 value 读取出来，并且记录</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MetricBucket</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>	</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 将 List 中所有 pass 维度的统计数据并取出求和</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MetricBucket</span> window <span class="token operator">:</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 通过维度</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        pass <span class="token operator">+=</span> window<span class="token punctuation">.</span><span class="token function">pass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> pass<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><div id="gitalk-container"></div><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script>var gitalkConfig={clientID:"6db178ba46c8af8f6a6f",clientSecret:"90f730e5956024596558df00975cd8eae28cae3d",repo:"bk-comment01",owner:"onlymarryu",admin:["onlymarryu"],distractionFreeMode:!1,language:"zh-CN",proxy:"https://gitalk-comments.netlify.app/github_access_token",perPage:15};gitalkConfig.id=md5(location.pathname);var gitalk=new Gitalk(gitalkConfig);gitalk.render("gitalk-container")</script><div class="tags"><a href="/tags/spring-cloud-alibaba/" rel="tag"><i class="ic i-tag"></i> spring-cloud-alibaba</a> <a href="/tags/sentinel/" rel="tag"><i class="ic i-tag"></i> sentinel</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-07-10 22:00:31" itemprop="dateModified" datetime="2023-07-10T22:00:31+08:00">2023-07-10</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="雾都 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="雾都 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="雾都 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>雾都 <i class="ic i-at"><em>@</em></i>每天进步一点点，就是成功的开始</li><li class="link"><strong>本文链接：</strong> <a href="https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" title="Sentinel 源码系统学习">https://eth168.top/Spring_Family/spring-cloud-alibaba/Sentinel源码系统学习/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;api.yimian.xyz&#x2F;img?724184" title="Sentinel系统学习"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务</span><h3>Sentinel系统学习</h3></a></div><div class="item right"><a href="/Spring_Family/spring-cloud-alibaba/Gateway%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;api.yimian.xyz&#x2F;img?116489" title="Gateway系统学习"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 微服务</span><h3>Gateway系统学习</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%A0%B8%E5%BF%83%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E8%AF%BE%E7%A8%8B%E5%BC%80%E7%AF%87"><span class="toc-number">1.</span> <span class="toc-text">Sentinel 核心源码分析 - 课程开篇</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">Sentinel 工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E"><span class="toc-number">1.2.</span> <span class="toc-text">官方版本说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E4%B8%8B%E8%BD%BD"><span class="toc-number">1.3.</span> <span class="toc-text">Sentinel 源码下载</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%A0%B8%E5%BF%83%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">Sentinel 核心概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">2.2.</span> <span class="toc-text">官方案例演示</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-node%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">3.</span> <span class="toc-text">Sentinel 源码解析 - Node 之间的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#node-%E5%85%B3%E7%B3%BB%E5%AE%98%E6%96%B9%E5%9B%BE%E8%A7%A3"><span class="toc-number">3.1.</span> <span class="toc-text">Node 关系官方图解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#node%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">3.2.</span> <span class="toc-text">Node 之间的关系</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BB%A3%E7%A0%81%E6%94%B9%E8%BF%9B"><span class="toc-number">3.3.</span> <span class="toc-text">案例代码改进</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E6%BA%90%E7%A0%81%E5%85%A5%E5%8F%A3"><span class="toc-number">4.</span> <span class="toc-text">Sentinel 源码解析 - 源码入口</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E5%85%A5%E5%8F%A3"><span class="toc-number">4.1.</span> <span class="toc-text">分析入口</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E6%9E%84%E5%BB%BAcontext"><span class="toc-number">5.</span> <span class="toc-text">Sentinel 源码解析 - 构建 Context</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-slotchain%E5%85%A5%E5%8F%A3%E8%A7%A3%E6%9E%90"><span class="toc-number">6.</span> <span class="toc-text">Sentinel 源码解析 - SlotChain 入口解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4chain%E8%A7%A3%E6%9E%90"><span class="toc-number">6.1.</span> <span class="toc-text">默认 Chain 解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nodeselectorslot%E8%A7%A3%E6%9E%90"><span class="toc-number">6.2.</span> <span class="toc-text">NodeSelectorSlot 解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-clusterbuilderslot%E8%A7%A3%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">Sentinel 源码解析 - ClusterBuilderSlot 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%98%E6%96%B9%E5%AE%9A%E4%B9%89"><span class="toc-number">7.1.</span> <span class="toc-text">官方定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#clusterbuilderslot"><span class="toc-number">7.2.</span> <span class="toc-text">ClusterBuilderSlot</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">7.3.</span> <span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-slot%E5%88%86%E6%9E%90%E5%90%8E%E7%BB%AD1"><span class="toc-number">8.</span> <span class="toc-text">Sentinel 源码解析 - Slot 分析后续 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#statisticslot%E5%AE%9A%E4%B9%89"><span class="toc-number">8.1.</span> <span class="toc-text">StatisticSlot 定义：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%BA%90%E7%A0%81%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="toc-number">8.2.</span> <span class="toc-text">分析源码核心方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flowslot%E5%AE%9A%E4%B9%89"><span class="toc-number">8.3.</span> <span class="toc-text">FlowSlot 定义：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%A0%B8%E5%BF%83%E6%96%B9%E6%B3%95"><span class="toc-number">8.4.</span> <span class="toc-text">分析核心方法</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-slot%E5%88%86%E6%9E%90%E5%90%8E%E7%BB%AD2"><span class="toc-number">9.</span> <span class="toc-text">Sentinel 源码解析 - Slot 分析后续 2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flowslot%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99"><span class="toc-number">9.1.</span> <span class="toc-text">FlowSlot 获取全部流控规则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C%E5%AF%B9%E5%BA%94%E7%9A%84controller"><span class="toc-number">9.2.</span> <span class="toc-text">流控效果对应的 Controller</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">9.3.</span> <span class="toc-text">流程总结</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E7%86%94%E6%96%AD%E9%99%8D%E7%BA%A7degradeslot%E8%A7%A3%E6%9E%90"><span class="toc-number">10.</span> <span class="toc-text">Sentinel 源码解析 - 熔断降级 DegradeSlot 解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#circuitbreaker%E7%86%94%E6%96%AD%E5%99%A8"><span class="toc-number">10.1.</span> <span class="toc-text">CircuitBreaker 熔断器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E7%AD%96%E7%95%A5"><span class="toc-number">10.2.</span> <span class="toc-text">熔断策略</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">11.</span> <span class="toc-text">Sentinel 源码分析 - 滑动时间窗口算法原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E7%AA%97%E7%AE%97%E6%B3%95"><span class="toc-number">11.1.</span> <span class="toc-text">时间窗算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E7%AE%97%E6%B3%95"><span class="toc-number">11.2.</span> <span class="toc-text">滑动时间窗算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3%E7%AE%97%E6%B3%95-%E6%94%B9%E8%BF%9B"><span class="toc-number">11.3.</span> <span class="toc-text">滑动时间窗口算法 - 改进</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-sentinel%E6%BB%91%E5%8A%A8%E6%97%B6%E9%97%B4%E7%AA%97%E5%8F%A3%E7%AE%97%E6%B3%95%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90"><span class="toc-number">12.</span> <span class="toc-text">Sentinel 源码分析 - Sentinel 滑动时间窗口算法源码解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">12.1.</span> <span class="toc-text">整体流程图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">12.2.</span> <span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sentinel-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%BB%91%E5%8A%A8%E7%AA%97%E5%8F%A3%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E8%A7%A3%E6%9E%90"><span class="toc-number">13.</span> <span class="toc-text">Sentinel 源码分析 - 滑动窗口数据统计解析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="toc-number">13.1.</span> <span class="toc-text">源码结构图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%BA%90%E7%A0%81"><span class="toc-number">13.2.</span> <span class="toc-text">分析源码</span></a></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/Spring_Family/spring-cloud-alibaba/Nacos%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Nacos系统学习">Nacos系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Sentinel系统学习">Sentinel系统学习</a></li><li class="active"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E6%BA%90%E7%A0%81%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Sentinel源码系统学习">Sentinel源码系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Gateway%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Gateway系统学习">Gateway系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Seata%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="bookmark" title="Seata系统学习">Seata系统学习</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Problem/%E5%85%B3%E4%BA%8E%E5%85%B3%E4%BA%8ENacos%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83%E7%9A%84%E9%85%8D%E7%BD%AE/" rel="bookmark" title="关于关于Nacos配置中心的配置">关于关于Nacos配置中心的配置</a></li><li><a href="/Spring_Family/spring-cloud-alibaba/Problem/%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8A%A0%E8%BD%BD%E9%85%8D%E7%BD%AE%E9%A1%BA%E5%BA%8F/" rel="bookmark" title="微服务加载配置顺序">微服务加载配置顺序</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="雾都" data-src="/images/avatar.jpg"><p class="name" itemprop="name">雾都</p><div class="description" itemprop="description">花非花，雾非雾</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">85</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">16</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">30</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL29ubHltYXJyeXU=" title="https:&#x2F;&#x2F;github.com&#x2F;onlymarryu"><i class="ic i-github"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9ydXJpc216aw==" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;rurismzk"><i class="ic i-zhihu"></i></span> <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvbXkvbS9tdXNpYy9wbGF5bGlzdD9pZD0zMTY2MDYwNzkw" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;my&#x2F;m&#x2F;music&#x2F;playlist?id&#x3D;3166060790"><i class="ic i-cloud-music"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20vYW1laGltZQ==" title="https:&#x2F;&#x2F;weibo.com&#x2F;amehime"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>时间轴</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li><li class="item"><a href="/toolPage/" rel="section"><i class="ic i-feather"></i>常用工具设置技巧</a></li><li class="item"><a href="/projectBuild/" rel="section"><i class="ic i-th"></i>SpringBoot常用配置</a></li></ul></li><li class="item"><a href="/mianshi/" rel="section"><i class="ic i-calendar"></i>面试</a></li><li class="item"><a href="/study/" rel="section"><i class="ic i-sakura"></i>小实验</a></li><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友链</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-calendar"></i>留言</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/Spring_Family/spring-cloud-alibaba/Sentinel%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/Spring_Family/spring-cloud-alibaba/Gateway%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>随机文章</h2><ul><li class="item"><div class="breadcrumb"><a href="/categories/ORM/" title="分类于 ORM">ORM</a></div><span><a href="/ORM/Mybatis/" title="Mybatis">Mybatis</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B0%8F%E5%AE%9E%E9%AA%8C/" title="分类于 小实验">小实验</a></div><span><a href="/study/develop/eu.org/" title="获取免费域名">获取免费域名</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/Maven-tool/" title="Maven-tool">Maven-tool</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/HDFS-tool/" title="HDFS安装">HDFS安装</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E9%9D%A2%E8%AF%95/" title="分类于 面试">面试</a></div><span><a href="/interview/JavaSE%E2%80%94%E5%A4%9A%E7%BA%BF%E7%A8%8B/" title="多线程">多线程</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B0%8F%E5%AE%9E%E9%AA%8C/" title="分类于 小实验">小实验</a></div><span><a href="/study/Collect/Resource/" title="日常搜集到的资源网站">日常搜集到的资源网站</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/Spring%E5%85%A8%E5%AE%B6%E6%A1%B6/" title="分类于 Spring 全家桶">Spring 全家桶</a></div><span><a href="/Spring_Family/SpringBoot/" title="SpringBoot">SpringBoot</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%89%8D%E7%AB%AF/" title="分类于 前端">前端</a> <i class="ic i-angle-right"></i> <a href="/categories/%E5%89%8D%E7%AB%AF/%E6%A1%86%E6%9E%B6/" title="分类于 框架">框架</a></div><span><a href="/Web-anteriore/Vue2-3/vue3%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/" title="Vue3">Vue3</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/Nginx-tool/" title="Nginx">Nginx</a></span></li><li class="item"><div class="breadcrumb"><a href="/categories/%E5%B7%A5%E5%85%B7%E8%BD%AF%E4%BB%B6%E5%AE%89%E8%A3%85/" title="分类于 工具软件安装">工具软件安装</a></div><span><a href="/tools/MobaXterm/" title="mobaxerm">mobaxerm</a></span></li></ul></div><div><h2>最新评论</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">雾都 @ 雾都博客</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">1.5m 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">22:43</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"Spring_Family/spring-cloud-alibaba/Sentinel源码系统学习/",favicon:{show:"（●´3｀●）やれやれだぜ",hide:"(´Д｀)大変だ！"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(i){return i.includes("#")},function(i){return new RegExp(LOCAL.path+"$").test(i)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>